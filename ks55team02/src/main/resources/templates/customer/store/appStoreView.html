<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org/"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{customer/layout/layoutMain}">
<head>
    <title>스토어 신청</title>
    <!-- CSS 파일 링크 -->
    <link rel="stylesheet" th:href="@{/maincss/assets/customcustomercss/appStoreView.css}">
    <!-- ✅ SweetAlert2 라이브러리 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
<th:block layout:fragment="contents">
    <main class="main">
        <div class="container">
            <div class="page-header text-center" style="background-image: url('/assets/images/page-header-bg.jpg')">
                <div class="container"><h1 class="page-title">스토어 신청<span>Store Application</span></h1></div>
            </div>
            <nav aria-label="breadcrumb" class="breadcrumb-nav">
                <div class="container"><ol class="breadcrumb"><li class="breadcrumb-item"><a th:href="@{/}">Home</a></li><li class="breadcrumb-item"><a th:href="@{/customer/mypage}">My page</a></li><li class="breadcrumb-item active" aria-current="page">Store Application</li></ol></div>
            </nav>

            <div class="row justify-content-center mt-3 mb-5">
                <div class="col-lg-10">
                   <ul class="nav nav-pills wizard-nav" id="v-pills-tab" role="tablist">
                       <li class="nav-item flex-fill" role="presentation"><a class="nav-link text-center active" id="step1-tab" data-bs-toggle="pill" href="#step1" role="tab" aria-controls="step1" aria-selected="true"><span class="step-indicator">1</span>신청자 정보</a></li>
                       <li class="nav-item flex-fill" role="presentation"><a class="nav-link text-center" id="step2-tab" data-bs-toggle="pill" href="#step2" role="tab" aria-controls="step2" aria-selected="false"><span class="step-indicator">2</span>스토어 정보</a></li>
                       <li class="nav-item flex-fill" role="presentation"><a class="nav-link text-center" id="step3-tab" data-bs-toggle="pill" href="#step3" role="tab" aria-controls="step3" aria-selected="false"><span class="step-indicator">3</span>스토어 정보2</a></li>
                       <li class="nav-item flex-fill" role="presentation"><a class="nav-link text-center" id="step4-tab" data-bs-toggle="pill" href="#step4" role="tab" aria-controls="step4" aria-selected="false"><span class="step-indicator">4</span>서류 제출</a></li>
                   </ul>

<div class="tab-content" id="v-pills-tabContent">
    <!-- Step 1: 신청자 정보 -->
    <div class="tab-pane fade show active" id="step1" role="tabpanel" aria-labelledby="step1-tab">
        <div class="card card-body p-4 p-md-5">
            <h5 class="form-section-title">신청자 기본 정보</h5>
            <div class="row">
                <div class="col-md-6 mb-3"><label>신청자 ID</label><div class="user-info" th:text="${userInfo.userLgnId}" id="applicantIdDisplay"></div></div>
                <div class="col-md-6 mb-3"><label>신청자 이름</label><div class="user-info" th:text="${userInfo.userNm}" id="applicantNameDisplay"></div></div>
                <div class="col-md-6 mb-3"><label>신청자 연락처</label><div class="user-info" th:text="${userInfo.telno}" id="applicantTelDisplay"></div></div>
            </div>
            <h5 class="form-section-title mt-4">정산 계좌 정보</h5>
            <div class="row">
                <div class="col-md-4 mb-3">
                   <label for="dpstrNm">예금주 <span class="text-danger">*</span></label>
                   <input type="text" class="form-control" id="dpstrNm" name="dpstrNm" placeholder="예금주를 입력해주세요"required>
                   <div class="invalid-feedback"></div>
               </div>
               <div class="col-md-3 mb-3">
                   <label for="bankNm">은행명 <span class="text-danger">*</span></label>
                   <select class="form-select" id="bankNm" name="bankNm" required>
                       <option value="" selected disabled>은행 선택</option>
                       <option value="KB국민은행">KB국민은행</option>
                       <option value="신한은행">신한은행</option>
                       <option value="우리은행">우리은행</option>
                       <option value="하나은행">하나은행</option>
                       <option value="IBK기업은행">IBK기업은행</option>
                       <option value="NH농협은행">NH농협은행</option>
                       <option value="SC제일은행">SC제일은행</option>
                       <option value="씨티은행 ">씨티은행 </option>
                       <option value="카카오뱅크">카카오뱅크</option>
                       <option value="케이뱅크">케이뱅크</option>
                       <option value="토스뱅크">토스뱅크</option>
                       
                   </select>
                   <div class="invalid-feedback"></div>
               </div>
                <div class="col-md-5 mb-3">
                    <label for="actno">계좌번호 <span class="text-danger">*</span> ('-' 없이 숫자만 입력)</label>
                    <input type="text" class="form-control" id="actno" name="actno" required pattern="[0-9]{10,16}" title="10~16자리의 숫자만 입력해주세요." placeholder="10~16자리의 숫자만 입력해주세요." maxlength="16">
                    <div class="invalid-feedback"></div>
                </div>
            </div>
            <div class="button-wrapper"><span></span><button type="button" class="btn btn-outline-primary next-step">다음</button></div>
        </div>
    </div>

    <!-- Step 2: 스토어 정보 -->
    <div class="tab-pane fade" id="step2" role="tabpanel" aria-labelledby="step2-tab">
         <div class="card card-body p-4 p-md-5">
            <h5 class="form-section-title">스토어 기본 정보</h5>
            <div class="row">
                <div class="col-md-6 mb-3"><label for="storeNameInput">스토어 명 <span class="text-danger">*</span></label><input type="text" class="form-control" id="storeNameInput" name="storeNm" placeholder="상점명을 입력하세요" required><div class="invalid-feedback"></div></div>
                <div class="col-md-6 mb-3"><label>수수료 정책</label><div class="user-info" id="commissionRateDisplay">일반 판매자 수수료 (18%)</div><div class="d-none" id="commissionRateCn">plcy_1</div></div>
                <div class="col-md-12 mb-3"><label for="storeIntroTextarea">스토어 소개 <span class="text-danger">*</span></label><textarea class="form-control" rows="4" placeholder="고객에게 보여질 스토어 소개를 입력해주세요." id="storeIntroTextarea" name="storeIntroCn" required></textarea><div class="invalid-feedback"></div></div>
            </div>
            <h5 class="form-section-title mt-4">담당자 정보</h5>
            <div class="row">
                <div class="col-6 mb-3">
                    <label for="managerNameInput" >매니저 명 <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="managerNameInput" name="mngrNm" placeholder="매니저 이름을 입력하세요" required>
                    <div class="invalid-feedback"></div>
                </div>
            </div>
           <div class="row">
            <div class="col-md-6 mb-3">
                <label class = "mng">매니저 연락처 <span class="text-danger">*</span></label>
                <div class="input-group-split">
                    <select class="form-select" id="managerTel1" style="flex: 0 0 90px;"><option>010</option><option>011</option></select>
                    <span class="input-divider">-</span>
                    <input type="text" class="form-control" id="managerTel2" maxlength="4" pattern="[0-9]*">
                    <span class="input-divider">-</span>
                    <input type="text" class="form-control" id="managerTel3" maxlength="4" pattern="[0-9]*">
                </div>
                <input type="hidden" id="managerTelInput" name="mngrTelNo" required>
                <div class="invalid-feedback"></div>
            </div>
            <div class="col-md-6 mb-3">
                <label class = "mng">매니저 이메일 <span class="text-danger">*</span></label>
                <div class="input-group-split">
                    <input type="text" class="form-control" id="emailId" style="flex: 3;">
                    <span class="input-divider">@</span>
                    <input type="text" class="form-control" id="emailDomain" style="flex: 4;">
                    <select class="form-select" id="emailDomainSelector" style="flex: 3;"><option value="">직접입력</option><option value="naver.com">naver.com</option><option value="gmail.com">gmail.com</option><option value="daum.net">daum.net</option><option value="nate.com">nate.com</option></select>

                </div>
                <input type="hidden" id="managerEmailInput" name="mngrEml" required>
                <div class="invalid-feedback"></div>
            </div>
            </div>
            <div class="button-wrapper"><button type="button" class="btn btn-outline-secondary prev-step">이전</button><button type="button" class="btn btn-outline-primary next-step">다음</button></div>
        </div>
    </div>
    
    <!-- Step 3: 사업 및 계약 정보 -->
    <div class="tab-pane fade" id="step3" role="tabpanel" aria-labelledby="step3-tab">
         <div class="card card-body p-4 p-md-5">
            <h5 class="form-section-title">사업장 정보</h5>
            <div class="row">
               <div class="col-12 mb-3">
                    <label for="brno">사업자등록번호 조회 <span class="text-danger">*</span></label>
                    <div class="input-group-gap">
                        <div class="row g-2"> 
                            <div class="col"><input class="form-control" type="text" id="brno" name="brno" placeholder="'-' 없이 10자리 숫자를 입력하세요." pattern="[0-9]{10}" title="숫자 10자리를 입력해주세요." maxlength="10" required></div>
                            <div class="col-auto"><button class="btn btn-outline-primary" type="button" id="checkBrnoButton">조회</button></div>
                            <div class="col-auto"><button class="btn btn-outline-secondary" type="button" onclick="resetBrnoForm()">다시입력</button></div>
                        </div>
                        <div id="apiResponseContainer" class="mt-2" style="font-weight: bold;"></div>
                        <div class="invalid-feedback"></div>
                    </div>
                </div>
              <div class="col-12">
                <label>스토어 주소 <span class="text-danger">*</span></label>
                <div class="row gx-2 align-items-center mb-2">             
                    <div class="col-6"><input type="text" class="form-control" id="sample2_postcode" placeholder="우편번호" readonly="readonly" name="bplcPostCode" required></div>
                    <div class="col-auto brno"><button class="btn btn-outline-secondary" type="button" onclick="sample2_execDaumPostcode()">주소 찾기</button></div>								
                </div>
                <div class="row gx-2">
                    <div class="col-md-6 mb-2"><input type="text" class="form-control" id="sample2_address" placeholder="주소" readonly="readonly" name="bplcAddr" required></div>
                    <div class="col-md-6 mb-2"><input type="text" class="form-control" id="sample2_detailAddress" placeholder="상세주소" name="bplcDaddr" required></div>
                </div>
                <div class="invalid-feedback"></div>
                <div id="layer" style="display:none;position:fixed;overflow:hidden;z-index:9999;-webkit-overflow-scrolling:touch;"><img src="//t1.daumcdn.net/postcode/resource/images/close.png" id="btnCloseLayer" style="cursor:pointer;position:absolute;right:-3px;top:-3px;z-index:1" onclick="closeDaumPostcode()" alt="닫기 버튼"></div>
              </div>
            </div>
            <h5 class="form-section-title mt-4">계약 정보</h5>
            <div class="row">
                <div class="col-md-6 mb-3"><label>계약 신청일</label><div class="user-info" id="contractApplyDateDisplay" th:text="${todayDate}"></div></div>
                <div class="col-md-6 mb-3">
                    <label>계약 기간(최대 5년) <span class="text-danger">*</span></label>
                    <div class="contract-period-group">
                        <span class="period-display" id="contractDisplay"> </span>
                        <div class="period-buttons"><button type="button" class="btn-period" id="decrementYearBtn">-</button><button type="button" class="btn-period" id="incrementYearBtn">+</button></div>
                    </div>
                    <input type="hidden" id="contractTermInput" name="ctrtTermVal">
                    <input type="hidden" id="contractApplyDateInput" name="ctrtAplyYmd" th:value="${todayDate}">
                </div>
            </div>
            <div class="button-wrapper"><button type="button" class="btn btn-outline-secondary prev-step">이전</button><button type="button" class="btn btn-outline-primary next-step">다음</button></div>
        </div>
    </div>
    
    <!-- Step 4: 서류 제출 -->
<div class="tab-pane fade" id="step4" role="tabpanel" aria-labelledby="step4-tab">
    <div class="card card-body p-4 p-md-5">
        <h5 class="form-section-title">필수 제출 서류</h5>
        <div class="file-upload-container">
            <ul class="file-upload-list">
                <!-- ▼▼▼ 모든 input 태그에 accept 속성 추가 ▼▼▼ -->
                <li class="file-upload-item">
                    <span class="doc-name">사업자 등록증 <span class="text-danger">*</span></span>
                    <span class="file-name-display" id="fileNameDisplay-1">이미지 또는 PDF파일</span>
                    <label for="file-upload-1" class="btn-file select">파일 선택</label>
                    <input id="file-upload-1" type="file" name="businessRegistrationDoc" required accept="image/*, .pdf" />
                    <button type="button" class="btn-file cancel" data-target="1">취소</button>
                </li>
                <li class="file-upload-item">
                    <span class="doc-name">통신 판매업 신고증 <span class="text-danger">*</span></span>
                    <span class="file-name-display" id="fileNameDisplay-2">이미지 또는 PDF파일</span>
                    <label for="file-upload-2" class="btn-file select">파일 선택</label>
                    <input id="file-upload-2" type="file" name="telecommunicationLicense" required accept="image/*, .pdf" />
                    <button type="button" class="btn-file cancel" data-target="2">취소</button>
                </li>
                <li class="file-upload-item">
                    <span class="doc-name">대표자 신분증 사본 <span class="text-danger">*</span></span>
                    <span class="file-name-display" id="fileNameDisplay-4">이미지 또는 PDF파일</span>
                    <label for="file-upload-4" class="btn-file select">파일 선택</label>
                    <input id="file-upload-4" type="file" name="idCardCopy" required accept="image/*, .pdf" />
                    <button type="button" class="btn-file cancel" data-target="4">취소</button>
                </li>
                <li class="file-upload-item">
                    <span class="doc-name">통장 사본 <span class="text-danger">*</span></span>
                    <span class="file-name-display" id="fileNameDisplay-5">이미지 또는 PDF파일</span>
                    <label for="file-upload-5" class="btn-file select">파일 선택</label>
                    <input id="file-upload-5" type="file" name="bankAccountCopy" required accept="image/*, .pdf" />
                    <button type="button" class="btn-file cancel" data-target="5">취소</button>
                </li>
            </ul>
            <div class="invalid-feedback"></div>
        </div>
        <h5 class="form-section-title mt-4">선택 제출 서류</h5>
        <ul class="file-upload-list">
             <li class="file-upload-item">
                 <span class="doc-name">판매상품 관련 증빙</span>
                 <span class="file-name-display" id="fileNameDisplay-3">이미지 또는 PDF파일</span>
                 <label for="file-upload-3" class="btn-file select">파일 선택</label>
                 <input id="file-upload-3" type="file" name="productEvidence" accept="image/*, .pdf" />
                 <button type="button" class="btn-file cancel" data-target="3">취소</button>
             </li>
             <li class="file-upload-item">
                 <span class="doc-name">기타 서류</span>
                 <span class="file-name-display" id="fileNameDisplay-6">이미지 또는 PDF파일</span>
                 <label for="file-upload-6" class="btn-file select">파일 선택</label>
                 <input id="file-upload-6" type="file" name="etcDocs" accept="image/*, .pdf" />
                 <button type="button" class="btn-file cancel" data-target="6">취소</button>
             </li>
             <li class="file-upload-item">
                 <span class="doc-name">스토어 로고</span>
                 <span class="file-name-display" id="fileNameDisplay-7">이미지 파일</span>
                 <label for="file-upload-7" class="btn-file select">파일 선택</label>
                 <!-- 스토어 로고는 이미지만 받도록 하는 것이 더 좋습니다 -->
                 <input id="file-upload-7" type="file" name="storeLogoImgFile" accept="image/*" />
                 <button type="button" class="btn-file cancel" data-target="7">취소</button>
             </li>
        </ul>
            <div class="button-wrapper"><button type="button" class="btn btn-outline-secondary prev-step">이전</button><button type="button" class="btn btn-outline-primary" id="submitApplication">최종 제출</button></div>
        </div>
    </div>
</div>
</div>
                </div>
            </div>
    </main>
</th:block>

<th:block layout:fragment="jsFile">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</th:block>

<th:block layout:fragment="jsScript">
<script th:inline="javascript">
/*<![CDATA[*/

// =================================================================
// 전역 스코프 함수 (HTML의 onclick 등에서 직접 호출)
// =================================================================

// 사업자등록번호 조회 상태를 저장하는 전역 변수
let isBrnoVerified = false;

// 사업자등록번호 입력폼 초기화 함수
function resetBrnoForm() {
    const brnoInput = document.getElementById('brno');
    const apiResponseContainer = document.getElementById('apiResponseContainer');
    
    brnoInput.value = '';
    brnoInput.readOnly = false;
    brnoInput.classList.remove('is-invalid');
    
    apiResponseContainer.innerHTML = '';
    apiResponseContainer.closest('.input-group-gap').querySelector('.invalid-feedback').textContent = '';
    
    isBrnoVerified = false;
}

// 다음 주소 API 호출 함수
function sample2_execDaumPostcode() {
    const element_layer = document.getElementById('layer');

    new daum.Postcode({
        oncomplete: function(data) {
            // 주소 정보 필드에 값 설정
            document.getElementById('sample2_postcode').value = data.zonecode;
            const fullAddress = (data.userSelectedType === 'R') ? data.roadAddress : data.jibunAddress;
            document.getElementById("sample2_address").value = fullAddress;
            
            // 유효성 검사 오류 제거
            document.getElementById('sample2_postcode').classList.remove('is-invalid');

            // 상세주소 필드로 포커스 이동
            document.getElementById("sample2_detailAddress").focus();
            
            // 주소 검색 레이어 닫기
            element_layer.style.display = 'none';
        },
        width: '100%',
        height: '100%',
        maxSuggestItems: 5
    }).embed(element_layer);

    // 레이어 표시 및 위치 조정
    element_layer.style.display = 'block';
    initLayerPosition();
}

// 다음 주소 API 레이어 닫기 함수
function closeDaumPostcode() {
    document.getElementById('layer').style.display = 'none';
}

// 다음 주소 API 레이어 위치 초기화 함수
function initLayerPosition() {
    const element_layer = document.getElementById('layer');
    const width = 300; // 레이어의 너비
    const height = 400; // 레이어의 높이
    const borderWidth = 5; // 테두리 두께

    element_layer.style.width = width + 'px';
    element_layer.style.height = height + 'px';
    element_layer.style.border = borderWidth + 'px solid';
    // 화면 중앙에 레이어 위치시키기
    element_layer.style.left = (((window.innerWidth || document.documentElement.clientWidth) - width) / 2 - borderWidth) + 'px';
    element_layer.style.top = (((window.innerHeight || document.documentElement.clientHeight) - height) / 2 - borderWidth) + 'px';
}


// =================================================================
// DOM 로드 후 실행되는 메인 코드
// =================================================================
document.addEventListener('DOMContentLoaded', function() {

    // --- 허용할 파일 MIME 타입 정의 ---
    const allowedMimeTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'application/pdf'];
    const allowedLogoMimeTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];

    // --- Wizard 네비게이션(탭 이동) 로직 ---
    const nextStepButtons = document.querySelectorAll('.next-step');
    const prevStepButtons = document.querySelectorAll('.prev-step');

    nextStepButtons.forEach(button => {
        button.addEventListener('click', function() {
            const currentTabPane = this.closest('.tab-pane');
            // 현재 스텝의 유효성 검사 통과 못하면 다음으로 넘어가지 않음
            if (!validateStep(currentTabPane.id)) {
                return;
            }
            const currentTab = document.querySelector(`.nav-link[href="#${currentTabPane.id}"]`);
            const nextTabEl = currentTab.parentElement.nextElementSibling?.querySelector('.nav-link');
            if (nextTabEl) {
                currentTab.classList.add('completed'); // 상단 탭에 완료 표시
                new bootstrap.Tab(nextTabEl).show(); // 다음 탭 보여주기
                window.scrollTo(0, 0); // 페이지 상단으로 스크롤
            }
        });
    });

    prevStepButtons.forEach(button => {
        button.addEventListener('click', function() {
            const currentTabPane = this.closest('.tab-pane');
            const prevTabEl = document.querySelector(`.nav-link[href="#${currentTabPane.id}"]`).parentElement.previousElementSibling?.querySelector('.nav-link');
            if (prevTabEl) {
                new bootstrap.Tab(prevTabEl).show(); // 이전 탭 보여주기
                window.scrollTo(0, 0); // 페이지 상단으로 스크롤
            }
        });
    });

    // --- 스텝별 유효성 검사 함수 ---
    function validateStep(stepId) {
        let isValid = true;
        let firstInvalidElement = null;

        const currentStepPane = document.getElementById(stepId);
        // 기존 오류 메시지 초기화
        currentStepPane.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
        currentStepPane.querySelectorAll('.invalid-feedback').forEach(el => { el.textContent = ''; });
        
        // 필드 유효성 검사를 위한 헬퍼 함수
        const checkField = (element, message, validationFn) => {
            if (!element || !isValid) return; // 요소가 없거나 이미 유효성 검사에 실패했으면 중단

            if (!validationFn(element)) {
                isValid = false;
                // 오류 메시지를 표시할 .invalid-feedback 요소를 찾음
                const feedback = element.nextElementSibling && element.nextElementSibling.classList.contains('invalid-feedback') ?
                    element.nextElementSibling :
                    element.closest('div').querySelector('.invalid-feedback');
                
                if (feedback) { feedback.textContent = message; }
                element.classList.add('is-invalid');
                if (!firstInvalidElement) { firstInvalidElement = element; } // 첫 번째 오류 필드로 저장
            }
        };

        if (stepId === 'step1') {
            checkField(document.getElementById('dpstrNm'), '예금주를 입력해주세요.', el => el.value.trim() !== '');
            checkField(document.getElementById('bankNm'), '은행을 선택해주세요.', el => el.value !== '');
            checkField(document.getElementById('actno'), '10~16자리의 숫자만 입력 가능합니다.', el => /^\d{10,16}$/.test(el.value));
        } else if (stepId === 'step2') {
            checkField(document.getElementById('storeNameInput'), '상점 명을 입력해주세요.', el => el.value.trim() !== '');
            checkField(document.getElementById('storeIntroTextarea'), '스토어 소개를 입력해주세요.', el => el.value.trim() !== '');
            checkField(document.getElementById('managerNameInput'), '매니저 이름을 입력해주세요.', el => el.value.trim() !== '');
            
            // 연락처 필드 그룹 검사
            if (isValid) {
                const telInput = document.getElementById('managerTelInput');
                if (!/^01[0-9]-\d{3,4}-\d{4}$/.test(telInput.value)) {
                    isValid = false;
                    firstInvalidElement = document.getElementById('managerTel1');
                    ['managerTel1', 'managerTel2', 'managerTel3'].forEach(id => document.getElementById(id).classList.add('is-invalid'));
                    telInput.closest('div').querySelector('.invalid-feedback').textContent = '매니저 연락처를 올바르게 입력해주세요. (예: 010-1234-5678)';
                }
            }
            // 이메일 필드 그룹 검사
            if (isValid) {
                const emailInput = document.getElementById('managerEmailInput');
                if (!/^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/.test(emailInput.value)) {
                    isValid = false;
                    firstInvalidElement = firstInvalidElement || document.getElementById('emailId');
                    ['emailId', 'emailDomain'].forEach(id => document.getElementById(id).classList.add('is-invalid'));
                    emailInput.closest('div').querySelector('.invalid-feedback').textContent = '매니저 이메일을 올바르게 입력해주세요.';
                }
            }
        } else if (stepId === 'step3') {
            checkField(document.getElementById('brno'), '사업자등록번호 10자리를 입력해주세요.', el => /^\d{10}$/.test(el.value.trim()));
            if (isValid && !isBrnoVerified) {
                isValid = false;
                const brnoField = document.getElementById('brno');
                brnoField.classList.add('is-invalid');
                brnoField.closest('.input-group-gap').querySelector('.invalid-feedback').textContent = '사업자등록번호를 조회하고 인증을 완료해주세요.';
                firstInvalidElement = brnoField;
            }
            checkField(document.getElementById('sample2_postcode'), '스토어 주소를 입력해주세요.', el => el.value.trim() !== '');
            checkField(document.getElementById('sample2_detailAddress'), '스토어 상세주소를 입력해주세요.', el => el.value.trim() !== '');
        }
        
        // 첫 번째 오류 필드로 스크롤 및 포커스
        if (!isValid && firstInvalidElement) {
            if (firstInvalidElement.offsetParent !== null) { // 화면에 보이는 요소일 경우에만
                firstInvalidElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstInvalidElement.focus();
            }
        }
        return isValid;
    }

    // --- 필수 서류 유효성 검사 함수 (첨부 여부 및 파일 형식 동시 검사) ---
    function validateRequiredFiles() {
        const fileContainer = document.querySelector('.file-upload-container');
        fileContainer.classList.remove('is-invalid');
        fileContainer.querySelector('.invalid-feedback').textContent = '';
        document.querySelectorAll('.file-upload-item.file-item-invalid').forEach(li => {
            li.classList.remove('file-item-invalid');
        });

        let allFilesValid = true;
        const requiredFileIds = ['file-upload-1', 'file-upload-2', 'file-upload-4', 'file-upload-5'];

        for (const id of requiredFileIds) {
            const element = document.getElementById(id);
            const listItem = element.closest('.file-upload-item');
            
            // 파일이 첨부되지 않았거나, 첨부되었지만 유효하지 않은 파일(dataset)인 경우
            if (!element.value || element.dataset.isValid === 'false') {
                allFilesValid = false;
                if (listItem) {
                    listItem.classList.add('file-item-invalid'); // 해당 항목 음영 처리
                }
            }
        }

        if (!allFilesValid) {
            fileContainer.classList.add('is-invalid');
            fileContainer.querySelector('.invalid-feedback').textContent = '붉게 표시된 필수 서류(*)를 올바른 파일 형식(이미지, PDF)으로 모두 첨부해주세요.';
            new bootstrap.Tab(document.getElementById('step4-tab')).show(); // 4단계로 강제 이동
        }

        return allFilesValid;
    }

    // --- 실시간으로 오류 상태 제거하는 리스너 ---
    document.querySelectorAll('input, select, textarea').forEach(el => {
        el.addEventListener('input', () => {
            el.classList.remove('is-invalid');
            // 그룹화된 필드들의 오류 스타일도 함께 제거
            if (['managerTel1','managerTel2','managerTel3'].includes(el.id)) {
                ['managerTel1','managerTel2','managerTel3'].forEach(id => document.getElementById(id).classList.remove('is-invalid'));
            }
            if (['emailId', 'emailDomain'].includes(el.id)) {
                 ['emailId', 'emailDomain'].forEach(id => document.getElementById(id).classList.remove('is-invalid'));
            }
        });
    });

    // --- 연락처 및 이메일 자동 조합 로직 ---
    const tel1 = document.getElementById('managerTel1'), tel2 = document.getElementById('managerTel2'), tel3 = document.getElementById('managerTel3');
    const hiddenTel = document.getElementById('managerTelInput');
    const updateManagerTel = () => {
        hiddenTel.value = (tel1.value && tel2.value.trim() && tel3.value.trim()) ? `${tel1.value}-${tel2.value.trim()}-${tel3.value.trim()}` : '';
    };
    [tel1, tel2, tel3].forEach(el => el.addEventListener('input', updateManagerTel));
    
    const emailId = document.getElementById('emailId'), emailDomain = document.getElementById('emailDomain'), emailSelector = document.getElementById('emailDomainSelector');
    const hiddenEmail = document.getElementById('managerEmailInput');
    const updateManagerEmail = () => {
        hiddenEmail.value = (emailId.value.trim() && emailDomain.value.trim()) ? `${emailId.value.trim()}@${emailDomain.value.trim()}` : '';
    };
    emailSelector.addEventListener('change', function() {
        if (this.value) {
            emailDomain.value = this.value;
            emailDomain.readOnly = true;
        } else {
            emailDomain.value = '';
            emailDomain.readOnly = false;
            emailDomain.focus();
        }
        updateManagerEmail();
    });
    [emailId, emailDomain].forEach(el => el.addEventListener('input', updateManagerEmail));

    // --- 파일 등록 및 유효성 검사 로직 ---
    document.querySelectorAll('input[type="file"]').forEach(input => {
        input.addEventListener('change', function() {
            const display = this.parentElement.querySelector('.file-name-display');
            const listItem = this.closest('.file-upload-item');
            
            this.dataset.isValid = 'false'; // 일단 유효성 상태 초기화

            if (this.files && this.files.length > 0) {
                const file = this.files[0];
                const isLogoInput = this.name === 'storeLogoImgFile';
                const validTypes = isLogoInput ? allowedLogoMimeTypes : allowedMimeTypes;
                
                // MIME 타입 검사
                if (validTypes.includes(file.type)) {
                    this.dataset.isValid = 'true';
                    if (display) display.textContent = file.name;
                    if (listItem) listItem.classList.remove('file-item-invalid');
                } else {
                    this.value = ''; // 잘못된 파일이면 선택을 강제 취소
                    if (display) display.textContent = '선택된 파일 없음';
                    if (listItem) listItem.classList.add('file-item-invalid');
                    Swal.fire({
                        icon: 'warning',
                        title: '잘못된 파일 형식',
                        text: isLogoInput ? '스토어 로고는 이미지 파일만 첨부 가능합니다.' : '이미지(JPG, PNG 등) 또는 PDF 파일만 첨부 가능합니다.',
                        confirmButtonText: '확인'
                    });
                }
            } else {
                if (display) display.textContent = '선택된 파일 없음';
            }
        });
    });

    // 파일 선택 '취소' 버튼 로직
    document.querySelectorAll('.btn-file.cancel').forEach(button => {
        button.addEventListener('click', function() {
            const num = this.dataset.target;
            const input = document.getElementById('file-upload-' + num);
            const display = document.getElementById('fileNameDisplay-' + num);
            
            if (input) input.value = '';
            if (display) display.textContent = '선택된 파일 없음';
            // 취소 시에도 유효성 검사 음영은 그대로 유지 (사용자가 다시 제출 버튼을 눌러야 재검사)
        });
    });

    // --- 사업자 등록정보 조회 API 연동 ---
    document.getElementById('checkBrnoButton')?.addEventListener('click', function() {
        const brnoInput = document.getElementById('brno');
        const brno = brnoInput.value.replace(/-/g, '');
        const apiResponse = document.getElementById('apiResponseContainer');
        
        isBrnoVerified = false; // 조회 버튼 누를 때마다 인증 상태 초기화
        
        if (!brno || brno.length !== 10 || !/^\d+$/.test(brno)) {
            apiResponse.innerHTML = '<span class="text-danger">올바른 사업자등록번호 10자리를 입력해주세요.</span>';
            return;
        }
        
        apiResponse.innerHTML = '<span>조회 중...</span>';
        
        fetch(`/api/brno/status?brno=${brno}`)
            .then(async res => {
                if (!res.ok) { // HTTP 상태 코드가 200-299가 아닐 경우
                    const errorData = await res.json().catch(() => null);
                    const errorMessage = errorData ? errorData.message : await res.text();
                    return Promise.reject({ status: res.status, message: errorMessage });
                }
                return res.json();
            })
            .then(data => {
                // 국세청 API 응답 데이터 구조에 따라 응답 처리
                if (data?.data?.[0]?.b_stt_cd === '01') { // '계속사업자' 코드
                    isBrnoVerified = true;
                    apiResponse.innerHTML = `<span class="text-success">확인되었습니다. 계속 진행해주세요. (상태: ${data.data[0].b_stt})</span>`;
                    brnoInput.readOnly = true; // 인증 성공 시 수정 불가
                } else {
                    const status = data?.data?.[0]?.b_stt || '등록되지 않음';
                    const tax_type = data?.data?.[0]?.tax_type || '정보 없음';
                    apiResponse.innerHTML = `<span class="text-danger">${status} 상태의 사업자입니다. (${tax_type})</span>`;
                }
            })
            .catch(err => {
                // fetch 자체의 오류 또는 서버의 에러 응답 처리
                if (err.status === 409) { // '이미 등록된 번호' 같은 특정 비즈니스 오류
                    apiResponse.innerHTML = `<span class="text-danger">${err.message || '이미 등록된 사업자등록번호입니다.'}</span>`;
                } else {
                    apiResponse.innerHTML = `<span class="text-danger">조회 중 오류가 발생했습니다. (오류: ${err.message || '서버 응답 없음'})</span>`;
                }
                console.error('Fetch Error:', err);
            });
    });
    
    // 사업자 번호 다시 입력 시 인증 상태 초기화
    document.getElementById('brno')?.addEventListener('input', () => {
        if (document.getElementById('brno').readOnly) return;
        isBrnoVerified = false;
        document.getElementById('apiResponseContainer').innerHTML = '';
    });

    // --- 계약 기간 조절 로직 ---
    // --- 계약 기간 조절 로직 ---
    const decrementBtn = document.getElementById('decrementYearBtn');
    const incrementBtn = document.getElementById('incrementYearBtn');
    const displaySpan = document.getElementById('contractDisplay');
    const hiddenDaysInput = document.getElementById('contractTermInput');
    let currentYear = 1;
    
    function updateContractDisplay() {
        const days = currentYear * 365;
        displaySpan.textContent = `${currentYear}년 (${days}일)`;
        hiddenDaysInput.value = days;
    }

    // 수정된 부분: currentYear가 5보다 작을 때만 증가
    incrementBtn.addEventListener('click', () => { 
        if (currentYear < 5) { 
            currentYear++; 
            updateContractDisplay(); 
        } 
    });

    decrementBtn.addEventListener('click', () => { 
        if (currentYear > 1) { 
            currentYear--; 
            updateContractDisplay(); 
        } 
    });
    
    updateContractDisplay(); // 페이지 로드 시 초기값 설정

    // --- 최종 제출 로직 ---
    document.getElementById('submitApplication')?.addEventListener('click', async function(event) {
        event.preventDefault(); // form의 기본 제출 동작 방지
        
        // --- 모든 유효성 검사 실행 ---
        let allFilesFormatValid = true;
        document.querySelectorAll('input[type="file"]').forEach(input => {
            if (input.files.length > 0 && input.dataset.isValid === 'false') {
                allFilesFormatValid = false;
            }
        });

        if (!allFilesFormatValid) {
             Swal.fire({
                icon: 'warning', title: '잘못된 파일 포함', text: '허용되지 않는 형식의 파일이 포함되어 있습니다. 다시 확인해주세요.', confirmButtonText: '확인'
            });
            new bootstrap.Tab(document.getElementById('step4-tab')).show();
            return;
        }

        const isStep1Valid = validateStep('step1');
        const isStep2Valid = validateStep('step2');
        const isStep3Valid = validateStep('step3');
        const areRequiredFilesAttached = validateRequiredFiles();

        // 하나라도 유효성 검사를 통과하지 못하면 제출 중단
        if (!isStep1Valid || !isStep2Valid || !isStep3Valid || !areRequiredFilesAttached) {
            // 가장 첫 번째로 유효하지 않은 탭으로 자동 이동
            if (!isStep1Valid) new bootstrap.Tab(document.getElementById('step1-tab')).show();
            else if (!isStep2Valid) new bootstrap.Tab(document.getElementById('step2-tab')).show();
            else if (!isStep3Valid) new bootstrap.Tab(document.getElementById('step3-tab')).show();
            
            Swal.fire({
                icon: 'warning', title: '입력 정보 확인 필요', text: '필수 입력 항목을 모두 올바르게 채워주세요.', confirmButtonText: '확인'
            });
            return;
        }
        
        // --- 모든 검사를 통과하면 사용자에게 최종 확인 ---
        Swal.fire({
            title: '최종 제출 확인', text: "입력하신 내용으로 스토어 신청을 제출하시겠습니까?", icon: 'question',
            showCancelButton: true, confirmButtonColor: '#3085d6', cancelButtonColor: '#d33',
            confirmButtonText: '네, 제출합니다', cancelButtonText: '아니요'
        }).then(async (result) => {
            if (result.isConfirmed) {
                // --- FormData 객체 생성 및 데이터 담기 ---
                const formData = new FormData();
                // Step 1 데이터
                formData.append('aplyUserNo', document.getElementById('applicantIdDisplay').textContent);
                formData.append('dpstrNm', document.getElementById('dpstrNm').value);
                formData.append('bankNm', document.getElementById('bankNm').value);
                formData.append('actno', document.getElementById('actno').value);
                // Step 2 데이터
                formData.append('storeNm', document.getElementById('storeNameInput').value);
                formData.append('plcyId', document.getElementById('commissionRateCn').textContent);
                formData.append('storeIntroCn', document.getElementById('storeIntroTextarea').value);
                formData.append('mngrNm', document.getElementById('managerNameInput').value);
                formData.append('mngrTelNo', document.getElementById('managerTelInput').value);
                formData.append('mngrEml', document.getElementById('managerEmailInput').value);
                // Step 3 데이터
                formData.append('brno', document.getElementById('brno').value);
                formData.append('bplcPostCode', document.getElementById('sample2_postcode').value);
                formData.append('bplcAddr', document.getElementById('sample2_address').value);
                formData.append('bplcDaddr', document.getElementById('sample2_detailAddress').value);
                formData.append('ctrtAplyYmd', document.getElementById('contractApplyDateInput').value);
                formData.append('ctrtTermVal', document.getElementById('contractTermInput').value);
                // Step 4 데이터 (파일)
                for(let i=1; i<=7; i++) {
                    const fileInput = document.getElementById('file-upload-' + i);
                    if (fileInput && fileInput.files.length > 0) {
                        formData.append(fileInput.name, fileInput.files[0]);
                    }
                }
                
                try {
                    // 로딩 스피너 표시
                    Swal.fire({
                        title: '제출 중...', text: '잠시만 기다려주세요.', allowOutsideClick: false,
                        didOpen: () => { Swal.showLoading(); }
                    });

                    // 서버에 데이터 전송
                    const response = await fetch('/store/appStore', { method: 'POST', body: formData });
                    const responseText = await response.text(); // 서버 응답 메시지

                    if (!response.ok) { // HTTP 에러 발생 시
                        Swal.fire({ icon: 'error', title: `신청 실패 (HTTP ${response.status})`, text: responseText, confirmButtonText: '확인' });
                        return;
                    }

                    // 성공 시
                    Swal.fire({
                        icon: 'success', title: '신청 완료', text: responseText, confirmButtonText: '확인'
                    }).then(() => {
                        location.href = '/customer/mypage'; // 성공 후 마이페이지로 이동
                    });

                } catch (error) { // 네트워크 오류 등
                    console.error('신청 제출 중 오류 발생:', error);
                    Swal.fire({
                        icon: 'error', title: '제출 오류', text: `신청 제출 중 네트워크 오류가 발생했습니다: ${error.message}`, confirmButtonText: '확인'
                    });
                }
            }
        });
    });
});
/*]]>*/
</script>