<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org/"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{customer/layout/layoutMain}">
<head>
    <title>장바구니</title>
</head>
<body>
<th:block layout:fragment="contents">

    <div class="page-wrapper">

        <main class="main">
        	<div class="page-header text-center" style="background-image: url('maincss/assets/images/page-header-bg.jpg')">
        		<div class="container">
        			<h1 class="page-title">Shopping Cart<span>Shop</span></h1>
        		</div>
        	</div>

            <nav aria-label="breadcrumb" class="breadcrumb-nav">
                <div class="container">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                        <li class="breadcrumb-item"><a href="#">Shop</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Shopping Cart</li>
                    </ol>
                </div>
            </nav>

            <div class="page-content">
            	<div class="cart">
	                <div class="container">
	                	<div class="row">
	                		<div class="col-lg-9">
	                			<table class="table table-cart table-mobile">
								  <thead>
								    <tr>
								      <th>Product</th>
								      <th>Price</th>
								      <th>Quantity</th>
								      <th>Total</th>
								      <th></th>
								    </tr>
								  </thead>
								  <tbody id="cart-body">
								    </tbody>
								</table>

	                			<div class="cart-bottom">
			            			<div class="cart-discount">
			            				<form action="#">
			            					<div class="input-group">
				        						<input type="text" class="form-control" required placeholder="coupon code">
				        						<div class="input-group-append">
													<button class="btn btn-outline-primary-2" type="submit"><i class="icon-long-arrow-right"></i></button>
												</div>
			        						</div>
			            				</form>
			            			</div>

			            			<a href="#" class="btn btn-outline-dark-2"><span>UPDATE CART</span><i class="icon-refresh"></i></a>
		            			</div>
	                		</div>

	                		<aside class="col-lg-3">
	                			<div class="summary summary-cart">
                                    <h3 class="summary-title">Cart Total</h3>

                                    <table class="table table-summary">
                                        <tbody>
                                            <tr class="summary-subtotal">
                                                <td>Subtotal:</td>
                                                <td>₩<span id="subtotal_amount">0.00</span></td>
                                            </tr>
                                            <tr class="summary-total">
                                                <td>Total:</td>
                                                <td>₩<span id="final_total_amount">0.00</span></td>
                                            </tr>
                                        </tbody>
                                    </table>

									<a href="checkout" id="checkoutBtn" class="btn btn-outline-primary-2 btn-order btn-block">
									  PROCEED TO CHECKOUT
									</a>
                                </div>

		            			<a href="category.html" class="btn btn-outline-dark-2 btn-block mb-3"><span>CONTINUE SHOPPING</span><i class="icon-refresh"></i></a>
	                		</aside>
	                	</div>
	                </div>
                </div>
            </div>
        </main>

    </div>
    <button id="scroll-top" title="Back to Top"><i class="icon-arrow-up"></i></button>

    <div class="mobile-menu-overlay"></div>
    <div class="mobile-menu-container"></div>
    <div class="modal fade" id="signin-modal" tabindex="-1" role="dialog" aria-hidden="true"></div>

    <script src="maincss/assets/js/jquery.min.js"></script>
    <script src="maincss/assets/js/bootstrap.bundle.min.js"></script>
    <script src="maincss/assets/js/jquery.hoverIntent.min.js"></script>
    <script src="maincss/assets/js/jquery.waypoints.min.js"></script>
    <script src="maincss/assets/js/superfish.min.js"></script>
    <script src="maincss/assets/js/owl.carousel.min.js"></script>
    <script src="maincss/assets/js/bootstrap-input-spinner.js"></script>
    <script src="maincss/assets/js/main.js"></script>

    <script>
        $(document).ready(function() {
            // 가격 포맷팅 함수 (예: 10000 -> 10,000)
            function formatPrice(price) {
                return price.toLocaleString('ko-KR');
            }

            // 1. 세션 스토리지에서 장바구니 데이터 가져오기
            const cartData = JSON.parse(sessionStorage.getItem('cart_data'));
            const $tbody = $('#cart-body');

            console.log("불러온 세션 장바구니:", cartData); // ✅ 디버깅용 로그

            // 2. 장바구니 데이터를 기반으로 HTML 동적 생성
            if (cartData && cartData.products && cartData.products.length > 0) {
                cartData.products.forEach(product => {
                    const itemTotal = product.price * product.quantity;
                    const newRow = $(`
                        <tr data-price="${product.price}" data-id="${product.id}">
                            <td class="product-col">
                                <div class="product">
                                    <figure class="product-media">
                                        <a href="#"><img src="${product.image}" alt="Product image" style="width: 60px; height: auto;"></a>
                                    </figure>
                                    <h3 class="product-title">
                                        <a href="#">${product.name}</a>
                                    </h3>
                                </div>
                            </td>
                            <td class="price-col">₩${formatPrice(product.price)}</td>
                            <td class="quantity-col">
                                <div class="cart-product-quantity">
                                    <input type="number" class="form-control qty-input" value="${product.quantity}" min="1" max="10" step="1" required>
                                </div>
                            </td>
                            <td class="total-col item-total">₩${formatPrice(itemTotal)}</td>
                            <td class="remove-col"><button class="btn-remove"><i class="icon-close"></i></button></td>
                        </tr>
                    `);
                    $tbody.append(newRow);
                });
            } else {
                $tbody.append(`<tr><td colspan="5" class="text-center">장바구니에 담긴 상품이 없습니다.</td></tr>`);
            }

            // 3. 장바구니 총액 계산 및 업데이트 함수
            function updateCartTotals() {
                let subtotal = 0;
                // 화면의 각 상품 row를 순회하며 총액 계산
                $('table.table-cart tbody tr[data-id]').each(function() {
                    const $row = $(this);
                    const unitPrice = parseFloat($row.data('price')) || 0;
                    const quantity = parseInt($row.find('.qty-input').val()) || 0;
                    const itemTotal = unitPrice * quantity;

                    // 개별 상품 합계 업데이트
                    $row.find('.item-total').text('₩' + formatPrice(itemTotal));
                    subtotal += itemTotal;
                });

                // 최종 합계 업데이트
                $('#subtotal_amount').text(formatPrice(subtotal));
                $('#final_total_amount').text(formatPrice(subtotal));
            }

            // 4. 세션 스토리지 데이터 업데이트 함수
            function updateSessionStorage() {
                const currentCartData = JSON.parse(sessionStorage.getItem('cart_data')) || { products: [] };
                const updatedProducts = [];

                $('table.table-cart tbody tr[data-id]').each(function() {
                    const $row = $(this);
                    const id = $row.data('id');
                    const quantity = parseInt($row.find('.qty-input').val());

                    // 현재 cartData.products 배열에서 해당 id를 가진 상품을 찾아서 업데이트
                    // `productDetailCart.js`에서 저장할 때 id에 상품명, 색상, 사이즈를 모두 포함하여 고유하게 만들었기 때문에
                    // 여기서는 단순히 id로 찾으면 됩니다.
                    const product = currentCartData.products.find(p => p.id === id);
                    if (product) {
                        product.quantity = quantity;
                        updatedProducts.push(product);
                    }
                });

                currentCartData.products = updatedProducts;
                sessionStorage.setItem('cart_data', JSON.stringify(currentCartData));
                console.log("세션 스토리지 업데이트 완료:", currentCartData);
            }


            // 5. 이벤트 핸들러 (수량 변경, 상품 삭제)
            $tbody.on('change input', '.qty-input', function() {
                updateCartTotals();
                updateSessionStorage(); // 수량 변경 시 세션 스토리지 업데이트
            });

            $tbody.on('click', '.btn-remove', function() {
                $(this).closest('tr').remove();
                updateCartTotals();
                updateSessionStorage(); // 상품 삭제 시 세션 스토리지 업데이트

                // 장바구니가 비었는지 확인 후 메시지 표시
                if ($('table.table-cart tbody tr[data-id]').length === 0) {
                     $tbody.html(`<tr><td colspan="5" class="text-center">장바구니에 담긴 상품이 없습니다.</td></tr>`);
                }
            });

            // 페이지 최초 로드 시 총액 계산 실행
            updateCartTotals();
        });
    </script>
</th:block>

<th:block layout:fragment="jsFile"></th:block>
<th:block layout:fragment="jsScript"></th:block>
</body>
</html>