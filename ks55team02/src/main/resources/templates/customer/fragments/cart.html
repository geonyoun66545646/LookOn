<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org/"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{customer/layout/layoutMain}"> 
<head>
    <title>장바구니</title>
</head>
<body>
<th:block layout:fragment="contents">
    
    <div class="page-wrapper" >

        <main class="main">
        	<div class="page-header text-center" style="background-image: url('maincss/assets/images/page-header-bg.jpg')">
        		<div class="container">
        			<h1 class="page-title">Shopping Cart<span>Shop</span></h1>
        		</div><!-- End .container -->
        	</div><!-- End .page-header -->

            <nav aria-label="breadcrumb" class="breadcrumb-nav">
                <div class="container">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                        <li class="breadcrumb-item"><a href="#">Shop</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Shopping Cart</li>
                    </ol>
                </div><!-- End .container -->
            </nav><!-- End .breadcrumb-nav -->

            <div class="page-content">
            	<div class="cart">
	                <div class="container">
	                	<div class="row">
	                		<div class="col-lg-9">
	                			<table class="table table-cart table-mobile">
								  <thead>
								    <tr>
								      <th>Product</th>
								      <th>Price</th>
								      <th>Quantity</th>
								      <th>Total</th>
								      <th></th>
								    </tr>
								  </thead>
								  <tbody>
								    <!-- 상품 1 -->
								    <tr data-price="84.00">
								      <td class="product-col">
								        <div class="product">
								          <figure class="product-media">
								            <a href="#">
								              <img src="maincss/assets/images/products/table/product-1.jpg" alt="Product image">
								            </a>
								          </figure>
								          <h3 class="product-title">
								            <a href="#">Beige knitted elastic runner shoes</a>
								          </h3>
								        </div>
								      </td>
								      <td class="price-col">84.00</td>
								      <td class="quantity-col">
								        <div class="cart-product-quantity">
								          <input type="number" class="form-control qty-input" value="1" min="1" max="10" step="1" data-decimals="0" required>
								        </div>
								      </td>
								      <td class="total-col item-total">84.00</td>
								      <td class="remove-col"><button class="btn-remove"><i class="icon-close"></i></button></td>
								    </tr>
								
								    <!-- 상품 2 -->
								    <tr data-price="76.00">
								      <td class="product-col">
								        <div class="product">
								          <figure class="product-media">
								            <a href="#">
								              <img src="maincss/assets/images/products/table/product-2.jpg" alt="Product image">
								            </a>
								          </figure>
								          <h3 class="product-title">
								            <a href="#">Blue utility pinafore denim dress</a>
								          </h3>
								        </div>
								      </td>
								      <td class="price-col">76.00</td>
								      <td class="quantity-col">
								        <div class="cart-product-quantity">
								          <input type="number" class="form-control qty-input" value="1" min="1" max="10" step="1" data-decimals="0" required>
								        </div>
								      </td>
								      <td class="total-col item-total">76.00</td>
								      <td class="remove-col"><button class="btn-remove"><i class="icon-close"></i></button></td>
								    </tr>
								  </tbody>
								</table>

	                			<div class="cart-bottom">
			            			<div class="cart-discount">
			            				<form action="#">
			            					<div class="input-group">
				        						<input type="text" class="form-control" required placeholder="coupon code">
				        						<div class="input-group-append">
													<button class="btn btn-outline-primary-2" type="submit"><i class="icon-long-arrow-right"></i></button>
												</div><!-- .End .input-group-append -->
			        						</div><!-- End .input-group -->
			            				</form>
			            			</div><!-- End .cart-discount -->

			            			<a href="#" class="btn btn-outline-dark-2"><span>UPDATE CART</span><i class="icon-refresh"></i></a>
		            			</div><!-- End .cart-bottom -->
	                		</div><!-- End .col-lg-9 -->

	                		<aside class="col-lg-3">
	                			<div class="summary summary-cart">
                                    <h3 class="summary-title">Cart Total</h3>

                                    <table class="table table-summary">
                                        <tbody>
                                            <tr class="summary-subtotal">
                                                <td>Subtotal:</td>
                                                <td>₩<span id="subtotal_amount">0.00</span></td>
                                            </tr>
                                            <tr class="summary-total">
                                                <td>Total:</td>
                                                <td>₩<span id="final_total_amount">0.00</span></td>
                                            </tr>
                                        </tbody>
                                    </table>

									<a href="checkout" id="checkoutBtn" class="btn btn-outline-primary-2 btn-order btn-block">
									  PROCEED TO CHECKOUT
									</a>
                                </div><!-- End .summary -->

		            			<a href="category.html" class="btn btn-outline-dark-2 btn-block mb-3"><span>CONTINUE SHOPPING</span><i class="icon-refresh"></i></a>
	                		</aside><!-- End .col-lg-3 -->
	                	</div><!-- End .row -->
	                </div><!-- End .container -->
                </div><!-- End .cart -->
            </div><!-- End .page-content -->
        </main><!-- End .main -->

    </div><!-- End .page-wrapper -->
    <button id="scroll-top" title="Back to Top"><i class="icon-arrow-up"></i></button>

    <!-- Mobile Menu, Sign In Modal 등은 변경 없이 그대로 유지됩니다 -->
    <div class="mobile-menu-overlay"></div>
    <div class="mobile-menu-container">
        <!-- ... mobile menu content ... -->
    </div>

    <div class="modal fade" id="signin-modal" tabindex="-1" role="dialog" aria-hidden="true">
        <!-- ... sign in modal content ... -->
    </div>

    <!-- Plugins JS File -->
    <script src="maincss/assets/js/jquery.min.js"></script>
    <script src="maincss/assets/js/bootstrap.bundle.min.js"></script>
    <script src="maincss/assets/js/jquery.hoverIntent.min.js"></script>
    <script src="maincss/assets/js/jquery.waypoints.min.js"></script>
    <script src="maincss/assets/js/superfish.min.js"></script>
    <script src="maincss/assets/js/owl.carousel.min.js"></script>
    <script src="maincss/assets/js/bootstrap-input-spinner.js"></script>
    <!-- Main JS File -->
    <script src="maincss/assets/js/main.js"></script>

    <!-- [최종 수정] 장바구니 관련 모든 JavaScript 로직을 여기에 통합 -->
    <script>
        $(document).ready(function() {
    
            // --- 모든 장바구니 관련 로직을 이 안에 통합 ---
    
            // 1. 총액 계산 및 화면 업데이트 함수
            function updateCartView() {
                let subtotal = 0;
    
                // 모든 상품 행(tr)을 순회하며 계산
                $('table.table-cart tbody tr').each(function() {
                    const $row = $(this);
                    const unitPrice = parseFloat($row.data('price')) || 0;
                    const quantity = parseInt($row.find('.qty-input').val()) || 0;
    
                    const itemTotal = unitPrice * quantity;
                    $row.find('.item-total').text('₩' + itemTotal.toFixed(2));
                    subtotal += itemTotal;
                });
    
                // 계산된 최종 금액을 화면에 표시
                $('#subtotal_amount').text(subtotal.toFixed(2));
                $('#final_total_amount').text(subtotal.toFixed(2));
            }
    
            // 2. 체크아웃 버튼 클릭 시 sessionStorage에 데이터 저장 함수
            function saveCartDataToSession() {
                const products = [];
                let subtotal = 0;
    
                $('table.table-cart tbody tr').each(function() {
                    const $row = $(this);
                    const productName = $row.find('.product-title a').text().trim();
                    const unitPrice = parseFloat($row.data('price')) || 0;
                    const quantity = parseInt($row.find('.qty-input').val()) || 0;
                    
                    // [핵심 수정] 상품명과 수량이 모두 유효할 때만 배열에 추가
                    if (productName && quantity > 0) {
                        const itemTotal = unitPrice * quantity;
                        
                        products.push({
                            name: productName,
                            price: unitPrice,
                            quantity: quantity,
                            total: itemTotal
                        });
    
                        subtotal += itemTotal;
                    }
                });
    
                // 상품이 하나라도 있을 때만 sessionStorage에 저장
                if (products.length > 0) {
                    const cartData = {
                        products: products,
                        subtotal: subtotal.toFixed(2),
                        total: subtotal.toFixed(2) // 현재는 할인/배송비가 없으므로 동일
                    };
                    sessionStorage.setItem('cart_data', JSON.stringify(cartData));
                    console.log("세션에 저장된 데이터:", cartData);
                    return true; // 저장 성공
                } else {
                    alert("장바구니에 상품이 없습니다.");
                    return false; // 저장 실패
                }
            }
    
            // --- 3. 이벤트 리스너 설정 ---
    
            // 페이지 로드 시 즉시 총액 계산
            updateCartView();
    
            // 수량 변경 시 총액 다시 계산
            // .on()을 사용하여 동적으로 추가/삭제되는 요소에도 이벤트가 적용되도록 함
            $('tbody').on('change input', '.qty-input', function() {
                updateCartView();
            });
    
            // 삭제 버튼 클릭 시
            $('tbody').on('click', '.btn-remove', function() {
                $(this).closest('tr').remove();
                updateCartView();
            });
    
            // 체크아웃 버튼 클릭 시
            $('#checkoutBtn').on('click', function(event) {
                // saveCartDataToSession 함수를 호출하고, 성공했을 때만 페이지 이동
                if (!saveCartDataToSession()) {
                    event.preventDefault(); // 데이터 저장에 실패하면 페이지 이동을 막음
                }
            });
    
        });
    </script>
    
</th:block>

<th:block layout:fragment="jsFile">
</th:block>

<th:block layout:fragment="jsScript">
    <!-- <script>
        // 홈 페이지 전용 JavaScript 코드
        console.log("홈 페이지 스크립트 실행!");
    </script> -->
</th:block>

</body>
</html>