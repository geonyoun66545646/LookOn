<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{customer/layout/layoutMain}">
<head>
<title>통합 신고하기</title>
<link rel="stylesheet"
	th:href="@{/maincss/assets/customcustomercss/reports.css}">

</head>


<th:block layout:fragment="contents">
	<div class="container">
		<div class="reports-receive-container">

			<h2>통합 신고하기</h2>
			<p class="description">신고하시려는 대상 유형과 사유를 선택하고 내용을 상세히 기재해주세요. 모든
				신고는 신중하게 검토됩니다.</p>

			<form id="reportForm">
				<!-- 이 div에 th:if 조건을 추가합니다 -->
				<div class="form-group full-width"
					th:if="${session.loginUser != null}">
					<div class="form-field full-width">
						<label>신고하는 계정</label>
						<!-- 이제 이 부분은 th:if 조건 안에서만 렌더링되므로 안전합니다. -->
						<input type="text"
							th:value="${session.loginUser.userNcnm} + ' (ID: ' + ${session.loginUser.userLgnId} + ')'"
							readonly>
						<!-- 
            참고: th:data-user-no 속성은 우리가 JavaScript에서 더 이상 사용하지 않기로 했으므로,
            코드를 더 깔끔하게 하기 위해 지워도 괜찮습니다. 하지만 그냥 둬도 문제는 없습니다.
            -->
					</div>
				</div>

				<div class="form-field full-width">
					<label for="reportType" class="required">신고 대상 유형</label> <select
						id="reportType" name="reportType" required>
						<option value="">-- 신고 대상 유형을 선택하세요 --</option>
					</select>
				</div>

				<div id="contentReportFields" class="form-group full-width">
					<div class="form-field full-width">
						<label for="targetContentId" class="required">대상 링크 또는 ID</label>
						<input type="text" id="targetContentId" name="targetContentId"
							placeholder="신고할 게시글/댓글/상품의 URL을 입력하거나 ID를 입력하세요.">
					</div>
				</div>

				<div id="userReportFields" class="form-group full-width">
					<div class="form-field full-width">
						<label for="targetUserId" class="required">신고 대상 사용자
							ID/닉네임</label> <input type="text" id="targetUserId" name="targetUserId"
							placeholder="신고할 사용자의 ID 또는 닉네임을 입력하세요.">
					</div>
				</div>

				<div class="form-field full-width">
					<label for="reportReason" class="required">신고 사유</label> <select
						id="reportReason" name="reportReason" required>
						<option value="">-- 신고 사유를 선택하세요 --</option>
					</select>

				</div>
				<div class="form-group full-width">
					<div class="form-field full-width">
						<label for="detailReason" class="required">상세 신고 내용</label>
						<textarea id="detailReason" name="detailReason" rows="6"
							placeholder="신고 내용을 최대한 자세히 설명해주세요. (예: 어떤 내용이 문제인지, 언제 발생했는지 등)"></textarea>
					</div>
				</div>

				<div id="fileAttachmentField" class="form-group full-width">
					<div class="form-field full-width">
						<label for="evidenceFile">첨부 파일 (선택)</label> <input type="file"
							id="evidenceFile" name="evidenceFile" accept="image/*, .pdf">
						<small style="color: #888; display: block; margin-top: 5px;">스크린샷
							등 관련 증거 자료를 첨부해주세요. (이미지, PDF 파일만 허용)</small>
					</div>
				</div>

				<button type="submit" class="submit-btn">신고 접수 →</button>
				<button type="button" class="cancel-btn">취소</button>
			</form>

			<div class="info-message">
				<p>
					<strong>참고:</strong> 신고 접수 후 검토에는 영업일 기준 3~5일이 소요될 수 있습니다. 신고 내용은
					관리자에 의해 신중하게 검토됩니다.
				</p>
			</div>
			<div class="info-message warning">
				<p>
					<strong>주의:</strong> 허위 신고는 다른 사용자들에게 피해를 줄 수 있으며, 서비스 이용에 제한이 있을 수
					있습니다.
				</p>
			</div>
		</div>
	</div>

</th:block>


<th:block layout:fragment="jsScript">
	<script th:inline="javascript">
/*<![CDATA[*/
document.addEventListener('DOMContentLoaded', function() {

    // [1. 추가된 인증 체크 로직]
    // 페이지 로드 시, 가장 먼저 로그인 상태를 확인합니다.
    fetch('/api/customer/reports/check-auth')
        .then(response => {
            if (response.status === 401) { // 401 Unauthorized 응답을 받으면
                // 비로그인 상태로 간주하고 SweetAlert 실행
                Swal.fire({
                    icon: 'warning',
                    title: '로그인 필요',
                    text: '신고 기능은 로그인 후 이용 가능합니다.',
                    confirmButtonText: '확인'
                }).then(() => {
                    // 확인 버튼 클릭 시 로그인 페이지로 이동
                    window.location.href = '/';
                });
                // 아래의 다른 스크립트들이 실행되지 않도록 에러를 발생시켜 중단시킵니다.
                throw new Error('Not Authenticated');
            }
            // 인증된 사용자면 조용히 통과
            console.log("사용자 인증 완료. 페이지 기능을 활성화합니다.");
        })
        .catch(error => {
            // 인증 실패 또는 네트워크 에러 시, 이후 스크립트 실행을 막기 위함
            // SweetAlert는 then()에서 이미 처리했으므로, 여기선 콘솔에만 기록합니다.
            console.error(error.message);
        });

    // 주요 DOM 요소 선택
    const reportTypeSelect = document.getElementById('reportType');
    const reportReasonSelect = document.getElementById('reportReason');
    const contentReportFields = document.getElementById('contentReportFields');
    const userReportFields = document.getElementById('userReportFields');
    const reportForm = document.getElementById('reportForm');

    // [페이지 로드 시 실행] 신고 대상 유형 목록을 동적으로 불러오기
    fetch('/api/customer/reports/target-types')
        .then(response => response.json())
        .then(types => {
            const typeNames = {
                'POST': '게시글',
                'COMMENT': '댓글',
                'PRODUCT': '상품',
                'USER': '사용자 계정'
            };
            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = typeNames[type] || type;
                reportTypeSelect.appendChild(option);
            });
        })
        .catch(error => console.error('신고 대상 유형 목록 로딩 실패:', error));

    // 초기 상태: 입력 필드 숨기기
    contentReportFields.style.display = 'none';
    userReportFields.style.display = 'none';

    // 함수: 신고 사유 목록을 서버에서 가져와 업데이트 (변경 없음)
    function updateReportReasons(targetType) {
        while (reportReasonSelect.options.length > 1) {
            reportReasonSelect.remove(1);
        }
        if (!targetType) return;
        fetch(`/api/customer/reports/reasons/${targetType}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('서버에서 신고 사유를 불러오는데 실패했습니다.');
                }
                return response.json();
            })
            .then(reasons => {
                reasons.forEach(reason => {
                    const option = document.createElement('option');
                    option.value = reason.dclrRsnCd;
                    option.textContent = reason.dclrRsnCn;
                    reportReasonSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error fetching report reasons:', error);
                Swal.fire('오류', '신고 사유 목록을 불러올 수 없습니다.', 'error');
            });
    }

    // 이벤트 리스너: 신고 대상 유형 변경 시 (변경 없음)
    reportTypeSelect.addEventListener('change', function() {
        const selectedValue = this.value;
        userReportFields.style.display = (selectedValue === 'USER') ? 'block' : 'none';
        contentReportFields.style.display = (selectedValue && selectedValue !== 'USER') ? 'block' : 'none';
        updateReportReasons(selectedValue);
    });

    // 이벤트 리스너: 폼 제출 시
    reportForm.addEventListener('submit', function(event) {
        event.preventDefault();
        try {
            // [2. 수정된 데이터 생성 로직]
            // 신고자 번호(dclrUserNo)는 더 이상 프론트에서 보내지 않습니다.
            const reportData = {
                dclrTrgtTypeCd: reportTypeSelect.value,
                dclrRsnCd: reportReasonSelect.value,
                dtlDclrRsnCn: document.getElementById('detailReason').value,
                dclrTrgtUserNo: (reportTypeSelect.value === 'USER') ? document.getElementById('targetUserId').value : null,
                dclrTrgtContsId: (reportTypeSelect.value && reportTypeSelect.value !== 'USER') ? document.getElementById('targetContentId').value : null
            };

            fetch('/api/customer/reports', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(reportData)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    Swal.fire({ title: '접수 완료', text: result.message, icon: 'success' })
                        .then(() => { window.location.href = '/customer/myReports'; });
                } else {
                    Swal.fire('오류 발생', result.message, 'error');
                }
            })
            .catch(error => {
                console.error('Fetch 에러 발생:', error);
                Swal.fire('네트워크 오류', '서버와 통신 중 문제가 발생했습니다.', 'error');
            });

        } catch (e) {
            console.error('데이터 수집 중 심각한 에러 발생:', e);
        }
    });
});
/*]]>*/
</script>
</th:block>

</html>