<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org/"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{customer/layout/layoutMain}">
<head>
    <title>회원정보 관리</title>

	<link rel="stylesheet" th:href="@{/maincss/assets/customcustomercss/customerEditInfo.css}" />
    
</head>
<body>
    <th:block layout:fragment="contents">
        <main class="main profile-management-page">
            <div class="container">
                <!-- 1. 페이지 상단 타이틀 -->
                <div class="page-title-area">
                    <h2>회원정보 관리</h2>
                    <p class="breadcrumbs">HOME > MY PAGE > 회원정보 관리</p>
                </div>

                <!-- 2. 메인 컨텐츠 영역 (사이드바 + 컨텐츠) -->
                <div class="profile-container">
                    
                    <!-- 2-1. 왼쪽 사이드 메뉴 -->
                    <aside class="profile-sidebar">
                        <ul>
                            <li class="active"><a href="#edit-info">회원정보 수정</a></li>
                            <li><a href="#manage-profile">프로필 관리</a></li>
                            <li><a href="#security-settings">보안 설정</a></li>
                        </ul>
                    </aside>

                    <!-- 2-2. 오른쪽 컨텐츠 영역 -->
                    <div class="profile-content">

                        <!-- [탭 1] 회원정보 수정 (기본으로 보임) -->
                        <div id="edit-info" class="tab-pane active">
                            <h3>회원정보 수정</h3>
                            <form class="profile-form">
                                <div class="form-group">
                                    <label>아이디</label>
                                    <input type="text" id="userId" readonly>
                                </div>
                                <div class="form-group">
                                    <label>이름</label>
                                    <input type="text" id="userName">
                                </div>
                                <div class="form-group">
                                    <label for="userEmail">이메일</label>
								    <input type="email" class="form-control" id="userEmail" name="emlAddr">
								    <p class="error-message" id="emailError" style="color: red; display: none;"></p>
                                </div>
                                <div class="form-group">
                                    <label>생년월일</label>
                                    <input type="email" id="userBrdt" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="userTelNo">전화번호</label>
                                    <input type="text" class="form-control" id="userTelNo" name="telno">
    								<p class="error-message" id="telError" style="color: red; display: none;"></p>
                                </div>
                                <div class="form-group">
                                    <label>주소</label>
                                    <div class="address-group">
                                        <input type="text" id="userZipCode" placeholder="우편번호" readonly>
                                        <button type="button">우편번호 찾기</button>
                                    </div>
                                    <input type="text" id="userAddress" placeholder="기본 주소" readonly>
                                    <input type="text" id="userDetailAddress" placeholder="상세 주소를 입력하세요">
                                </div>
                                <div class="form-actions">
                                    <button type="submit" class="btn-primary">수정하기</button>
                                </div>
                            </form>
                        </div>

                        <!-- [탭 2] 프로필 관리 -->
                        <div id="manage-profile" class="tab-pane">
                            <h3>프로필 관리</h3>
                            <form id="profile-update-form" class="profile-form" enctype="multipart/form-data">
                                <div class="form-group">
                                    <label>프로필 사진</label>
							            <img id="profileImagePreview" src="" style="display: none; width: 100px;">
							            <input type="file" id="profileImageInput" accept="image/*">
							        </div>
							
							        <!-- 닉네임 -->
							        <div class="form-group">
							            <label>닉네임 *</label>
							            <input type="text" id="userNickname" required>
							            <span class="error-text" id="nicknameError"></span>
							        </div>
							
							        <!-- 자기소개 -->
							        <div class="form-group">
							            <label>자기소개</label>
							            <textarea id="userSelfIntro" rows="3"></textarea>
							        </div>
							        <button type="submit" class="btn-primary">저장하기</button>
                            </form>
                        </div>

                        <!-- [탭 3] 보안 설정 -->
                        <div id="security-settings" class="tab-pane">
						    <h3>보안 설정</h3>
						    <form id="password-change-form" class="profile-form">
						        <div class="form-group">
						            <label for="currentPassword">현재 비밀번호 <span class="required-star">*</span></label>
						            <input type="password" id="currentPassword" name="currentPassword">
						            <span class="error-message" id="currentPasswordError"></span> <!-- 비워둡니다 -->
						        </div>
						        <div class="form-group">
						            <label for="newPassword">새 비밀번호 <span class="required-star">*</span></label>
						            <input type="password" id="newPassword" name="newPassword">
						            <span class="error-message" id="newPasswordError"></span> <!-- 비워둡니다 -->
						        </div>
						        <div class="form-group">
						            <label for="confirmNewPassword">새 비밀번호 확인 <span class="required-star">*</span></label>
						            <input type="password" id="confirmNewPassword" name="confirmNewPassword">
						            <span class="error-message" id="confirmNewPasswordError"></span> <!-- 비워둡니다 -->
						        </div>
						        <hr>
						        <div class="form-actions">
						            <button type="submit" class="btn-primary" id="changePasswordBtn">변경사항 저장</button>
						        </div>
						    </form>
						</div>                   
                	</div>
                </div>
            </div>
        </main>
    </th:block>

    <!-- ======================================================== -->
    <!--            ↓↓↓ editProfile.html 맨 아래 ↓↓↓           -->
    <!-- ======================================================== -->
    
    <!-- 1. 이 페이지에서만 필요한 추가 JS 파일 (우편번호 찾기 API) -->
    <th:block layout:fragment="jsFile">
        <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    </th:block>

    <!-- 2. 이 페이지에서만 실행될 직접 작성한 스크립트 -->
    <th:block layout:fragment="jsScript">
        <script>
        const loadMyInfo = () => {
            $.ajax({
                type: 'GET',
                url: '/api/v1/users/me',
                dataType: 'json'
            })
            .done(userInfo => {
                console.log("사용자 정보 로드 성공:", userInfo);

                // [탭 1] 회원정보 수정 폼 채우기
                $('#userId').val(userInfo.userLgnId);
                $('#userName').val(userInfo.userNm);
                $('#userEmail').val(userInfo.emlAddr);
                $('#userTelNo').val( formatTelno(userInfo.telno) );
                $('#userZipCode').val(userInfo.zipCd);
                $('#userAddress').val(userInfo.addr);
                $('#userDetailAddress').val(userInfo.daddr);
                $('#userBrdt').val(userInfo.userBrdt?.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3'));

                // [탭 2] 프로필 관리 폼 채우기
                $('#userNickname').val(userInfo.userNcnm);
                $('#userSelfIntro').val(userInfo.selfIntroCn);

                // 프로필 이미지 설정
                if (userInfo.prflImg) {
                    $('#profileImagePreview').attr('src', userInfo.prflImg);
                } else {
                    $('#profileImagePreview').attr('src', '/images/default-profile.png');
                }
                
                // 초기 데이터 유효성 검사
                validateEmail(userInfo.emlAddr);
                validateTelno(userInfo.telno);
            })
            .fail(xhr => {
                if (xhr.status === 401) {
                    alert('로그인 후 이용해주세요.');
                    window.location.href = '/customer/login'; 
                } else {
                    alert('정보를 불러오는 중 오류가 발생했습니다.');
                    console.error("Error:", xhr.status, xhr.statusText);
                }
            });
        };
        
        function formatTelno(telno) {
            if (!telno) return ''; // 값이 없으면 빈 문자열 반환

            // 1. 입력값에서 모든 하이픈을 먼저 제거합니다.
            // (예: '010-1111-2222' -> '01011112222', '01011112222' -> '01011112222')
            const digitsOnly = telno.replace(/-/g, '');

            // 2. 숫자가 11자리일 경우에만 하이픈을 다시 추가합니다.
            if (digitsOnly.length === 11) {
                return digitsOnly.replace(/(\d{3})(\d{4})(\d{4})/, '$1-$2-$3');
            }

            // 3. 11자리가 아니거나 다른 예외적인 경우, 원래 받은 값을 그대로 반환합니다.
            return telno;
        }

        function searchZipCode() {
            new daum.Postcode({
                oncomplete: function(data) {
                    $('#userZipCode').val(data.zonecode);
                    $('#userAddress').val(data.roadAddress || data.jibunAddress);
                    $('#userDetailAddress').focus();
                }
            }).open();
        }

        function validateEmail(email) {
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const $error = $('#emailError');
            if (!email) { // 1. 값이 비어있는지 먼저 확인
                $error.text("이메일을 입력해주세요.").show();
                return false;
            } else if (!regex.test(email)) { // 2. 형식이 맞는지 확인
                $error.text("올바른 이메일 형식이 아닙니다.").show();
                return false;
            } else {
                $error.hide();
                return true;
            }
        }

        // 제안: 연락처 유효성 검사 함수
        function validateTelno(telno) {
            const regex = /^010-?\d{3,4}-?\d{4}$/;
            const $error = $('#telError');
            if (!telno) { // 1. 값이 비어있는지 먼저 확인
                $error.text("휴대폰 번호를 입력해주세요.").show();
                return false;
            } else if (!regex.test(telno)) { // 2. 형식이 맞는지 확인
                $error.text("휴대폰 번호 형식(010-1234-5678)을 확인해주세요.").show();
                return false;
            } else {
                $error.hide();
                return true;
            }
        }

        function updateUserInfo(e) {
            e.preventDefault();
            
            const userName = $('#userName').val();
            let isNameValid = true;
            if (!userName) {
                alert('이름은 필수 항목입니다.'); // 간단한 alert 또는 전용 에러 메시지 공간 활용
                $('#userName').focus();
                isNameValid = false;
            }
            
            const isEmailValid = validateEmail($('#userEmail').val());
            const isTelValid = validateTelno($('#userTelNo').val());

            // 모든 유효성 검사를 통과했는지 최종 확인
            if (!isNameValid || !isEmailValid || !isTelValid) {
                return;
            }
            
            const requestData = {
                userNm: $('#userName').val(),
                emlAddr: $('#userEmail').val(),
                telno: $('#userTelNo').val(),
                zipCd: $('#userZipCode').val(),
                addr: $('#userAddress').val(),
                daddr: $('#userDetailAddress').val()
            };

            $.ajax({
                type: 'PUT',
                url: '/api/v1/mypage/info',
                contentType: 'application/json',
                data: JSON.stringify(requestData)
            })
            .done(response => {
                alert('회원정보가 성공적으로 수정되었습니다.');
                loadMyInfo();
            })
            .fail(xhr => {
			    // 1. 에러 메시지 영역을 일단 모두 숨깁니다.
			    $('#emailError').hide();
			    $('#telError').hide();
			
			    // 2. 서버로부터 받은 에러 응답 본문(JSON)을 가져옵니다.
			    const response = xhr.responseJSON;
			    
			    // 3. 409 Conflict 에러(중복 에러)일 경우에만 특별 처리합니다.
			    if (xhr.status === 409 && response && response.message) {
			        const message = response.message;
			        
			        // 에러 메시지에 '이메일' 키워드가 포함되어 있으면
			        if (message.includes('이메일')) {
			            // 이메일 입력창 아래의 p 태그에 에러 메시지를 넣고 보여줍니다.
			            $('#emailError').text(message).show();
			        } 
			        // 에러 메시지에 '연락처' 키워드가 포함되어 있으면
			        else if (message.includes('연락처')) {
			            // 연락처 입력창 아래의 p 태그에 에러 메시지를 넣고 보여줍니다.
			            $('#telError').text(message).show();
			        } 
			        // 그 외의 경우 (만약을 대비)
			        else {
			            alert('오류: ' + message);
			        }
			    } 
			    // 4. 409가 아닌 다른 모든 서버 에러(예: 500)는 기존처럼 alert으로 처리합니다.
			    else {
			        alert('오류: ' + (response?.message || '정보 수정에 실패했습니다. 잠시 후 다시 시도해주세요.'));
			    }
			})
        }

        function updateProfileInfo(e) {
            e.preventDefault();
            const formData = new FormData(document.getElementById('profile-update-form'));

            $.ajax({
                type: 'PUT',
                url: '/api/v1/mypage/profile',
                data: formData,
                processData: false,
                contentType: false 
            })
            .done(response => {
                alert('프로필이 성공적으로 저장되었습니다.');
                loadMyInfo(); // 수정 후 최신 정보 다시 로드
            })
            .fail(xhr => {
                const response = xhr.responseJSON;
                alert('오류: ' + (response?.message || '프로필 저장에 실패했습니다.'));
            });
        }
        const showFeedback = (element, message, isValid) => {
            element.text(message).css('color', isValid ? 'green' : 'red');
            // 에러 메시지는 항상 보여야 하므로 .show()를 추가합니다.
            if (message) element.show(); else element.hide(); 
        };

        // 비밀번호 정책 정규식 (8~20자, 영문/숫자/특수문자(!@#$%^&*()) 각각 1개 이상 포함)
        const passwordRegex = /^(?=.*[a-zA-Z])(?=.*\d)(?=.*[!@#$%^&*()])[a-zA-Z\d!@#$%^&*()]{8,20}$/;

        // 새 비밀번호 입력 필드의 실시간 유효성 검사
        $('#newPassword').on('keyup blur', function() { // keyup과 blur 이벤트에 모두 반응
            const newPassword = $(this).val();
            const $errorElement = $('#newPasswordError');
            
            if (newPassword === '') {
                showFeedback($errorElement, '', true); // 비어있으면 메시지 숨김
                return;
            }

            if (!passwordRegex.test(newPassword)) {
                showFeedback($errorElement, '8~20자, 영문/숫자/특수문자(!@#$%^&*()) 조합', false);
            } else {
                showFeedback($errorElement, '안전', true);
            }

            // 새 비밀번호가 변경될 때마다 확인 비밀번호도 다시 검사
            $('#confirmNewPassword').trigger('keyup');
        });

        // 새 비밀번호 확인 입력 필드의 실시간 유효성 검사
        $('#confirmNewPassword').on('keyup blur', function() {
            const newPassword = $('#newPassword').val();
            const confirmNewPassword = $(this).val();
            const $errorElement = $('#confirmNewPasswordError');

            if (confirmNewPassword === '') {
                showFeedback($errorElement, '', true); // 비어있으면 메시지 숨김
                return;
            }

            if (newPassword !== confirmNewPassword) {
                showFeedback($errorElement, '새 비밀번호와 일치하지 않습니다.', false);
            } else {
                showFeedback($errorElement, '일치', true);
            }
        });

        // 비밀번호 변경 기능 (기존 폼 제출 시 최종 검사 및 AJAX 요청)
        function changePassword(e) {
            e.preventDefault(); // 기본 폼 제출 동작 방지

            // 모든 에러 메시지 초기화 (실시간 검사 메시지도 초기화)
            $('.error-message').hide().text('');

            const currentPassword = $('#currentPassword').val();
            const newPassword = $('#newPassword').val();
            const confirmNewPassword = $('#confirmNewPassword').val();

            let isValid = true; // 최종 유효성 검사 성공 여부

            // 1. 현재 비밀번호 입력 여부 검사
            if (!currentPassword) {
                $('#currentPasswordError').text('현재 비밀번호를 입력해주세요.').show();
                isValid = false;
            }
            // 2. 새 비밀번호 입력 여부 및 길이/정책 검사 (실시간 검사와 중복되지만 최종 확인)
            if (!newPassword) {
                $('#newPasswordError').text('새 비밀번호를 입력해주세요.').show();
                isValid = false;
            } else if (!passwordRegex.test(newPassword)) {
                $('#newPasswordError').text('비밀번호는 8~20자이며, 영문, 숫자, 특수문자(!@#$%^&*())를 각각 1개 이상 포함해야 합니다.').show();
                isValid = false;
            }

            // 3. 새 비밀번호 확인 입력 여부 및 일치 검사 (실시간 검사와 중복되지만 최종 확인)
            if (!confirmNewPassword) {
                $('#confirmNewPasswordError').text('새 비밀번호 확인을 입력해주세요.').show();
                isValid = false;
            } else if (newPassword !== confirmNewPassword) {
                $('#confirmNewPasswordError').text('새 비밀번호와 확인 비밀번호가 일치하지 않습니다.').show();
                isValid = false;
            }

            // <<< 새롭게 추가된 유효성 검사: 현재 비밀번호와 새 비밀번호가 동일한지 확인
            if (currentPassword && newPassword && currentPassword === newPassword) {
                $('#newPasswordError').text('현재 비밀번호와 다른 비밀번호를 입력해주세요.').show();
                isValid = false;
            }
            // >>>

            // 클라이언트 측 최종 유효성 검사 실패 시 함수 종료
            if (!isValid) {
                return;
            }

            // 요청 데이터 객체 생성
            const requestData = {
                currentPassword: currentPassword,
                newPassword: newPassword,
                confirmNewPassword: confirmNewPassword
            };

            // AJAX PUT 요청으로 백엔드 API 호출
            $.ajax({
                type: 'PUT',
                url: '/api/v1/mypage/security/password',
                contentType: 'application/json',
                data: JSON.stringify(requestData)
            })
            .done(response => {
                alert(response.message);
                $('#currentPassword, #newPassword, #confirmNewPassword').val('');
                // 성공 후 실시간 유효성 검사 메시지도 초기화
                $('#newPasswordError, #confirmNewPasswordError').hide().text(''); 
            })
            .fail(xhr => {
                const response = xhr.responseJSON;
                let errorMessage = '비밀번호 변경에 실패했습니다. 알 수 없는 오류.';

                if (response && response.message) {
                    errorMessage = response.message;
                } else if (xhr.status === 401) {
                    errorMessage = '세션이 만료되었거나 로그인 정보가 유효하지 않습니다. 다시 로그인해주세요.';
                    setTimeout(() => window.location.href = '/customer/login', 1500); 
                } else if (xhr.status === 400) {
                    errorMessage = response?.message || '입력값이 올바르지 않습니다.';
                } else if (xhr.status === 500) {
                    errorMessage = '서버에서 오류가 발생했습니다. 잠시 후 다시 시도해주세요.';
                }
                alert('오류: ' + errorMessage);
                console.error("비밀번호 변경 실패:", xhr.status, xhr.statusText, response);
            });
        }

        // 페이지 초기화 및 이벤트 바인딩
        $(document).ready(function() {
            // [회원정보 수정 탭] 이벤트 바인딩
            $('#userEmail').on('keyup blur', function() { validateEmail($(this).val()); });
			$('#userTelNo').on('keyup blur', function() { validateTelno($(this).val()); });
            $('.address-group button').on('click', searchZipCode);
            $('#edit-info form').on('submit', updateUserInfo);

            // [프로필 관리 탭] 이벤트 바인딩
            $('#profile-update-form').on('submit', updateProfileInfo);
            
            // 파일 선택 시 이미지 미리보기 기능
            $('#profileImageInput').on('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        $('#profileImagePreview').attr('src', e.target.result);
                    }
                    reader.readAsDataURL(file);
                }
            });

            // [보안 설정 탭] 이벤트 바인딩 (새로 추가) <<< 이 한 줄이 핵심입니다!
            $('#password-change-form').on('submit', changePassword);

            // 사이드바 탭 전환 이벤트
            $('.profile-sidebar a').on('click', function(e) {
                e.preventDefault();
                const targetId = $(this).attr('href');
                $('.profile-sidebar li, .tab-pane').removeClass('active');
                $(this).parent().addClass('active');
                $(targetId).addClass('active');
            });

            // URL 파라미터에 따라 초기 탭 설정
            function activateTabFromUrl() {
                const urlParams = new URLSearchParams(window.location.search);
                const tabId = urlParams.get('tab');
                if (tabId) {
                    // click() 대신 클래스를 직접 조작하여 불필요한 이벤트 발생 방지
                    $('.profile-sidebar li, .tab-pane').removeClass('active');
                    $(`.profile-sidebar a[href="#${tabId}"]`).parent().addClass('active');
                    $(`#${tabId}`).addClass('active');
                } else {
                    // 기본 탭 활성화
                    $('.profile-sidebar li:first-child, .tab-pane:first-child').addClass('active');
                }
            }

            // 초기 실행
            loadMyInfo();
            activateTabFromUrl();
        });
        </script>
    </th:block>
</body>
</html>