<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{customer/layout/layoutMain}">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>내 쿠폰 페이지 - 페이징 예시</title>

<link rel="stylesheet"
	th:href="@{/maincss/assets/customcustomercss/coupons.css}">
</head>



<body>

	<th:block layout:fragment="contents">

		<div class="container">
			<div class="member-coupon">
				<div class="member-coupon__top">
					<nav id="couponTabs" class="member-coupon__1depth">
						<a href="#" id="my-coupons-tab" class="gtm-catch-click is-active">
							보유 쿠폰 <span id="my-coupons-count"></span>
						</a> <a href="#" id="available-coupons-tab" class="gtm-catch-click">
							쿠폰 받기 <span id="available-coupons-count"></span>
						</a>
					</nav>
				</div>

				<div class="member-coupon__search">
					<div class="custom-input-form">
						<input type="text" id="coupon-search-input"
							placeholder="쿠폰명으로 검색해보세요." class="custom-input-form__input"
							value="">
						<div class="custom-input-form__util">
							<button id="coupon-search-btn"
								class="custom-input__button-search" type="button">
								<svg width="20" height="20" viewBox="0 0 20 20" fill="none"
									xmlns="http://www.w3.org/2000/svg">
                            <circle cx="8.5" cy="8.5" r="5.5"
										stroke="#8A8A8A"></circle>
                            <path d="M12.5 12.5L17 17" stroke="#8A8A8A"></path>
                        </svg>
							</button>
						</div>
					</div>
				</div>

				<div class="member-coupon__util">
					<div id="coupon-total-count" class="member-coupon__total">전체
						0개</div>
					<div class="member-coupon__sort">
						<select id="coupon-sort-order" class="form-select form-select-sm">
							<option value="recommended" selected>추천순</option>
							<option value="recent">최신순</option>
							<option value="expiry">마감임박순</option>
							<option value="rate">할인율순</option>
						</select>
					</div>
				</div>

				<div class="coupon-list-container">
					<ul id="coupon-list-container" class="coupon-list">
					</ul>
				</div>

				<div class="pagination-container mt-5"></div>
			</div>
		</div>

	</th:block>

	<th:block layout:fragment="jsFile">
	</th:block>

	<th:block layout:fragment="jsScript">
		<script th:inline="javascript">
/* <![CDATA[ */

// 페이지의 모든 HTML 요소가 로드된 후에 스크립트를 실행합니다.
document.addEventListener('DOMContentLoaded', function() {

    // ===================================================================
    // 1. 상태 및 요소 관리
    // ===================================================================

    // 현재 페이지의 모든 상태(탭, 검색어, 정렬, 페이지)를 관리하는 객체
	
	let currentState = {
	    tab: 'my',
	    keyword: '',
	    sortOrder: 'recommended', // ★★★ 기본 정렬값을 'recommended'로 수정
	    page: 1
	};

    // 자주 사용하는 HTML 요소들을 미리 찾아 변수에 저장 (성능 향상)
    const tabContainer = document.getElementById('couponTabs');
    const couponListContainer = document.getElementById('coupon-list-container');
    const paginationContainer = document.querySelector('.pagination-container');
    const searchInput = document.getElementById('coupon-search-input');
    const searchBtn = document.getElementById('coupon-search-btn');
    const sortOrderSelect = document.getElementById('coupon-sort-order');
    const totalCountEl = document.getElementById('coupon-total-count');
    const myCouponsCountEl = document.getElementById('my-coupons-count');
    const availableCouponsCountEl = document.getElementById('available-coupons-count');


    // ===================================================================
    // 2. 핵심 로직 함수 (데이터 로딩 및 화면 그리기)
    // ===================================================================

    /**
     * 현재 상태(currentState)를 기반으로 쿠폰 데이터를 로드하는 메인 함수
     */
    function loadCoupons() {
        // 현재 선택된 탭에 따라 API 주소와 화면을 그릴 함수를 결정
        const isMyCouponsTab = currentState.tab === 'my';
        const apiUrl = isMyCouponsTab ? '/api/coupons/my' : '/api/coupons/available';
        const renderFunction = isMyCouponsTab ? renderMyCoupons : renderAvailableCoupons;

        // 서버에 보낼 URL 파라미터를 조합
        const params = new URLSearchParams({
            keyword: currentState.keyword,
            sortOrder: currentState.sortOrder,
            page: currentState.page
        });

        // 데이터를 불러오기 전, 로딩 메시지 표시
        couponListContainer.innerHTML = '<li><p class="text-center p-5">로딩 중...</p></li>';

        // fetch API를 이용한 비동기(AJAX) 요청
        fetch(`${apiUrl}?${params.toString()}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('서버 응답에 문제가 있습니다.');
                }
                return response.json();
            })
            .then(pageData => {
                // 1. 쿠폰 목록 그리기
                renderFunction(couponListContainer, pageData.list);

                // 2. 페이지네이션 그리기 (공용 부품 호출)
                paginationContainer.innerHTML = renderPagination(pageData);

                // 3. 전체 개수 및 탭별 개수 업데이트
                totalCountEl.textContent = `전체 ${pageData.totalCount}개`;
                if (isMyCouponsTab) {
                    myCouponsCountEl.textContent = `(${pageData.totalCount})`;
                } else {
                    availableCouponsCountEl.textContent = `(${pageData.totalCount})`;
                }
            })
            .catch(error => {
                console.error('쿠폰 데이터를 불러오는 중 오류 발생:', error);
                couponListContainer.innerHTML = '<li><p class="text-center p-5">데이터를 불러오는 데 실패했습니다.</p></li>';
            });
    }

    /**
     * '보유 쿠폰' 목록 HTML을 생성하는 함수 (날짜 표시 추가)
     */
    function renderMyCoupons(container, coupons) {
        if (!coupons || coupons.length === 0) {
            container.innerHTML = '<li><p class="text-center p-5">보유한 쿠폰이 없습니다.</p></li>';
            return;
        }
        let html = '';
        coupons.forEach(userCoupon => {
            const coupon = userCoupon.coupon;
            const discount = `${coupon.dscntVl}%`;
            const formattedExpiryDate = coupon.vldEndDt ? new Date(coupon.vldEndDt).toLocaleDateString() : '기한 없음';
            // ▼▼▼ 발급일(cpnGiveDt)을 포맷팅하는 코드 추가 ▼▼▼
            const formattedGiveDate = userCoupon.cpnGiveDt ? new Date(userCoupon.cpnGiveDt).toLocaleDateString() : '';
            const isUsed = userCoupon.useYn;
            if (isUsed) {
                // 이미 사용한 쿠폰일 경우: 클릭 안 되는 비활성화 버튼으로 표시
                html += `
                    <li class="coupon-item is-used">
                        <div class="coupon-details">
                            <span class="coupon-percentage">${discount}</span>
                            <span class="coupon-name">${coupon.cpnNm}</span>
                            <span class="coupon-conditions">
                                ${coupon.minOrdrAmt.toLocaleString()}원 이상 구매 시, 최대 ${coupon.maxDscntAmt.toLocaleString()}원 할인
                            </span>
                            <span class="coupon-period">만료일: ${formattedExpiryDate}</span>
                            <span class="coupon-period">발급일: ${formattedGiveDate}</span>
                        </div>
                        <button class="coupon-download-btn" disabled>사용완료</button>
                    </li>
                `;
            } else {
                // 사용하지 않은 쿠폰일 경우: 결제 페이지로 이동하는 링크(a 태그)로 표시
                html += `
                    <li class="coupon-item">
                        <div class="coupon-details">
                            <span class="coupon-percentage">${discount}</span>
                            <span class="coupon-name">${coupon.cpnNm}</span>
                            <span class="coupon-conditions">
                                ${coupon.minOrdrAmt.toLocaleString()}원 이상 구매 시, 최대 ${coupon.maxDscntAmt.toLocaleString()}원 할인
                            </span>
                            <span class="coupon-period">만료일: ${formattedExpiryDate}</span>
                            <span class="coupon-period">발급일: ${formattedGiveDate}</span>
                        </div>
                        <a href="/order/checkout" class="coupon-download-btn" style="text-decoration: none; display: flex; align-items: center; justify-content: center;">
                            사용하기
                        </a>
                    </li>
                `;
            }
            // ★★★ 수정된 부분 끝 ★★★
        });
        container.innerHTML = html;
    }

    /**
     * '발급 가능 쿠폰' 목록 HTML을 생성하는 함수 (날짜 표시 추가)
     */
    function renderAvailableCoupons(container, coupons) {
        if (!coupons || coupons.length === 0) {
            container.innerHTML = '<li><p class="text-center p-5">발급 가능한 쿠폰이 없습니다.</p></li>';
            return;
        }
        let html = '';
        coupons.forEach(coupon => {
            const discount = `${coupon.dscntVl}%`;
            const formattedExpiryDate = coupon.vldEndDt ? new Date(coupon.vldEndDt).toLocaleDateString() : '기한 없음';
            // ▼▼▼ 발급 시작일(vldBgngDt)을 포맷팅하는 코드 추가 ▼▼▼
            const formattedStartDate = coupon.vldBgngDt ? new Date(coupon.vldBgngDt).toLocaleDateString() : '상시';

            html += `
                <li class="coupon-item">
                    <div class="coupon-details">
                        <span class="coupon-percentage">${discount}</span>
                        <span class="coupon-name">${coupon.cpnNm}</span>
                        <span class="coupon-conditions">
                            ${coupon.minOrdrAmt.toLocaleString()}원 이상 구매 시, 최대 ${coupon.maxDscntAmt.toLocaleString()}원 할인
                        </span>
                        <span class="coupon-period">유효기간: ${formattedExpiryDate}까지</span>
                        <span class="coupon-period">발급 시작일: ${formattedStartDate}</span>
                    </div>
                    <button class="coupon-download-btn" data-coupon-id="${coupon.pblcnCpnId}">쿠폰받기</button>
                </li>
            `;
        });
        container.innerHTML = html;
    }
    
    /**
     * '발급 가능 쿠폰'의 개수만 비동기로 조회하여 화면에 표시하는 함수
     */
    function loadAvailableCouponsCount() {
        // '쿠폰 받기' API에 page=1로 요청해서 전체 개수만 가져옵니다.
        const apiUrl = '/api/coupons/available?page=1';
        
        fetch(apiUrl)
            .then(response => response.json())
            .then(pageData => {
                // 받아온 데이터에서 totalCount만 사용하여 숫자를 업데이트합니다.
                availableCouponsCountEl.textContent = `(${pageData.totalCount})`;
            })
            .catch(error => {
                console.error('발급 가능 쿠폰 개수 조회 오류:', error);
                availableCouponsCountEl.textContent = '(?)';
            });
    }
    
    /**
     * '보유 쿠폰'의 개수만 비동기로 조회하여 화면에 표시하는 함수
     */
    function loadMyCouponsCount() {
        const myCouponsCountEl = document.getElementById('my-coupons-count');
        fetch('/api/coupons/my?page=1') // '보유 쿠폰' API 호출
            .then(response => response.json())
            .then(pageData => {
                myCouponsCountEl.textContent = `(${pageData.totalCount})`;
            })
            .catch(error => console.error('보유 쿠폰 개수 조회 오류:', error));
    }


    // ===================================================================
    // 3. 이벤트 핸들러 바인딩 (사용자 행동 감지 및 처리)
    // ===================================================================

    // 탭 메뉴 클릭 시
    tabContainer.addEventListener('click', function(event) {
        event.preventDefault();
        const clickedTab = event.target.closest('a');
        if (!clickedTab || clickedTab.classList.contains('is-active')) return;

        tabContainer.querySelectorAll('a').forEach(a => a.classList.remove('is-active'));
        clickedTab.classList.add('is-active');

        currentState.tab = clickedTab.id === 'my-coupons-tab' ? 'my' : 'available';
        currentState.page = 1;
        loadCoupons();
    });

    // 검색 버튼 클릭 시
    searchBtn.addEventListener('click', function() {
        currentState.keyword = searchInput.value;
        currentState.page = 1;
        loadCoupons();
    });
    
    // 검색창에서 Enter 키 입력 시
    searchInput.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            searchBtn.click();
        }
    });

    // 정렬 순서 변경 시
    sortOrderSelect.addEventListener('change', function() {
        currentState.sortOrder = this.value;
        currentState.page = 1;
        loadCoupons();
    });

    // 페이지네이션 버튼 클릭 시 (이벤트 위임)
    paginationContainer.addEventListener('click', function(event) {
        const pageLink = event.target.closest('a.page-link');
        if (pageLink && pageLink.dataset.page) {
            event.preventDefault();
            currentState.page = parseInt(pageLink.dataset.page, 10);
            loadCoupons();
        }
    });
    
 // '쿠폰받기' 버튼 클릭 시 (SweetAlert 적용)
    couponListContainer.addEventListener('click', function(event) {
        const downloadBtn = event.target.closest('.coupon-download-btn');
        if (downloadBtn && downloadBtn.dataset.couponId && !downloadBtn.disabled) {
            const couponId = downloadBtn.dataset.couponId;
            
            
     // ★★★ 요청하신 예시 디자인의 SweetAlert 확인 창으로 교체 ★★★
        Swal.fire({
            title: '쿠폰을 발급하시겠습니까?',
            text: "발급 후에는 취소할 수 없습니다!",
            icon: 'question', // 아이콘을 'warning'으로 변경
            showCancelButton: true,
            confirmButtonColor: '#3085d6', // 기본 파란색
            cancelButtonColor: '#d33',    // 기본 빨간색
            confirmButtonText: '네, 발급받을게요!',
            cancelButtonText: '아니요'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/api/coupons/${couponId}/issue`, { method: 'POST' })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => { throw new Error(err.message) });
                        }
                        return response.json();
                    })
                    .then(data => {
                        Swal.fire('발급 완료!', data.message, 'success');
                        
                        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
                        // 1. 현재 보고 있는 '쿠폰 받기' 목록을 다시 불러옵니다.
                        //    이렇게 하면 방금 받은 쿠폰이 목록에서 사라집니다.
                        loadCoupons();
                        
                        // 2. '보유 쿠폰' 탭의 개수도 새로고침해야 하므로,
                        //    보유 쿠폰 개수만 다시 조회하는 함수를 만들어 호출합니다.
                        loadMyCouponsCount(); 
                        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
                    })
                    .catch(error => {
                        Swal.fire('오류 발생', error.message, 'error');
                    });
            }
        });
    }
});
    // ===================================================================
    // 4. 최초 데이터 로딩
    // ===================================================================
    loadCoupons();
    loadAvailableCouponsCount();

});

/* ]]> */
</script>
	</th:block>

</body>


</html>