<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{customer/layout/layoutMain}">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>내 쿠폰 페이지 - 페이징 예시</title>

<link rel="stylesheet"
	th:href="@{/maincss/assets/customcustomercss/coupons.css}">
</head>



<body>

	<th:block layout:fragment="contents">

		<div class="member-coupon">
			<div class="member-coupon__top">
				<nav id="couponTabs" class="member-coupon__1depth">
					<a href="#" id="my-coupons-tab" class="gtm-catch-click is-active">
						보유 쿠폰 <span id="my-coupons-count"></span>
					</a> <a href="#" id="available-coupons-tab" class="gtm-catch-click">
						쿠폰 받기 <span id="available-coupons-count"></span>
					</a>
				</nav>
			</div>

			<div class="member-coupon__search">
				<div class="custom-input-form">
					<input type="text" id="coupon-search-input"
						placeholder="쿠폰명으로 검색해보세요." class="custom-input-form__input"
						value="">
					<div class="custom-input-form__util">
						<button id="coupon-search-btn" class="custom-input__button-search"
							type="button">
							<svg width="20" height="20" viewBox="0 0 20 20" fill="none"
								xmlns="http://www.w3.org/2000/svg">
                            <circle cx="8.5" cy="8.5" r="5.5"
									stroke="#8A8A8A"></circle>
                            <path d="M12.5 12.5L17 17" stroke="#8A8A8A"></path>
                        </svg>
						</button>
					</div>
				</div>
			</div>

			<div class="member-coupon__util">
				<div id="coupon-total-count" class="member-coupon__total">전체
					0개</div>
				<div class="member-coupon__sort">
					<select id="coupon-sort-order" class="form-select form-select-sm">
						<option value="expiry">만료임박순</option>
						<option value="recent">최근발급순</option>
						<option value="rate">할인율순</option>
						<option value="amount">할인가격순</option>
					</select>
				</div>
			</div>

			<div class="coupon-list-container">
				<ul id="coupon-list-container" class="coupon-list">
				</ul>
			</div>

			<div class="pagination-container mt-5"></div>
		</div>

	</th:block>

	<th:block layout:fragment="jsFile">
	</th:block>

<th:block layout:fragment="jsScript">
<script th:inline="javascript">
/* <![CDATA[ */

// 페이지의 모든 HTML 요소가 로드된 후에 스크립트를 실행합니다.
document.addEventListener('DOMContentLoaded', function() {

    // ===================================================================
    // 1. 상태 및 요소 관리
    // ===================================================================

    // 현재 페이지의 모든 상태(탭, 검색어, 정렬, 페이지)를 관리하는 객체
    let currentState = {
        tab: 'my', // 'my'(보유쿠폰) 또는 'available'(쿠폰받기)
        keyword: '',
        sortOrder: 'recent', // 정렬 기본값
        page: 1
    };

    // 자주 사용하는 HTML 요소들을 미리 찾아 변수에 저장 (성능 향상)
    const tabContainer = document.getElementById('couponTabs');
    const couponListContainer = document.getElementById('coupon-list-container');
    const paginationContainer = document.querySelector('.pagination-container');
    const searchInput = document.getElementById('coupon-search-input');
    const searchBtn = document.getElementById('coupon-search-btn');
    const sortOrderSelect = document.getElementById('coupon-sort-order');
    const totalCountEl = document.getElementById('coupon-total-count');
    const myCouponsCountEl = document.getElementById('my-coupons-count');
    const availableCouponsCountEl = document.getElementById('available-coupons-count');


    // ===================================================================
    // 2. 핵심 로직 함수 (데이터 로딩 및 화면 그리기)
    // ===================================================================

    /**
     * 현재 상태(currentState)를 기반으로 쿠폰 데이터를 로드하는 메인 함수
     */
    function loadCoupons() {
        // 현재 선택된 탭에 따라 API 주소와 화면을 그릴 함수를 결정
        const isMyCouponsTab = currentState.tab === 'my';
        const apiUrl = isMyCouponsTab ? '/api/coupons/my' : '/api/coupons/available';
        const renderFunction = isMyCouponsTab ? renderMyCoupons : renderAvailableCoupons;

        // 서버에 보낼 URL 파라미터를 조합
        const params = new URLSearchParams({
            keyword: currentState.keyword,
            sortOrder: currentState.sortOrder,
            page: currentState.page
        });

        // 데이터를 불러오기 전, 로딩 메시지 표시
        couponListContainer.innerHTML = '<li><p class="text-center p-5">로딩 중...</p></li>';

        // fetch API를 이용한 비동기(AJAX) 요청
        fetch(`${apiUrl}?${params.toString()}`)
            .then(response => response.json())
            .then(pageData => {
                // 1. 쿠폰 목록 그리기
                renderFunction(couponListContainer, pageData.list);
                
                // 2. 페이지네이션 그리기 (공용 부품 호출)
                paginationContainer.innerHTML = renderPagination(pageData);

                // 3. 전체 개수 및 탭별 개수 업데이트
                totalCountEl.textContent = `전체 ${pageData.totalCount}개`;
                if (isMyCouponsTab) {
                    myCouponsCountEl.textContent = `(${pageData.totalCount})`;
                } else {
                    availableCouponsCountEl.textContent = `(${pageData.totalCount})`;
                }
            })
            .catch(error => {
                console.error('쿠폰 데이터를 불러오는 중 오류 발생:', error);
                couponListContainer.innerHTML = '<li><p class="text-center p-5">데이터를 불러오는 데 실패했습니다.</p></li>';
            });
    }

    /**
     * '보유 쿠폰' 목록 HTML을 생성하는 함수 (수정본)
     */
    function renderMyCoupons(container, coupons) {
        if (!coupons || coupons.length === 0) {
            container.innerHTML = '<li><p class="text-center p-5">보유한 쿠폰이 없습니다.</p></li>';
            return;
        }
        let html = '';
        coupons.forEach(userCoupon => {
            // ★★★ 중요: userCoupon 안에 들어있는 coupon 객체의 상세 정보를 사용합니다. ★★★
            const coupon = userCoupon.coupon; 
            const discount = coupon.dscntTypeCd === 'RATE' ? `${coupon.dscntVl}%` : `${coupon.dscntVl.toLocaleString()}원`;
            const formattedExpiryDate = userCoupon.indivExpryDt ? new Date(userCoupon.indivExpryDt).toLocaleDateString() : '기한 없음';

            
         // userCoupon.useYn 값(true/false)에 따라 버튼의 텍스트와 비활성화 상태를 동적으로 결정합니다.
            const isUsed = userCoupon.useYn;
            const buttonText = isUsed ? '사용완료' : '사용하기';
            const buttonDisabled = isUsed ? 'disabled' : '';
            
            
            // isUsed 값에 따라 coupon-item에 is-used 클래스를 추가하여 시각적으로 구분합니다.
            html += `
                <li class="coupon-item ${isUsed ? 'is-used' : ''}">
                    <div class="coupon-details">
                        <span class="coupon-percentage">${discount}</span>
                        <span class="coupon-name">${coupon.cpnNm}</span>
                        <span class="coupon-conditions">
                            ${coupon.minOrdrAmt.toLocaleString()}원 이상 구매 시, 최대 ${coupon.maxDscntAmt.toLocaleString()}원 할인
                        </span>
                        <span class="coupon-period">만료일: ${formattedExpiryDate}</span>
                    </div>
                    <button class="coupon-download-btn" ${buttonDisabled}>
                        ${buttonText}
                    </button>
                </li>
            `;
        });
        container.innerHTML = html;
    }

    /**
     * '발급 가능 쿠폰' 목록 HTML을 생성하는 함수 (수정본)
     */
    function renderAvailableCoupons(container, coupons) {
        if (!coupons || coupons.length === 0) {
            container.innerHTML = '<li><p class="text-center p-5">발급 가능한 쿠폰이 없습니다.</p></li>';
            return;
        }
        let html = '';
        coupons.forEach(coupon => {
            const discount = coupon.dscntTypeCd === 'RATE' ? `${coupon.dscntVl}%` : `${coupon.dscntVl.toLocaleString()}원`;
            const formattedExpiryDate = coupon.vldEndDt ? new Date(coupon.vldEndDt).toLocaleDateString() : '기한 없음';
            
            html += `
                <li class="coupon-item">
                    <div class="coupon-details">
                        <span class="coupon-percentage">${discount}</span>
                        <span class="coupon-name">${coupon.cpnNm}</span>
                        <span class="coupon-conditions">
                            ${coupon.minOrdrAmt.toLocaleString()}원 이상 구매 시, 최대 ${coupon.maxDscntAmt.toLocaleString()}원 할인
                        </span>
                        <span class="coupon-period">유효기간: ${formattedExpiryDate}까지</span>
                    </div>
                    <button class="coupon-download-btn" data-coupon-id="${coupon.pblcnCpnId}">쿠폰받기</button>
                </li>
            `;
        });
        container.innerHTML = html;
    }



    // ===================================================================
    // 3. 이벤트 핸들러 바인딩 (사용자 행동 감지 및 처리)
    // ===================================================================

    // 탭 메뉴 클릭 시
    tabContainer.addEventListener('click', function(event) {
        event.preventDefault();
        const clickedTab = event.target.closest('a');
        if (!clickedTab || clickedTab.classList.contains('is-active')) return;

        tabContainer.querySelectorAll('a').forEach(a => a.classList.remove('is-active'));
        clickedTab.classList.add('is-active');

        currentState.tab = clickedTab.id === 'my-coupons-tab' ? 'my' : 'available';
        currentState.page = 1;
        loadCoupons();
    });

    // 검색 버튼 클릭 시
    searchBtn.addEventListener('click', function() {
        currentState.keyword = searchInput.value;
        currentState.page = 1;
        loadCoupons();
    });
    
    // 검색창에서 Enter 키 입력 시
    searchInput.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            searchBtn.click();
        }
    });

    // 정렬 순서 변경 시
    sortOrderSelect.addEventListener('change', function() {
        currentState.sortOrder = this.value;
        currentState.page = 1;
        loadCoupons();
    });

    // 페이지네이션 버튼 클릭 시 (이벤트 위임)
    paginationContainer.addEventListener('click', function(event) {
        const pageLink = event.target.closest('a.page-link');
        if (pageLink && pageLink.dataset.page) {
            event.preventDefault();
            currentState.page = parseInt(pageLink.dataset.page, 10);
            loadCoupons();
        }
    });
    
    // '쿠폰받기' 버튼 클릭 시 (이벤트 위임)
    couponListContainer.addEventListener('click', function(event) {
        const downloadBtn = event.target.closest('.coupon-download-btn');
        if (downloadBtn && downloadBtn.dataset.couponId && !downloadBtn.disabled) {
            const couponId = downloadBtn.dataset.couponId;
            
            if (confirm("쿠폰을 발급받으시겠습니까?")) {
                fetch(`/api/coupons/${couponId}/issue`, { method: 'POST' })
                    .then(response => {
                        if (!response.ok) {
                            // 서버에서 에러 응답이 왔을 때 처리
                            return response.json().then(err => { throw new Error(err.message) });
                        }
                        return response.json();
                    })
                    .then(result => {
                        alert(result.message);
                        // 성공 시 버튼 비활성화
                        downloadBtn.textContent = '발급완료';
                        downloadBtn.disabled = true;
                    })
                    .catch(error => {
                        console.error('쿠폰 발급 오류:', error);
                        alert(error.message || '쿠폰 발급 중 오류가 발생했습니다.');
                    });
            }
        }
    });

    // ===================================================================
    // 4. 최초 데이터 로딩
    // ===================================================================
    loadCoupons();

});

/* ]]> */
</script>
</th:block>

</body>


</html>