<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{admin/layout/layoutMain}">
		
	 <head>
	 	<link rel="stylesheet" th:href="@{/admincss/assets/customadmincss/dashBoard.css}">
	 </head>
	 
	 <!-- 추가할 페이지 contents -->
	 <th:block layout:fragment="contents">
    <main class="main-content">
        <!-- 1. 페이지 제목 -->
        <section class="content-header">
            <h2 class="content-title">대시보드</h2>
        </section>

        <!-- 2. 핵심 현황 대시보드 카드 영역 -->
        <div class="row">
		
		    <!-- 오늘의 매출 카드 -->
		    <div class="col-lg-3">
		        <div class="card card-body mb-4">
		            <a class="text-decoration-none" href="#">
		                <article class="d-flex align-items-start">
		                    <div class="icon-part me-3">
		                        <span class="icon-circle bg-success-light">
		                            <i class="icon material-icons text-success md-monetization_on"></i>
		                        </span>
		                    </div>
		                    <div class="info-part">
		                        <h3 class="card-value" th:text="${#numbers.formatInteger(todayRevenue ?: 0, 0, 'COMMA')} + '원'">0원</h3>
		                        <h6 class="text-muted">오늘의 매출</h6>
		                    </div>
		                </article>
		            </a>
		        </div>
		    </div>
		
		    <!-- [신규] 오늘의 방문자수 카드 -->
		    <div class="col-lg-3">
		        <div class="card card-body mb-4">
		            <a class="text-decoration-none" th:href="@{/adminpage/useradmin/userList}">
		                <article class="d-flex align-items-start">
		                    <div class="icon-part me-3">
		                        <!-- 아이콘과 색상 변경 -->
		                        <span class="icon-circle bg-info-light">
		                            <i class="icon material-icons text-info md-visibility"></i>
		                        </span>
		                    </div>
		                    <div class="info-part">
		                        <!-- 변수명과 단위 변경 -->
		                        <h3 class="card-value" th:text="${(todayVisitors ?: 0)} + '명'">0명</h3>
		                        <h6 class="text-muted">오늘 방문자수</h6>
		                    </div>
		                </article>
		            </a>
		        </div>
		    </div>
		
		    <!-- 신규 가입 카드 -->
		    <div class="col-lg-3">
		        <div class="card card-body mb-4">
		            <a class="text-decoration-none" th:href="@{/adminpage/useradmin/userList}">
		                <article class="d-flex align-items-start">
		                    <div class="icon-part me-3">
		                        <span class="icon-circle bg-primary-light">
		                            <i class="icon material-icons text-primary md-person_add"></i>
		                        </span>
		                    </div>
		                    <div class="info-part">
		                        <h3 class="card-value" th:text="${(newUserCount ?: 0)} + '명'">0명</h3>
		                        <h6 class="text-muted">신규 가입</h6>
		                    </div>
		                </article>
		            </a>
		        </div>
		    </div>
		    
		    <!-- [통합] 처리할 업무 카드 -->
		    <div class="col-lg-3">
		        <div class="card card-body mb-4">
		            <a class="text-decoration-none" href="#taskList"> <!-- 페이지 내 '확인 필요 항목'으로 이동 -->
		                <article class="d-flex align-items-start">
		                    <div class="icon-part me-3">
		                        <span class="icon-circle bg-danger-light">
		                            <i class="icon material-icons text-danger md-playlist_add_check"></i>
		                        </span>
		                    </div>
		                    <div class="info-part">
		                        <!-- 문의+신고+상점승인+상품승인 등 모든 대기 건수의 합 -->
		                        <h3 class="card-value" th:text="${(totalTasks ?: 0)} + '건'">0건</h3>
		                        <h6 class="text-muted">처리할 업무</h6>
		                    </div>
		                </article>
		            </a>
		        </div>
		    </div>
		
		</div> <!-- row end// -->

        <!-- ================== [새로 추가된 영역] ================== -->
        <div class="row">
            <!-- 3. [수정] 월별 매출 통계 차트 -->
            <div class="col-lg-8">
			    <div class="card card-body mb-4">
			        <h5 class="card-title">월별 매출 통계 (수수료 수익)</h5>
			        <canvas id="salesChart" height="150"></canvas>
			    </div>
			</div>
            
            <!-- 4. 최근 문의 목록 -->
            <div class="col-lg-4">
			    <div class="card card-body mb-4">
			        <h5 class="card-title">확인 필요 항목</h5>
			        <div class="task-list">
			            <!-- 
			                Controller에서 각 항목별 count와 link를 담은 List<TaskItemDTO> 같은 객체를 전달받아
			                th:each로 반복 출력합니다. 
			            -->
			
			            <!-- 예시: 처리 대기 항목들 -->
			            <a th:href="@{/admin/inquiry/adminInquiryList}" class="task-item" th:if="${pendingInquiries > 0}">
			                <div class="item-info">
			                    <i class="icon material-icons text-warning md-contact_support"></i>
			                    <span>신규 문의</span>
			                </div>
			                <span class="badge rounded-pill bg-warning" th:text="${pendingInquiries}">0</span>
			            </a>
			
			            <!-- 예시: 승인 대기 항목들 -->
			            <a th:href="@{/adminpage/storeadmin/appAdmin}" class="task-item" th:if="${pendingStoreApprovals > 0}">
			                <div class="item-info">
			                    <i class="icon material-icons text-danger md-storefront"></i>
			                    <span>상점 승인 요청</span>
			                </div>
			                <span class="badge rounded-pill bg-danger" th:text="${pendingStoreApprovals}">0</span>
			            </a>
			            
			            <a href="#" class="task-item" th:if="${pendingProductApprovals > 0}">
			                <div class="item-info">
			                    <i class="icon material-icons text-danger md-inventory_2"></i>
			                    <span>상품 승인 요청</span>
			                </div>
			                <span class="badge rounded-pill bg-danger" th:text="${pendingProductApprovals}">0</span>
			            </a>
			
			            <!-- 처리할 항목이 하나도 없을 때 표시될 메시지 -->
			            <div class="text-center text-muted py-4" 
			                 th:if="${pendingInquiries == 0 and pendingStoreApprovals == 0 and pendingProductApprovals == 0}">
			                <p class="mb-0">👍 처리할 항목이 없습니다.</p>
			            </div>
			        </div>
			    </div>
			</div>

        </div>

        <!-- 5. [수정] 월간 인기 상품 TOP 5 -->
        <div class="row">
            <div class="col-12">
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">월간 인기 상품 TOP 5</h5>
                        <div class="table-responsive">
                            <table class="table table-orders"> <!-- 기존 CSS 클래스 재활용 -->
                                <thead>
                                    <tr>
                                        <th>순위</th>
                                        <th>상품명</th>
                                        <th>카테고리</th>
                                        <th>판매량</th>
                                        <th>총 매출액</th>
                                        <th>상세</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- 예시 아이템. th:each로 실제 데이터를 반복 출력합니다. -->
                                    <tr th:each="product, iterStat : ${topProducts}">
                                        <td th:text="${iterStat.count}">1</td>
                                        <td th:text="${product.name}">프리미엄 원두커피 500g</td>
                                        <td th:text="${product.category}">커피/원두</td>
                                        <td th:text="${product.salesCount} + '개'">152개</td>
                                        <td th:text="${#numbers.formatInteger(product.totalRevenue, 0, 'COMMA')} + '원'">2,128,000원</td>
                                        <td><a th:href="@{/admin/products/{id}(id=${product.id})}" class="btn btn-sm btn-light">보기</a></td>
                                    </tr>
                                    <!-- 데이터가 없을 경우 -->
                                    <tr th:if="${#lists.isEmpty(topProducts)}">
                                        <td colspan="6" class="text-center text-muted py-4">조회된 상품 정보가 없습니다.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- ======================================================= -->

    </main>
</th:block>

<!--/* 개발시 추가할 jsfile 영역 정의 */-->
<th:block layout:fragment="jsFile">
    <!-- Chart.js 라이브러리 CDN 추가 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</th:block>

<!--/* 개발시 추가할 스크립트 */-->
<th:block layout:fragment="jsScript">
    <!-- 기존 스크립트는 그대로 유지 -->
    <script th:src="@{/js/admin/userList.js}"></script>

    <!-- [새로 추가] 대시보드 차트 스크립트 -->
    <script th:inline="javascript">
    /*<![CDATA[*/

    $(() => {
        const salesChartCanvas = $("#salesChart");

        if (salesChartCanvas.length) {
            // 더미 데이터
            const dummyLabels = ["2월", "3월", "4월", "5월", "6월", "7월"];
            const dummyData = [1020000, 1090000, 1217000, 2001500, 1632200, 1826800];

            const monthlyLabels = /*[[${monthlyLabels}]]*/ dummyLabels;
            const monthlyData = /*[[${monthlyData}]]*/ dummyData;

            const ctx = salesChartCanvas[0].getContext('2d');
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthlyLabels,
                    datasets: [{
                        label: '수수료 수익',
                        data: monthlyData,
                        backgroundColor: 'rgba(25, 135, 84, 0.1)',
                        borderColor: 'rgba(25, 135, 84, 1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {

                    responsive: false, 
                    plugins: {
                        legend: { 
                            display: false 
                        },
                        tooltip: {
                             callbacks: {
                                label: (context) => {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    label += new Intl.NumberFormat('ko-KR').format(context.parsed.y) + '원';
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => (value / 10000).toLocaleString() + '만원'
                            }
                        }
                    }
                }
            });
        }
    });

    /*]]>*/
    </script>
</th:block>
</html>