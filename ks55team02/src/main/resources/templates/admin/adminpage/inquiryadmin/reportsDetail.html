<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{admin/layout/layoutMain}">

<head>
<meta name="description" content="사용자 신고 상세 처리 페이지" />
<link rel="stylesheet"
	th:href="@{/admincss/assets/customadmincss/reportsDetail.css}">
<title>신고 상세 처리</title>
</head>

<th:block layout:fragment="contents">
	<main class="main-content">
		<section class="content-header">
			<h2 class="content-title">신고 상세 처리</h2>
			<div>
				<a th:href="@{/adminpage/inquiryadmin/reportsList}"
					class="btn btn-light rounded font-sm mr-5 text-body hover-up">목록으로</a>

				<button type="button"
					class="btn btn-light rounded font-sm text-body hover-up"
					id="modifyBtn" th:if="...">수정하기</button>
			</div>
		</section>

		<section class="content">
			<!-- [수정] reportDetail 객체가 null이 아닐 경우에만 전체 카드를 표시하여 오류 방지 -->
			<div class="card mb-4" th:if="${reportDetail != null}">
				<div class="card-body">
					<ul class="nav nav-tabs" id="reportTabs" role="tablist">
						<li class="nav-item" role="presentation"><a
							class="nav-link active" id="info-tab" data-bs-toggle="tab"
							data-bs-target="#reportInfo" type="button" role="tab"
							aria-controls="reportInfo" aria-selected="true"
							href="#reportInfo">신고 기본 정보</a></li>
						<li class="nav-item" role="presentation"><a class="nav-link"
							id="process-tab" data-bs-toggle="tab"
							data-bs-target="#reportProcess" type="button" role="tab"
							aria-controls="reportProcess" aria-selected="false"
							href="#reportProcess">신고 처리 (입력)</a></li>
					</ul>

					<div class="tab-content" id="reportTabsContent">

						<!-- ==================== 신고 기본 정보 탭 (데이터 연동) ==================== -->

						<div class="tab-pane fade show active" id="reportInfo"
							role="tabpanel" aria-labelledby="info-tab">
							<h5 class="mt-4 mb-3">접수된 신고의 상세 내용</h5>
							<form th:object="${reportDetail}">
								<div class="mb-4 form-group">
									<label for="dclrId" class="form-label">신고 ID</label> <input
										type="text" class="form-control" id="dclrId" name="dclrId"
										th:value="*{dclrId}" readonly>
								</div>
								<div class="mb-4 form-group">
									<label for="dclrUserNo" class="form-label">신고한 사용자
										(닉네임/ID)</label> <input type="text" class="form-control"
										id="dclrUserNo" name="dclrUserNo"
										th:value="|*{dclrUserNcnm} (*{dclrUserLgnId})|" readonly>
								</div>

								<div class="mb-4 form-group">
									<label for="dclrTrgtTypeCd" class="form-label">신고 대상 타입</label>
									<input type="text" class="form-control" id="dclrTrgtTypeCd"
										name="dclrTrgtTypeCd" th:value="*{dclrTrgtTypeCd}" readonly>
								</div>

								<!-- 파일: reportDetail.html -->

								<div class="mb-4 form-group">
									<label for="dclrTrgtUserNo" class="form-label">신고 대상
										사용자 (닉네임/ID)</label>

									<!-- ▼▼▼ 이 input 태그의 th:value를 최종 수정합니다 ▼▼▼ -->
									<input type="text" class="form-control"
										th:value="*{dclrTrgtUserNcnm != null ? dclrTrgtUserNcnm + ' (' + dclrTrgtUserLgnId + ')' : '- (작성자 정보 없음)-'}"
										readonly> <small class="form-text text-muted"
										th:if="*{dclrTrgtUserNcnm == null}"> 해당 콘텐츠의 작성자 정보를
										찾을 수 없거나, 사용자 직접 신고가 아닙니다. </small>
								</div>



								<!-- ▼▼▼ 이 블록 전체를 바로 아래에 추가해주세요 ▼▼▼ -->
								<div class="mb-4 form-group">
									<label class="form-label">신고 대상 원본 내용</label>
									<div id="originalContentContainer"
										class="original-content-wrapper p-3 border rounded bg-light">
										<!-- JS가 이곳에 내용을 동적으로 채워 넣을 겁니다. -->
										<div class="text-center">
											<div class="spinner-border spinner-border-sm" role="status">
												<span class="visually-hidden">Loading...</span>
											</div>
											<span class="ms-2">원본 내용 로딩 중...</span>
										</div>
									</div>
								</div>


								<div class="mb-4 form-group">
									<label for="dclrRsnCd" class="form-label">신고 사유</label> <input
										type="text" class="form-control" id="dclrRsnCd"
										name="dclrRsnCd" th:value="*{dclrRsnCn}" readonly>
								</div>
								<div class="mb-4 form-group">
									<label for="dtlDclrRsnCn" class="form-label">상세 신고 사유</label>
									<textarea class="form-control" id="dtlDclrRsnCn"
										name="dtlDclrRsnCn" rows="4" th:text="*{dclrCn}" readonly></textarea>
								</div>

								<!-- ▼▼▼ 이 블록 전체를 바로 아래에 추가해주세요 ▼▼▼ -->
								<div class="mb-4 form-group"
									th:if="${reportDetail.attachments != null and !reportDetail.attachments.isEmpty()}">
									<label class="form-label">첨부된 증거 자료</label>
									<div class="attachment-thumbnail-container">
										<a th:each="file : ${reportDetail.attachments}"
											th:href="@{${file.filePath}}" target="_blank"
											class="attachment-thumbnail-item"
											th:title="${file.originalFileName}"> <img
											th:src="@{${file.filePath}}"
											th:alt="${file.originalFileName}">
										</a>
									</div>
								</div>

								<div class="mb-4 form-group">
									<label for="dclrRcptDt" class="form-label">신고 접수 일시</label> <input
										type="text" class="form-control" id="dclrRcptDt"
										name="dclrRcptDt" th:value="*{dclrDt}" readonly>
								</div>
							</form>
						</div>

						<!-- ==================== 신고 처리 입력 탭 (수정 없음) ==================== -->
						<div class="tab-pane fade" id="reportProcess" role="tabpanel"
							aria-labelledby="process-tab">
							<div class="p-5 text-center">
								<div class="spinner-border" role="status">
									<span class="visually-hidden">Loading...</span>
								</div>
							</div>
						</div>


					</div>
				</div>
			</div>
			<!-- [수정] reportDetail 객체가 null일 경우 메시지 표시 -->
			<div class="card mb-4" th:if="${reportDetail == null}">
				<div class="card-body text-center">
					<p>해당 신고 정보를 찾을 수 없습니다.</p>
				</div>
			</div>
		</section>
	</main>
</th:block>


<th:block layout:fragment="jsFile">
</th:block>

<th:block layout:fragment="jsScript">
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script th:inline="javascript">
/*<![CDATA[*/

// [핵심] HTML 문서가 완전히 로드된 후에 스크립트를 실행하도록 보장합니다.
document.addEventListener('DOMContentLoaded', function() {

    // --- 1. 변수 선언 ---
    const dclrId = /*[[${reportDetail.dclrId}]]*/ null; 
    const reportProcessTab = document.getElementById('process-tab');
    const reportProcessContainer = document.getElementById('reportProcess');
    
    // AJAX로 불러온 신고 상세 정보를 저장할 변수 (수정 모드에서 재사용하기 위함)
    let loadedReportDetail = null;
    // 현재 페이지가 '수정 모드'인지 상태를 관리하는 변수 (기본값은 false)
    let isModifyMode = false;

    // --- 2. 초기 이벤트 리스너 ---

    // '신고 처리' 탭을 처음 클릭했을 때 데이터 로딩을 시작합니다.
    reportProcessTab.addEventListener('click', function() {
        // 이미 내용이 그려져 있다면 중복해서 로드하지 않습니다.
        if (reportProcessContainer.getAttribute('data-loaded') === 'true') {
            return;
        }
        fetchAndRenderReportDetails(dclrId);
    });

    // --- 3. 핵심 기능 함수 ---

    // AJAX로 신고 데이터를 가져와서 상태에 맞는 화면을 그리는 메인 함수
    function fetchAndRenderReportDetails(dclrId) {
        reportProcessContainer.innerHTML = `
            <div class="p-5 text-center">
                <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
            </div>`;

        fetch(`/api/admin/reports/${dclrId}`)
            .then(response => {
                if (!response.ok) throw new Error('신고 정보를 불러오는 데 실패했습니다.');
                return response.json();
            })
            .then(reportDetail => {
                // 받아온 데이터를 나중에 '수정하기' 버튼이 쓸 수 있도록 저장해둡니다.
                loadedReportDetail = reportDetail;
                
                if (reportDetail.prcsSttsCd === 'RECEIVED') {
                    isModifyMode = false; // 신규 처리 모드로 명시
                    reportProcessContainer.innerHTML = renderInputForm(reportDetail);
                    addEventListenersToForm(reportDetail.dclrId);
                } else {
                    reportProcessContainer.innerHTML = renderReadOnlyView(reportDetail);
                }
                reportProcessContainer.setAttribute('data-loaded', 'true');
            })
            .catch(error => {
                reportProcessContainer.innerHTML = `<div class="p-5 text-center text-danger">${error.message}</div>`;
            });
    }

    // '입력 폼'의 HTML 문자열을 생성하는 함수 (데이터 채우기 기능 포함)
    function renderInputForm(reportDetail) {
        const targetType = reportDetail.dclrTrgtTypeCd;
        const history = reportDetail.historyList && reportDetail.historyList.length > 0 ? reportDetail.historyList[0] : {};
        const previousSanction = history.actionType || 'NONE';

        let optionsHtml = `<option value="NONE" ${previousSanction === 'NONE' ? 'selected' : ''}>제재 없음</option>`;
        if (targetType === 'USER') {
            optionsHtml += `
                <option value="SUSPENSION_3D" ${previousSanction === 'SUSPENSION_3D' ? 'selected' : ''}>3일 이용 정지</option>
                <option value="SUSPENSION_7D" ${previousSanction === 'SUSPENSION_7D' ? 'selected' : ''}>7일 이용 정지</option>
                <option value="SUSPENSION_14D" ${previousSanction === 'SUSPENSION_14D' ? 'selected' : ''}>14일 이용 정지</option>
                <option value="SUSPENSION_30D" ${previousSanction === 'SUSPENSION_30D' ? 'selected' : ''}>30일 이용 정지</option>
                <option value="BAN_PERMANENT" ${previousSanction === 'BAN_PERMANENT' ? 'selected' : ''}>영구 이용 정지</option>`;
        } else if (targetType === 'POST' || targetType === 'COMMENT') {
            optionsHtml += `
                <option value="CONTENT_DELETION" ${previousSanction === 'CONTENT_DELETION' ? 'selected' : ''}>삭제 조치</option>
                <option value="AUTHOR_RESTRICTION" ${previousSanction === 'AUTHOR_RESTRICTION' ? 'selected' : ''}>작성자 제한</option>`;
        } else if (targetType === 'PRODUCT') {
            optionsHtml += `<option value="CONTENT_DELETION" ${previousSanction === 'CONTENT_DELETION' ? 'selected' : ''}>삭제 조치</option>`;
        }

        const previousStatus = reportDetail.prcsSttsCd || 'COMPLETED';
        const previousResult = reportDetail.dclrPrcsRsltCn || '';
        const previousAction = history.actnCn || '';
        const previousMemo = history.prcsDsctnMemoCn || '';
        
        const formTitle = isModifyMode ? '신고 처리 정보 수정' : '신고 처리 정보 입력';
        const buttonText = isModifyMode ? '수정 내용 저장' : '처리 내용 저장';

        return `
            <h5 class="mt-4 mb-3">${formTitle}</h5>
            <form id="reportProcessingForm" method="post">
                <input type="hidden" name="dclrId" value="${reportDetail.dclrId}">
                <div class="mb-4 form-group">
                    <label for="newStatus" class="form-label">처리 상태 변경</label>
                    <select class="form-select" id="newStatus" name="newStatus">
                        <option value="COMPLETED" ${previousStatus === 'COMPLETED' ? 'selected' : ''}>처리 완료</option>
                        <option value="REJECTED" ${previousStatus === 'REJECTED' ? 'selected' : ''}>반려</option>
                    </select>
                </div>
                <div class="mb-4 form-group">
                    <label for="dclrPrcsRsltCn" class="form-label">최종 처리 결과 내용</label>
                    <textarea class="form-control" id="dclrPrcsRsltCn" name="dclrPrcsRsltCn" rows="4" placeholder="신고자에게 안내될 최종 처리 결과를 입력하세요.">${previousResult}</textarea>
                </div>
                <hr class="my-4">
                <h5>세부 조치 및 이력 기록 (관리자용)</h5>
                <div class="mb-4 form-group">
                    <label for="sanctionType" class="form-label">조치 유형</label>
                    <select class="form-select" id="sanctionType" name="sanctionType">${optionsHtml}</select>
                </div>
                <div class="mb-4 form-group" id="sanctionDurationGroup" style="display: none;">
                    <label for="sanctionDuration" class="form-label">제한 기간</label>
                    <select class="form-select" id="sanctionDuration" name="sanctionDuration">
                        <option value="3일" selected>3일</option> <option value="7일">7일</option> <option value="14일">14일</option>
                        <option value="30일">30일</option> <option value="영구">영구</option>
                    </select>
                </div>
                <div class="mb-4 form-group">
                    <label for="actnCn" class="form-label">조치 내용</label>
                    <textarea class="form-control" id="actnCn" name="actnCn" rows="3" placeholder="실제로 어떤 조치가 이루어졌는지 구체적인 내용을 기록합니다.">${previousAction}</textarea>
                </div>
                <div class="mb-4 form-group">
                    <label for="prcsDsctnMemoCn" class="form-label">내부 처리 메모</label>
                    <textarea class="form-control" id="prcsDsctnMemoCn" name="prcsDsctnMemoCn" rows="3" placeholder="동료 관리자가 참고해야 할 내용을 기재합니다. (신고자에게 노출되지 않음)">${previousMemo}</textarea>
                </div>
                <div class="text-end">
                    <button type="submit" class="btn btn-primary">${buttonText}</button>
                </div>
            </form>
        `;
    }

    // '조회 화면'의 HTML 문자열을 생성하는 함수
    function renderReadOnlyView(reportDetail) {
        const history = reportDetail.historyList && reportDetail.historyList.length > 0 ? reportDetail.historyList[0] : null;
        let sanctionTypeHtml = '기타 또는 알 수 없는 조치';
        if(history && history.actionType) {
            switch(history.actionType) {
                case 'NONE': sanctionTypeHtml = '제재 없음'; break;
                case 'SUSPENSION_3D': sanctionTypeHtml = '3일 이용 정지'; break;
                case 'SUSPENSION_7D': sanctionTypeHtml = '7일 이용 정지'; break;
                case 'SUSPENSION_14D': sanctionTypeHtml = '14일 이용 정지'; break;
                case 'SUSPENSION_30D': sanctionTypeHtml = '30일 이용 정지'; break;
                case 'BAN_PERMANENT': sanctionTypeHtml = '영구 이용 정지'; break;
                case 'CONTENT_DELETION': sanctionTypeHtml = '삭제 조치'; break;
                case 'AUTHOR_RESTRICTION': sanctionTypeHtml = '작성자 제한'; break;
                default: sanctionTypeHtml = history.actionType;
            }
        }

        return `
            <h5 class="mt-4 mb-3">처리 완료된 신고 정보 (조회)</h5>
            <div class="mb-3"><label class="form-label">최종 처리 상태</label><input type="text" class="form-control" value="${reportDetail.prcsSttsCd === 'COMPLETED' ? '✅ 처리 완료' : '❌ 반려'}" readonly></div>
            <div class="mb-3"><label class="form-label">최종 처리 결과 내용</label><textarea class="form-control" rows="4" readonly>${reportDetail.dclrPrcsRsltCn || ''}</textarea></div>
            <hr class="my-4">
            <h5>처리 이력</h5>
            ${history ? `
                <div class="mb-3"><label class="form-label">조치 유형</label><div class="form-control" style="background-color: #e9ecef;">${sanctionTypeHtml}</div></div>
                <div class="mb-3"><label class="form-label">조치 내용</label><textarea class="form-control" rows="3" readonly>${history.actnCn || ''}</textarea></div>
                <div class="mb-3"><label class="form-label">내부 처리 메모</label><textarea class="form-control" rows="3" readonly>${history.prcsDsctnMemoCn || ''}</textarea></div>
            ` : '<p>처리 이력이 없습니다.</p>'}
        `;
    }

    // [업그레이드] '입력 폼'에 이벤트 리스너를 추가하는 함수
    function addEventListenersToForm(dclrId) {
        const processForm = document.getElementById('reportProcessingForm');
        if (!processForm) return;

        const sanctionTypeSelect = document.getElementById('sanctionType');
        const sanctionDurationGroup = document.getElementById('sanctionDurationGroup');

        sanctionTypeSelect.addEventListener('change', (event) => {
            sanctionDurationGroup.style.display = event.target.value === 'AUTHOR_RESTRICTION' ? 'block' : 'none';
        });
        
        processForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(processForm);
            const reportData = Object.fromEntries(formData.entries());
            
            const apiUrl = isModifyMode ? `/api/admin/reports/${dclrId}/update` : `/api/admin/reports/${dclrId}/process`;
            const httpMethod = isModifyMode ? 'PUT' : 'POST';
            const confirmTitle = isModifyMode ? '수정된 내용을 저장하시겠습니까?' : '이대로 신고를 처리하시겠습니까?';

            Swal.fire({
                title: confirmTitle,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '네, 저장합니다.',
                cancelButtonText: '아니요'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(apiUrl, {
                        method: httpMethod,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(reportData),
                    })
                    .then(response => response.json().then(data => ({ ok: response.ok, data })))
                    .then(({ ok, data }) => {
                        Swal.fire({ icon: ok ? 'success' : 'error', title: ok ? '성공' : '실패', text: data.message, })
                        .then(() => { if (ok) window.location.reload(); });
                    })
                    .catch(error => Swal.fire('오류', '요청 처리 중 문제가 발생했습니다.', 'error'));
                }
            });
        });
    }

    // [추가] '수정하기' 버튼에 대한 이벤트 리스너
    const modifyBtn = document.getElementById('modifyBtn');
    if (modifyBtn) {
        modifyBtn.addEventListener('click', function() {
            if (!loadedReportDetail) {
                Swal.fire('알림', '신고 정보를 먼저 불러와주세요.\n"신고 처리" 탭을 한 번 클릭해주세요.', 'info');
                return;
            }

            const tabTrigger = new bootstrap.Tab(reportProcessTab);
            tabTrigger.show();

            isModifyMode = true;
            
            reportProcessContainer.innerHTML = renderInputForm(loadedReportDetail);
            
            addEventListenersToForm(loadedReportDetail.dclrId);
        });
    }
    
 // ▼▼▼▼▼ 바로 이 자리에 붙여넣으세요 ▼▼▼▼▼
    // 페이지가 로드되면 즉시 원본 콘텐츠를 불러옵니다.
    loadOriginalContent();

    /**
     * 신고 대상 원본 콘텐츠를 AJAX로 불러와 화면에 그려주는 함수
     */
    function loadOriginalContent() {
        const targetType = /*[[${reportDetail.dclrTrgtTypeCd}]]*/ null;
        const contentId = /*[[${reportDetail.dclrTrgtContsId}]]*/ null;
        const userId = /*[[${reportDetail.dclrTrgtUserNo}]]*/ null;
        const container = document.getElementById('originalContentContainer');

        if (!targetType) {
            container.innerHTML = '<div class="text-muted p-3">원본 콘텐츠 정보가 없습니다.</div>';
            return;
        }

        // 신고 대상이 'USER' 타입이고, 콘텐츠 ID가 없을 경우를 위한 처리
        if (targetType === 'USER' && !contentId) {
            // 이 경우에는 userId를 사용합니다.
            if (!userId) {
                container.innerHTML = '<div class="text-muted p-3">원본 사용자 정보를 특정할 수 없습니다.</div>';
                return;
            }
        } else if (!contentId) {
            // 그 외 콘텐츠 타입인데 콘텐츠 ID가 없는 경우
            container.innerHTML = '<div class="text-muted p-3">원본 콘텐츠 정보를 특정할 수 없습니다.</div>';
            return;
        }
        
        let apiUrl = '/api/admin/content/';
        switch (targetType) {
            case 'POST':    apiUrl += `posts/${contentId}`; break;
            case 'COMMENT': apiUrl += `comments/${contentId}`; break;
            case 'PRODUCT': apiUrl += `products/${contentId}`; break;
            case 'USER':    apiUrl += `users/${userId}`; break; // 사용자 신고는 userId를 사용
            default:
                container.innerHTML = `<div class="text-danger p-3">알 수 없는 대상 타입: ${targetType}</div>`;
                return;
        }

        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    if (response.status === 404) throw new Error('원본 콘텐츠를 찾을 수 없습니다 (삭제되었을 수 있습니다).');
                    throw new Error('원본 정보를 불러오는 데 실패했습니다.');
                }
                return response.json();
            })
            .then(data => {
            	let contentHtml = '';
                // 타입별로 다른 HTML을 그려줍니다.
                switch (targetType) {
                    case 'POST':
                        contentHtml = `
                            <div class="content-card">
                                <div class="card-content-title">게시글 제목</div>
                                <div class="card-content-body">${data.title || '(제목 없음)'}</div>
                            </div>
                            <div class="content-card mt-2">
                                <div class="card-content-title">내용</div>
                                <div class="card-content-body">${data.content || '(내용 없음)'}</div>
                            </div>`;
                        break;
                    case 'COMMENT':
                        contentHtml = `
                            <div class="content-card">
                                <div class="card-content-title">댓글 내용</div>
                                <div class="card-content-body">${data.content || '(내용 없음)'}</div>
                            </div>`;
                        break;
                    case 'PRODUCT':
                        contentHtml = `
                            <div class="content-card">
                                <div class="card-content-title">상품명</div>
                                <div class="card-content-body">${data.name || '(상품명 없음)'}</div>
                            </div>
                            <div class="content-card mt-2">
                                <div class="card-content-title">상품 설명</div>
                                <div class="card-content-body">${data.description || '(설명 없음)'}</div>
                            </div>`;
                        break;
                    case 'USER':
                        contentHtml = `
                            <div class="content-card">
                                <div class="card-content-title">사용자 닉네임</div>
                                <div class="card-content-body">${data.nickname || '(닉네임 없음)'}</div>
                            </div>
                            <div class="content-card mt-2">
                                <div class="card-content-title">소개글</div>
                                <div class="card-content-body">${data.bio || '(소개글 없음)'}</div>
                            </div>`;
                        break;
                }
                container.innerHTML = contentHtml;
                // ▲▲▲ 여기까지 교체 ▲▲▲
            })
            .catch(error => {
                container.innerHTML = `<div class="text-danger p-3">${error.message}</div>`;
            });
    }
    // ▲▲▲▲▲ 여기까지 ▲▲▲▲▲
    
    

}); // <-- DOMContentLoaded 닫는 괄호

/*]]>*/
</script>
</th:block>





</html>