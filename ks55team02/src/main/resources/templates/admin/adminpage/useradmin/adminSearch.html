<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{admin/layout/layoutMain}">

<head>
<title>ê²€ìƒ‰ ê¸°ë¡ ì¡°íšŒ</title>
</head>
<th:block layout:fragment="contents">
	<main class="main-content">
		<section class="content-header">
			<h2 class="content-title">ê²€ìƒ‰ ê¸°ë¡ ì¡°íšŒ</h2>
		</section>

		<div class="card mb-4">
			<div class="card-body">
				<div class="row gx-3 align-items-end">
					<div class="col-lg-4 mb-3">
						<label class="form-label">ê²€ìƒ‰ ê¸°ê°„</label>
						<div class="d-flex">
							<input type="date" class="form-control" name="searchStartDate"
								value="2023-01-01"> <span
								class="mx-2 d-flex align-items-center">-</span> <input
								type="date" class="form-control" name="searchEndDate"
								value="2023-12-31">
						</div>
					</div>
					<div class="col-lg-4 mb-3">
						<label class="form-label">ê²€ìƒ‰ í‚¤ì›Œë“œ</label>
						<div class="input-group">
							<select class="form-select" name="searchKey"
								style="max-width: 150px; background-color: #fff;">
								<option value="all" selected>ì „ì²´</option>
								<option value="srchLogId">ê²€ìƒ‰ ë¡œê·¸ ID</option>
								<option value="userNo">ì‚¬ìš©ì ë²ˆí˜¸</option>
								<option value="srchKeywordNm">ê²€ìƒ‰ í‚¤ì›Œë“œ</option>
								<option value="srchUserIpAddr">ê²€ìƒ‰ IP ì£¼ì†Œ</option>
							</select> <input type="text" class="form-control" name="searchValue"
								value="" placeholder="ê²€ìƒ‰ì–´, ì‚¬ìš©ì ë²ˆí˜¸, IP ì£¼ì†Œ ë“±">
						</div>
					</div>
					<div class="col-lg-2 mb-3">
						<label for="srchDomainCd" class="form-label">ê²€ìƒ‰ ì˜ì—­</label> <select
							class="form-select" id="srchDomainCd" name="srchDomainCd">
							<option value="" selected>-- ì „ì²´ --</option>
							<option value="PRODUCT">ìƒí’ˆ</option>
							<option value="COMMUNITY">ê²Œì‹œê¸€</option>
							<option value="USER">ì‚¬ìš©ì</option>
						</select>
					</div>
					<div class="col-lg-2 mb-3 d-flex align-items-end">
						<a href="#" class="btn btn-primary btn-block me-2" id="searchBtn">ê²€ìƒ‰</a>
						<button class="btn btn-light btn-block" type="reset">ì´ˆê¸°í™”</button>
					</div>
				</div>
			</div>
		</div>

		<ul class="nav nav-tabs" id="viewTabs" role="tablist">
			<li class="nav-item" role="presentation">
				<button class="nav-link active" id="stats-tab" data-bs-toggle="tab"
					data-bs-target="#stats-view-container" type="button" role="tab"
					aria-controls="stats-view-container" aria-selected="true">
					ğŸ“ˆ í†µê³„ ë³´ê¸°</button>
			</li>
			<li class="nav-item" role="presentation">
				<button class="nav-link" id="log-tab" data-bs-toggle="tab"
					data-bs-target="#log-view-container" type="button" role="tab"
					aria-controls="log-view-container" aria-selected="false">
					ğŸ“„ ë¡œê·¸ ë³´ê¸°</button>
			</li>
		</ul>

		<div class="card mb-4" id="stats-view-container">
			<div class="card-body">
				<div class="row gx-3 align-items-center mb-3">
					<div class="col-md-6">
						<div class="search-result-info">
							<span id="stats-total-info"> ì´ <b class="text-brand">0</b>ê°œì˜
								í‚¤ì›Œë“œì— ëŒ€í•œ ê²€ìƒ‰ í†µê³„ì…ë‹ˆë‹¤.
							</span>
						</div>
					</div>
				</div>
				<div class="table-responsive">
					<table class="table table-hover">
						<thead>
							<tr class="text-center">
								<th style="width: 15%;">ìˆœìœ„</th>
								<th>ê²€ìƒ‰ í‚¤ì›Œë“œ</th>
								<th style="width: 20%;">ê²€ìƒ‰ íšŸìˆ˜</th>
							</tr>
						</thead>
						<tbody id="statsTableBody" class="text-center">
						</tbody>
					</table>
				</div>

				<nav class="mt-4" aria-label="Page navigation">
					<ul class="pagination justify-content-center">
					</ul>
				</nav>
			</div>
		</div>

		<div class="card mb-4" id="log-view-container" style="display: none;">
			<div class="card-body">
				<div class="row gx-3 align-items-center mb-3">
					<div class="col-md-6">
						<div class="search-result-info">
							ì´ <b class="text-brand" id="logTotalCount">0</b> ê±´ì˜ ê²€ìƒ‰ ê¸°ë¡ì´
							ê²€ìƒ‰ë˜ì—ˆìŠµë‹ˆë‹¤.
						</div>
					</div>
				</div>
				<div class="table-responsive">
					<table class="table table-hover">
						<thead>
							<tr class="text-center">
								<th>ê²€ìƒ‰ ë¡œê·¸ ID</th>
								<th>ì‚¬ìš©ì ë²ˆí˜¸</th>
								<th>ê²€ìƒ‰ í‚¤ì›Œë“œ</th>
								<th>ê²€ìƒ‰ ì¼ì‹œ</th>
								<th>ê²€ìƒ‰ IP ì£¼ì†Œ</th>
							</tr>
						</thead>
						<tbody id="logTableBody" class="text-center">
						</tbody>
					</table>
				</div>
				<nav class="mt-4" aria-label="Page navigation">
					<ul class="pagination justify-content-center" id="pagination">
					</ul>
				</nav>
			</div>
		</div>
	</main>
</th:block>

<th:block layout:fragment="jsScript">
	<script>
document.addEventListener('DOMContentLoaded', () => {

    // ===== DOM ìš”ì†Œ ì„ íƒ (ë³€ê²½ ì—†ìŒ) =====
    const statsTab = document.getElementById('stats-tab');
    const logTab = document.getElementById('log-tab');
    const statsContainer = document.getElementById('stats-view-container');
    const logContainer = document.getElementById('log-view-container');
    const statsTableBody = document.getElementById('statsTableBody');
    const logTableBody = document.getElementById('logTableBody');
    const statsPagination = document.querySelector('#stats-view-container .pagination');
    const logPagination = document.querySelector('#log-view-container .pagination');
    const searchBtn = document.getElementById('searchBtn');
    let currentLogSearchParams = {};

    // ===== íƒ­ ì „í™˜ ë¡œì§ (ë³€ê²½ ì—†ìŒ) =====
    statsTab.addEventListener('click', () => {
        statsContainer.style.display = 'block';
        logContainer.style.display = 'none';
        fetchAndRenderStats(1);
    });

    logTab.addEventListener('click', () => {
        statsContainer.style.display = 'none';
        logContainer.style.display = 'block';
        fetchAndRenderLogs(1);
    });

    // âœ…âœ…âœ… [ìˆ˜ì •] ì´ë²¤íŠ¸ ìœ„ì„ ë°©ì‹ìœ¼ë¡œ í˜ì´ì§€ë„¤ì´ì…˜ í´ë¦­ ì²˜ë¦¬ âœ…âœ…âœ…
    // í†µê³„ ë³´ê¸° í˜ì´ì§€ë„¤ì´ì…˜ ì»¨í…Œì´ë„ˆì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ 1ê°œë§Œ ë“±ë¡
    statsPagination.addEventListener('click', (e) => {
        e.preventDefault();
        // í´ë¦­ëœ ìš”ì†Œê°€ .page-link í´ë˜ìŠ¤ë¥¼ ê°€ì§€ê³  ìˆëŠ”ì§€ í™•ì¸
        if (e.target.classList.contains('page-link') && e.target.dataset.page) {
            fetchAndRenderStats(parseInt(e.target.dataset.page));
        }
    });

    // ë¡œê·¸ ë³´ê¸° í˜ì´ì§€ë„¤ì´ì…˜ ì»¨í…Œì´ë„ˆì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ 1ê°œë§Œ ë“±ë¡
    logPagination.addEventListener('click', (e) => {
        e.preventDefault();
        if (e.target.classList.contains('page-link') && e.target.dataset.page) {
            fetchAndRenderLogs(parseInt(e.target.dataset.page), currentLogSearchParams);
        }
    });


    // ===== ë°ì´í„° ì¡°íšŒ ë° ë Œë”ë§ í•¨ìˆ˜ (ë³€ê²½ ì—†ìŒ) =====
    const fetchAndRenderStats = async (page = 1) => {
        const response = await fetch(`/api/admin/search/stats?page=${page}`);
        const data = await response.json();
        document.getElementById('stats-total-info').innerHTML = `ì´ <b class="text-brand">${data.totalStatsCount}</b>ê°œì˜ í‚¤ì›Œë“œì— ëŒ€í•œ ê²€ìƒ‰ í†µê³„ì…ë‹ˆë‹¤.`;
        renderStats(data.statsList, page);
        renderPagination(statsPagination, data); // âœ… ìˆ˜ì •: ë§ˆì§€ë§‰ ì¸ì ì œê±°
    };

    const fetchAndRenderLogs = async (page = 1, params = currentLogSearchParams) => {
        currentLogSearchParams = params;
        const queryString = new URLSearchParams(params).toString();
        const response = await fetch(`/api/admin/search/logs?page=${page}&${queryString}`);
        const data = await response.json();
        document.getElementById('logTotalCount').textContent = data.totalLogCount;
        renderLogs(data.logList);
        renderPagination(logPagination, data); // âœ… ìˆ˜ì •: ë§ˆì§€ë§‰ ì¸ì ì œê±°
    };

    const renderStats = (statsList, page) => {
        statsTableBody.innerHTML = '';
        if (!statsList || statsList.length === 0) {
            statsTableBody.innerHTML = '<tr><td colspan="3">í†µê³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }
        const pageSize = 10;
        statsList.forEach((stat, index) => {
            const rank = (page - 1) * pageSize + index + 1;
            statsTableBody.innerHTML += `<tr><td>${rank}</td><td>${stat.srchKeywordNm}</td><td>${stat.searchCount}</td></tr>`;
        });
    };

    const renderLogs = (logList) => {
        logTableBody.innerHTML = '';
        if (!logList || logList.length === 0) {
            logTableBody.innerHTML = '<tr><td colspan="5">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }
        logList.forEach(log => {
            logTableBody.innerHTML += `<tr><td>${log.srchLogId}</td><td>${log.userNo}</td><td>${log.srchKeywordNm}</td><td>${new Date(log.srchDt).toLocaleString()}</td><td>${log.srchUserIpAddr}</td></tr>`;
        });
    };

    // âœ…âœ…âœ… [ìˆ˜ì •] í˜ì´ì§€ë„¤ì´ì…˜ UI ë Œë”ë§ í•¨ìˆ˜ì—ì„œ ì´ë²¤íŠ¸ ë“±ë¡ ë¡œì§ ì œê±° âœ…âœ…âœ…
    const renderPagination = (container, pageData) => {
        container.innerHTML = '';
        if (!pageData || pageData.lastPage === 0) return;

        const prevDisabled = pageData.currentPage <= 1 ? 'disabled' : '';
        container.innerHTML += `<li class="page-item ${prevDisabled}"><a class="page-link" href="#" data-page="${pageData.currentPage - 1}">ì´ì „</a></li>`;

        for (let i = pageData.startPage; i <= pageData.endPage; i++) {
            const active = i === pageData.currentPage ? 'active' : '';
            container.innerHTML += `<li class="page-item ${active}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
        }

        const nextDisabled = pageData.currentPage >= pageData.lastPage ? 'disabled' : '';
        container.innerHTML += `<li class="page-item ${nextDisabled}"><a class="page-link" href="#" data-page="${pageData.currentPage + 1}">ë‹¤ìŒ</a></li>`;
        
        // ì´ ë¶€ë¶„ì— ìˆë˜ ì´ë²¤íŠ¸ ë“±ë¡ forEachë¬¸ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.
    };

    // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (ë³€ê²½ ì—†ìŒ)
    searchBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const formData = new FormData(document.querySelector('.card-body form'));
        const params = Object.fromEntries(formData.entries());
        logTab.click();
        fetchAndRenderLogs(1, params);
    });

    // ===== í˜ì´ì§€ ìµœì´ˆ ë¡œë”© ì‹œ ì‹¤í–‰ (ë³€ê²½ ì—†ìŒ) =====
    fetchAndRenderStats(1);
});
</script>
</th:block>
</html>