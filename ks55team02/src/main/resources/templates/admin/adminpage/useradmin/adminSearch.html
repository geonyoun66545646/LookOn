<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{admin/layout/layoutMain}">

<head>
<title>ê²€ìƒ‰ ê¸°ë¡ ì¡°íšŒ</title>
</head>
<th:block layout:fragment="contents">
	<main class="main-content">
		<section class="content-header">
			<h2 class="content-title">ê²€ìƒ‰ ê¸°ë¡ ì¡°íšŒ</h2>
		</section>

		<div class="card mb-4">
			<div class="card-body">
				<!-- âœ… [HTML ìˆ˜ì •] ê²€ìƒ‰ì°½ì„ form íƒœê·¸ë¡œ ê°ì‹¸ê³ , 'ê²€ìƒ‰ì–´'ì™€ 'ê¸°ê°„'ë§Œ ë‚¨ê²¨ ë‹¨ìˆœí™”í•©ë‹ˆë‹¤. -->
				<form id="searchForm">
					<div class="row gx-3 align-items-end">
						<div class="col-lg-5 mb-3">
							<label class="form-label">ê²€ìƒ‰ ê¸°ê°„</label>
							<div class="d-flex">
								<input type="date" class="form-control" name="searchStartDate" value="2020-01-01">
								<span class="mx-2 d-flex align-items-center">-</span> <input
									type="date" class="form-control" name="searchEndDate" th:value="${#dates.format(#dates.createToday(), 'yyyy-MM-dd')}">
							</div>
						</div>
						<div class="col-lg-5 mb-3">
							<label class="form-label">ê²€ìƒ‰ì–´</label> <input type="text"
								class="form-control" name="searchValue"
								placeholder="ê²€ìƒ‰í•  í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.">
						</div>
						<div class="col-lg-2 mb-3 d-flex align-items-end">
							<button type="submit" class="btn btn-primary btn-block me-2">ê²€ìƒ‰</button>
							<button class="btn btn-light btn-block" type="reset">ì´ˆê¸°í™”</button>
						</div>
					</div>
				</form>
			</div>
		</div>

		<!-- íƒ­ êµ¬ì¡°ëŠ” ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€í•©ë‹ˆë‹¤. -->
		<ul class="nav nav-tabs" id="viewTabs" role="tablist">
			<li class="nav-item" role="presentation">
				<button class="nav-link active" id="stats-tab" type="button">ğŸ“ˆ
					í†µê³„ ë³´ê¸°</button>
			</li>
			<li class="nav-item" role="presentation">
				<button class="nav-link" id="log-tab" type="button">ğŸ“„ ë¡œê·¸
					ë³´ê¸°</button>
			</li>
		</ul>

		<div class="card mb-4" id="stats-view-container">
			<!-- í†µê³„ ë³´ê¸° í…Œì´ë¸” êµ¬ì¡°ëŠ” ê¸°ì¡´ê³¼ ë™ì¼ -->
			<div class="card-body">
				<div class="row gx-3 align-items-center mb-3">
					<div class="col-md-6">
						<div class="search-result-info">
							<span id="stats-total-info"></span>
						</div>
					</div>
				</div>
				<div class="table-responsive">
					<table class="table table-hover">
						<thead>
							<tr class="text-center">
								<th style="width: 15%;">ìˆœìœ„</th>
								<th>ê²€ìƒ‰ í‚¤ì›Œë“œ</th>
								<th style="width: 20%;">ê²€ìƒ‰ íšŸìˆ˜</th>
							</tr>
						</thead>
						<tbody id="stats-table-body" class="text-center"></tbody>
					</table>
				</div>
				<nav class="mt-4">
					<ul class="pagination justify-content-center" id="stats-pagination"></ul>
				</nav>
			</div>
		</div>

		<div class="card mb-4" id="log-view-container" style="display: none;">
			<!-- ë¡œê·¸ ë³´ê¸° í…Œì´ë¸” êµ¬ì¡°ëŠ” ê¸°ì¡´ê³¼ ë™ì¼ -->
			<div class="card-body">
				<div class="row gx-3 align-items-center mb-3">
					<div class="col-md-6">
						<div class="search-result-info">
							<span id="log-total-info"></span>
						</div>
					</div>
				</div>
				<div class="table-responsive">
					<table class="table table-hover">
						<thead>
							<tr class="text-center">
								<th>ê²€ìƒ‰ ë¡œê·¸ ID</th>
								<th>ì‚¬ìš©ì ë²ˆí˜¸</th>
								<th>ê²€ìƒ‰ í‚¤ì›Œë“œ</th>
								<th>ê²€ìƒ‰ ì¼ì‹œ</th>
								<th>ê²€ìƒ‰ IP ì£¼ì†Œ</th>
							</tr>
						</thead>
						<tbody id="log-table-body" class="text-center"></tbody>
					</table>
				</div>
				<nav class="mt-4">
					<ul class="pagination justify-content-center" id="log-pagination"></ul>
				</nav>
			</div>
		</div>
	</main>
</th:block>

<th:block layout:fragment="jsScript">
	<!-- âœ… [JS ìˆ˜ì •] ì „ì²´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìƒˆë¡œìš´ í†µí•© êµ¬ì¡°ë¡œ ë³€ê²½í•©ë‹ˆë‹¤. -->
	<script>
        document.addEventListener('DOMContentLoaded', () => {

            // ===== 1. ì „ì—­ ë³€ìˆ˜ ë° DOM ìš”ì†Œ ì„ ì–¸ =====
            const searchForm = document.getElementById('searchForm');
            const statsTab = document.getElementById('stats-tab');
            const logTab = document.getElementById('log-tab');

            const statsContainer = document.getElementById('stats-view-container');
            const logContainer = document.getElementById('log-view-container');
            const statsTableBody = document.getElementById('stats-table-body');
            const logTableBody = document.getElementById('log-table-body');
            const statsPagination = document.getElementById('stats-pagination');
            const logPagination = document.getElementById('log-pagination');
			
            const statsTotalInfo = document.getElementById('stats-total-info');
            const logTotalInfo = document.getElementById('log-total-info');

            let currentView = 'stats'; // í˜„ì¬ í™œì„±í™”ëœ ë·° (ê¸°ë³¸ê°’: í†µê³„)
            let currentPage = 1;

            // ===== 2. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë°”ì¸ë”© =====

            // íƒ­ í´ë¦­ ì´ë²¤íŠ¸
            statsTab.addEventListener('click', () => switchTab('stats'));
            logTab.addEventListener('click', () => switchTab('logs'));
			
            // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ (formì˜ submit ì´ë²¤íŠ¸ í™œìš©)
            searchForm.addEventListener('submit', e => {
                e.preventDefault();
                currentPage = 1;
                loadData();
            });
            
            // ì´ˆê¸°í™” ë²„íŠ¼ í´ë¦­
            searchForm.addEventListener('reset', () => {
                setTimeout(() => loadData(), 0);
            });

            // í˜ì´ì§€ë„¤ì´ì…˜ í´ë¦­ ì´ë²¤íŠ¸ (ì´ë²¤íŠ¸ ìœ„ì„)
            statsPagination.addEventListener('click', e => handlePaginationClick(e));
            logPagination.addEventListener('click', e => handlePaginationClick(e));

            function handlePaginationClick(e) {
                e.preventDefault();
                const pageLink = e.target.closest('.page-link');
                if (pageLink && pageLink.dataset.page) {
                    currentPage = parseInt(pageLink.dataset.page);
                    loadData();
                }
            }

            // ===== 3. í•µì‹¬ ê¸°ëŠ¥ í•¨ìˆ˜ =====
            function switchTab(viewName) {
                currentView = viewName;
                currentPage = 1;

                const isActive = (viewName === 'stats');
                statsTab.classList.toggle('active', isActive);
                logTab.classList.toggle('active', !isActive);
                statsContainer.style.display = isActive ? 'block' : 'none';
                logContainer.style.display = !isActive ? 'block' : 'none';

                loadData();
            }

            async function loadData() {
                const formData = new FormData(searchForm);
                const params = new URLSearchParams(formData);
                params.append('page', currentPage);
                
                // âœ… [ìˆ˜ì •] ë¶ˆí•„ìš”í•˜ê³  ì˜¤ë¥˜ë¥¼ ìœ ë°œí–ˆë˜ ifë¬¸ì„ ì™„ì „íˆ ì‚­ì œí•©ë‹ˆë‹¤.
                // ì´ì œ í¼ì— ìˆëŠ” 'searchValue'ê°€ ê·¸ëŒ€ë¡œ ë°±ì—”ë“œì— ì „ë‹¬ë©ë‹ˆë‹¤.

                const endpoint = (currentView === 'stats') ? '/api/admin/search/stats' : '/api/admin/search/logs';
                
                try {
                    const response = await fetch(`${endpoint}?${params.toString()}`);
                    if (!response.ok) throw new Error(`${currentView} data load failed`);
                    
                    const data = await response.json();
                    
                    if (currentView === 'stats') {
                        renderStats(data.statsList);
                        renderPagination(statsPagination, data.pagination, data.statsList.length);
                        statsTotalInfo.innerHTML = `ì´ <b class="text-brand">${data.pagination.totalRecordCount}</b>ê°œì˜ í‚¤ì›Œë“œ í†µê³„ì…ë‹ˆë‹¤.`;
                    } else {
                        renderLogs(data.logList);
                        renderPagination(logPagination, data.pagination, data.logList.length);
                        logTotalInfo.innerHTML = `ì´ <b class="text-brand">${data.pagination.totalRecordCount}</b>ê±´ì˜ ê²€ìƒ‰ ê¸°ë¡ì´ ê²€ìƒ‰ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                    }
                } catch (error) {
                    console.error(error);
                    const tableBody = (currentView === 'stats') ? statsTableBody : logTableBody;
                    const colspan = (currentView === 'stats') ? 3 : 5;
                    tableBody.innerHTML = `<tr><td colspan="${colspan}">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>`;
                }
            }
            
            // ===== 4. ë Œë”ë§ í•¨ìˆ˜ (ê¸°ì¡´ ì½”ë“œ ì¬í™œìš© ë° ê°œì„ ) =====
            function renderStats(statsList) {
                statsTableBody.innerHTML = '';
                if (!statsList || statsList.length === 0) {
                    statsTableBody.innerHTML = '<tr><td colspan="3">í†µê³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }
                const startRank = (currentPage - 1) * 10 + 1; // ê°€ì •: í˜ì´ì§€ë‹¹ 10ê°œ
                statsList.forEach((stat, index) => {
                    statsTableBody.innerHTML += `<tr><td>${startRank + index}</td><td>${stat.srchKeywordNm}</td><td>${stat.searchCount}</td></tr>`;
                });
            }

            function renderLogs(logList) {
                logTableBody.innerHTML = '';
                if (!logList || logList.length === 0) {
                    logTableBody.innerHTML = '<tr><td colspan="5">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }
                logList.forEach(log => {
                    logTableBody.innerHTML += `<tr><td>${log.srchLogId}</td><td>${log.userNo || 'ë¹„íšŒì›'}</td><td>${log.srchKeywordNm}</td><td>${new Date(log.srchDt).toLocaleString()}</td><td>${log.srchUserIpAddr}</td></tr>`;
                });
            }

         // ì´ í•¨ìˆ˜ë§Œ ì•„ë˜ ë‚´ìš©ìœ¼ë¡œ í†µì§¸ë¡œ ë°”ê¿”ì£¼ì„¸ìš”.
            function renderPagination(container, pagination, listSize) {
                container.innerHTML = '';
                // âœ… [ìˆ˜ì •] pagination ê°ì²´ê°€ ì—†ê±°ë‚˜, ëª©ë¡ ì‚¬ì´ì¦ˆê°€ 0ì´ë©´ í˜ì´ì§€ë„¤ì´ì…˜ì„ ê·¸ë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤.
                if (!pagination || listSize === 0) return;
                
                // ì´ì „ í˜ì´ì§€ ë²„íŠ¼
                // âœ… [ìˆ˜ì •] í˜„ì¬ í˜ì´ì§€(currentPage)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°í•©ë‹ˆë‹¤.
                const prevPage = pagination.currentPage - 1;
                const prevDisabled = !pagination.existPrevBlock && pagination.currentPage === 1 ? 'disabled' : '';
                container.innerHTML += `<li class="page-item ${prevDisabled}"><a class="page-link" href="#" data-page="${prevPage}">ì´ì „</a></li>`;

                // í˜ì´ì§€ ë²ˆí˜¸
                for (let i = pagination.startPage; i <= pagination.endPage; i++) {
                    const activeClass = (i === pagination.currentPage) ? 'active' : '';
                    container.innerHTML += `<li class="page-item ${activeClass}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
                }

                // ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼
                // âœ… [ìˆ˜ì •] í˜„ì¬ í˜ì´ì§€(currentPage)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°í•©ë‹ˆë‹¤.
                const nextPage = pagination.currentPage + 1;
                const nextDisabled = !pagination.existNextBlock && pagination.currentPage === pagination.lastPage ? 'disabled' : '';
                container.innerHTML += `<li class="page-item ${nextDisabled}"><a class="page-link" href="#" data-page="${nextPage}">ë‹¤ìŒ</a></li>`;
            }

            // ===== 5. í˜ì´ì§€ ìµœì´ˆ ë¡œë”© =====
            loadData();
        });
    </script>
</th:block>
</html>