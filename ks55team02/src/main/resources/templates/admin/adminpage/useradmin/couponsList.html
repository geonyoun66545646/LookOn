<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{admin/layout/layoutMain}">

<head>
<title>쿠폰 목록/관리</title>
<link rel="stylesheet"
	th:href="@{/admincss/assets/customadmincss/couponsList.css}">
</head>

<th:block layout:fragment="contents">
	<main class="main-content">
		<section class="content-header">
			<h2 class="content-title">쿠폰 목록 조회</h2>
		</section>

		<div class="card mb-4">
			<div class="card-body">
				<form id="couponSearchForm" action="#" method="get">
					<div class="row gx-3 align-items-end">

						<div class="col-lg-4 mb-3">
							<label class="form-label">유효 기간</label>
							<div class="d-flex">
								<input type="date" class="form-control" name="vldBgngDt"
									value="2023-01-01"> <span
									class="mx-2 d-flex align-items-center">~</span> <input
									type="date" class="form-control" name="vldEndDt"
									value="2023-12-31">
							</div>
						</div>

						<div class="col-lg-4 mb-3">
							<label class="form-label">검색 키워드</label>
							<div class="input-group">
								<select class="form-select" name="searchKey"
									style="max-width: 150px;">
									<option value="all" selected>전체</option>
									<option value="cpnNm">쿠폰명</option>
									<option value="pblcnCpnId">쿠폰 ID</option>
									<option value="userNo">발행자 ID</option>
									<option value="issueConditionType">발급 조건</option>
								</select> <input type="text" class="form-control" name="searchValue"
									value="" placeholder="쿠폰명, ID, 발행자 ID">
							</div>
						</div>

						<div class="col-lg-2 mb-3">
							<label for="actvtnYn" class="form-label">활성 여부</label> <select
								class="form-select" id="actvtnYn" name="actvtnYn">
								<option value="">-- 전체 --</option>
								<option value="1" selected>활성</option>
								<option value="0">비활성</option>
							</select>
						</div>

						<div class="col-lg-2 mb-3 d-flex align-items-end">
							<a href="#" class="btn btn-primary btn-block me-2" id="searchBtn">검색</a>
							<button class="btn btn-light btn-block" type="reset">초기화</button>
						</div>
					</div>
				</form>
			</div>
		</div>

		<div class="card">
			<div class="card-body">
				<div class="d-flex justify-content-between align-items-center mb-3">

					<div class="d-flex align-items-center">
						<span class="font-weight-bold"> [ 전체 쿠폰 <span
							class="text-primary" id="total-coupons-count"> 0 </span> 건 ]
						</span>
					</div>

					<div class="coupons-ct-dt-btn">
						<a th:href="@{/adminpage/useradmin/createCoupons}"
							class="btn btn-primary" id="create-coupon-btn">신규 쿠폰 생성</a> <a
							href="javascript:void(0);" class="btn btn-danger"
							id="delete-selected-btn">신규 쿠폰 생성</a>
					</div>

				</div>

				<table class="table table-hover text-center">
					<thead class="thead-light">
						<tr>
							<th><div class="form-check">
									<input class="form-check-input" type="checkbox"
										id="checkAllRows">
								</div></th>
							<th>쿠폰 ID</th>
							<th>쿠폰명</th>
							<th>할인 값</th>
							<th>최소 주문 금액</th>
							<th>최대 할인 금액</th>
							<th>유효 기간</th>
							<th>총 발급 제한</th>
							<th>사용자당 제한</th>
							<th>발급 조건</th>
							<th>재발급 주기</th>
							<th>활성 여부</th>
							<th>등록일자</th>
							<th>수정/삭제</th>
						</tr>
					</thead>

					<tbody id="coupons-table-body">
					</tbody>

				</table>

				<table class="table table-hover text-center">
					<thead class="thead-light">
					</thead>
					<tbody id="coupons-table-body">
					</tbody>
				</table>

				<nav id="pagination-container"
					class="d-flex justify-content-center mt-4"
					aria-label="Page navigation">
					<ul class="pagination">
					</ul>
				</nav>
			</div>
		</div>
	</main>
</th:block>

<th:block layout:fragment="jsScript">
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

	<script>
    // 페이지가 처음 로드될 때 1페이지의 데이터를 자동으로 가져옵니다.
    document.addEventListener('DOMContentLoaded', () => {
        getCoupons(1); // 초기 로드 시 1페이지 데이터 가져오기

        // 검색 버튼 이벤트 리스너
        document.getElementById('searchBtn').addEventListener('click', (event) => {
            event.preventDefault(); // 기본 폼 제출 방지
            getCoupons(1); // 검색 시 항상 1페이지부터 시작
        });
    });

    // [수정] getCoupons 함수는 변경 없습니다.
    function getCoupons(page) {
        const form = document.getElementById('couponSearchForm');
        const formData = new FormData(form);
        const params = new URLSearchParams();

        // 폼 데이터를 URLSearchParams에 추가
        for (const [key, value] of formData.entries()) {
            params.append(key, value);
        }
        // 페이지 번호 추가
        params.append('page', page);

        console.log("Fetching coupons for page:", page, "with params:", params.toString());

        fetch(`/adminpage/useradmin/api/coupons?${params.toString()}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Received data:", data);

                // total-coupons-count 업데이트
                document.getElementById('total-coupons-count').textContent = data.pagination && data.pagination.totalRecordCount !== undefined ? data.pagination.totalRecordCount : '0';
                
                renderTable(data.couponsList);
                renderPagination(data.pagination); // 페이지네이션 UI 동적 업데이트
            })
            .catch(error => console.error('Error fetching coupons:', error));
    }
    
    // 테이블을 그리는 함수 (변경 없음)
    function renderTable(couponsList) {
        const tableBody = document.getElementById('coupons-table-body');
        tableBody.innerHTML = ''; // 기존 내용을 깨끗이 비웁니다.

        if (!couponsList || couponsList.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="14" class="text-center py-5">조회된 쿠폰 정보가 없습니다.</td></tr>`;
            return;
        }

        couponsList.forEach(coupon => {
            const row = `
                <tr id="coupon-row-${coupon.pblcnCpnId}">
                    <td><div class="form-check"><input class="form-check-input" type="checkbox" class="coupon-checkbox" value="${coupon.pblcnCpnId}"></div></td>
                    <td>${coupon.pblcnCpnId}</td>
                    <td>${coupon.cpnNm || ''}</td>
                    <td>${coupon.dscntVl || 0}%</td>
                    <td>${(coupon.minOrdrAmt || 0).toLocaleString()}원</td>
                    <td>${(coupon.maxDscntAmt || 0).toLocaleString()}원</td>
                    <td>${formatDate(coupon.vldBgngDt)} ~ ${formatDate(coupon.vldEndDt)}</td>
                    <td>${coupon.totUseLmtNmtm === 0 ? '무제한' : coupon.totUseLmtNmtm + '회'}</td>
                    <td>${coupon.userPerUseLmtNmtm}회</td>
                    <td>${coupon.issueConditionType || ''}</td>
                    <td>${coupon.reissueCycle || ''}</td>
                    <td>${coupon.actvtnYn ? '<span class="badge bg-success">활성</span>' : '<span class="badge bg-danger">비활성</span>'}</td>
                    <td>${formatDate(coupon.crtDt)}</td>
                    <td>
                        <a href="/adminpage/useradmin/editCoupons/${coupon.pblcnCpnId}" class="btn btn-sm btn-outline-dark">수정</a>
                        <a href="javascript:void(0);" onclick="confirmDelete('${coupon.pblcnCpnId}')" class="btn btn-sm btn-outline-danger">삭제</a>
                    </td>
                </tr>`;
            tableBody.insertAdjacentHTML('beforeend', row);
        });
    }
    
    // 날짜 포맷팅 함수 (변경 없음)
    function formatDate(dateString) {
        if (!dateString) return '';
        return dateString.substring(0, 10);
    }
    
    // 개별 삭제 함수 (변경 없음)
    function confirmDelete(couponId) {
        Swal.fire({
            title: "정말로 삭제하시겠습니까?",
            text: "이 쿠폰은 비활성화 상태로 변경됩니다.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#3085d6",
            confirmButtonText: "삭제",
            cancelButtonText: "취소"
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = `/adminpage/useradmin/deleteCoupons/${couponId}`;
            }
        });
    }
    
    /**
     * ======================================================
     * [최종 수정] 페이지네이션 버튼들을 그리는 함수
     * - Pagination.java 로직은 그대로 유지하고,
     * - '이전'과 '다음' 버튼의 활성화 여부를 currentPage 기준으로 판단합니다.
     * ======================================================
     */
    function renderPagination(pagination) {
        const pageContainer = document.querySelector('#pagination-container .pagination');
        pageContainer.innerHTML = ''; // 기존 페이지 번호를 깨끗이 비웁니다.

        if (!pagination || pagination.totalPageCount === 0) {
            return;
        }

        let paginationHtml = '';

        // '이전' 버튼
        // ⭐ 이 부분을 수정합니다: existPrevBlock 대신 currentPage > 1을 사용 ⭐
        if (pagination.currentPage > 1) { // 현재 페이지가 1보다 크면 '이전' 버튼 활성화
            paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="event.preventDefault(); getCoupons(${pagination.currentPage - 1});">이전</a></li>`;
        } else {
            paginationHtml += `<li class="page-item disabled"><a class="page-link" href="#">이전</a></li>`;
        }

        // 페이지 번호 버튼들
        for (let i = pagination.startPage; i <= pagination.endPage; i++) {
            paginationHtml += `<li class="page-item ${i === pagination.currentPage ? 'active' : ''}">
                                     <a class="page-link" href="#" onclick="event.preventDefault(); getCoupons(${i});">${i}</a>
                                   </li>`;
        }

        // '다음' 버튼
        // 현재 페이지가 전체 페이지 수보다 작으면 '다음' 버튼 활성화 (이전과 동일)
        if (pagination.currentPage < pagination.totalPageCount) {
            paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="event.preventDefault(); getCoupons(${pagination.currentPage + 1});">다음</a></li>`;
        } else {
            paginationHtml += `<li class="page-item disabled"><a class="page-link" href="#">다음</a></li>`;
        }
        
        pageContainer.innerHTML = paginationHtml;
    }
</script>
</th:block>
</html>