<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{seller/layout/layout_main}"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${title}"></title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .sales-summary-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
        }
        .summary-item {
            text-align: center;
            padding: 10px;
            flex-basis: 30%; /* 3개 항목이 한 줄에 오도록 */
            min-width: 150px; /* 너무 작아지지 않게 */
        }
        .summary-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #28a745; /* 매출 강조 */
            margin-bottom: 5px;
        }
        .summary-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .top-selling-products {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .top-selling-products h5 {
            margin-bottom: 15px;
        }
        .top-selling-products ul {
            list-style: none;
            padding: 0;
        }
        .top-selling-products li {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        .top-selling-products li:last-child {
            border-bottom: none;
        }
        .sales-table {
            table-layout: fixed;
            width: 100%;
        }
        .sales-table th, .sales-table td {
            vertical-align: middle;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        /* 컬럼 비율 조정 */
        .sales-table .col-order-id { width: 15%; }
        .sales-table .col-buyer { width: 15%; }
        .sales-table .col-item-name { width: 25%; }
        .sales-table .col-quantity { width: 10%; }
        .sales-table .col-price { width: 10%; }
        .sales-table .col-total-price { width: 10%; }
        .sales-table .col-order-date { width: 15%; }

        .detail-panel {
            display: none; /* 초기에는 숨김 */
            margin-top: 20px;
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
        }
        .pagination-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .pagination-link {
            display: inline-block;
            padding: 8px 12px;
            margin: 0 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-decoration: none;
            color: #007bff;
        }
        .pagination-link.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .pagination-link.disabled {
            color: #6c757d;
            pointer-events: none;
            background-color: #e9ecef;
        }
    </style>
</head>
<body>
<th:block layout:fragment="contents">
    <section class="content-main">
        <div class="content-header">
            <div>
                <h2 class="content-title card-title" th:text="${title}"></h2>
                <p>상점의 판매 내역과 실적을 확인하고 관리할 수 있습니다.</p>
            </div>
        </div>

        <div class="sales-summary-card">
            <div class="summary-item">
                <div class="summary-value" th:text="${#numbers.formatInteger(totalSalesCount, 0, 'COMMA')}">0</div>
                <div class="summary-label">총 판매 건수</div>
            </div>
            <div class="summary-item">
                <div class="summary-value" th:text="${#numbers.formatCurrency(totalSalesAmount) + '원'}">0원</div>
                <div class="summary-label">총 판매 금액 (매출)</div>
            </div>
            <div class="summary-item">
                <div class="summary-value">Top 5</div>
                <div class="summary-label">인기 상품</div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-4">
                <div class="top-selling-products">
                    <h5 class="card-title">가장 많이 팔린 상품 (Top 5)</h5>
                    <div th:if="${#lists.isEmpty(topSellingProducts)}" class="text-center text-muted">
                        판매된 상품이 없습니다.
                    </div>
                    <ul th:unless="${#lists.isEmpty(topSellingProducts)}">
                        <li th:each="product : ${topSellingProducts}">
                            <span th:text="${product.goods_name}">상품명</span>
                            <span class="fw-bold" th:text="${product.total_quantity_sold} + '개'">수량</span>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="card mb-4">
                    <header class="card-header">
                        <div class="row gx-3">
                            <div class="col-lg-6 col-md-6">
                                <form th:action="@{/seller/sales/salesHistory}" method="get" class="search-form">
                                    <div class="input-group">
                                        <select class="form-select" name="searchKey" aria-label="검색 조건">
                                            <option value="">전체</option>
                                            <option value="orderId" th:selected="${searchKey == 'orderId'}">주문 ID</option>
                                            <option value="goodsName" th:selected="${searchKey == 'goodsName'}">상품명</option>
                                            <option value="orderStatus" th:selected="${searchKey == 'orderStatus'}">주문 상태</option>
                                            </select>
                                        <input type="text" placeholder="검색어 입력" class="form-control" name="searchValue" th:value="${searchValue}">
                                        <button class="btn btn-primary" type="submit">검색</button>
                                    </div>
                                    <div class="input-group mt-2">
                                        <input type="date" class="form-control" name="startDate" th:value="${startDate}">
                                        <span class="input-group-text">~</span>
                                        <input type="date" class="form-control" name="endDate" th:value="${endDate}">
                                        <button class="btn btn-secondary" type="submit">기간 조회</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </header>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover sales-table">
                                <thead>
                                    <tr>
                                        <th scope="col" class="col-order-id">주문 ID</th>
                                        <th scope="col" class="col-buyer">주문자</th>
                                        <th scope="col" class="col-item-name">상품명</th>
                                        <th scope="col" class="col-quantity">수량</th>
                                        <th scope="col" class="col-price text-end">단가</th>
                                        <th scope="col" class="col-total-price text-end">총 금액</th>
                                        <th scope="col" class="col-order-date">주문일자</th>
                                        <th scope="col" class="text-center">상태</th>
                                        <th scope="col" class="text-center">상세</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:if="${#lists.isEmpty(salesHistory)}">
                                        <td colspan="9" class="text-center text-muted py-4">판매 내역이 없습니다.</td>
                                    </tr>
                                    <tr th:each="order : ${salesHistory}">
                                        <td th:text="${order.orderId}"></td>
                                        <td th:text="${order.userName}"></td>
                                        <td>
                                            <span th:if="${#lists.size(order.orderItems) == 1}" th:text="${order.orderItems[0].goodsName}">단일 상품</span>
                                            <span th:if="${#lists.size(order.orderItems) > 1}" th:text="${order.orderItems[0].goodsName} + ' 외 ' + (${#lists.size(order.orderItems) - 1}) + '개'">여러 상품</span>
                                        </td>
                                        <td>
                                            <span th:if="${#lists.size(order.orderItems) == 1}" th:text="${order.orderItems[0].quantity}"></span>
                                            <span th:if="${#lists.size(order.orderItems) > 1}" th:text="${#lists.sum(order.orderItems.![quantity])}"></span>
                                        </td>
                                        <td class="text-end">
                                            <span th:if="${#lists.size(order.orderItems) == 1}" th:text="${#numbers.formatCurrency(order.orderItems[0].pricePerItem) + '원'}"></span>
                                            <span th:if="${#lists.size(order.orderItems) > 1}">-</span> </td>
                                        <td class="text-end fw-bold" th:text="${#numbers.formatCurrency(order.totalPrice) + '원'}"></td>
                                        <td th:text="${order.orderDate}"></td>
                                        <td class="text-center">
                                            <span class="badge rounded-pill"
                                                  th:classappend="${order.orderStatus == '결제완료' ? 'alert-success' : (order.orderStatus == '주문취소' ? 'alert-danger' : 'alert-warning')}"
                                                  th:text="${order.orderStatus}">상태</span>
                                            </td>
                                        <td class="text-center">
                                            <button class="btn btn-sm btn-outline-info detail-view-btn" th:data-order-id="${order.orderId}">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination-container">
                            <nav>
                                <ul class="pagination">
                                    <li class="page-item" th:classappend="${currentPage == 1 ? 'disabled' : ''}">
                                        <a class="page-link" th:href="@{/seller/sales/salesHistory(currentPage=1, searchKey=${searchKey}, searchValue=${searchValue}, startDate=${startDate}, endDate=${endDate})}">처음</a>
                                    </li>
                                    <li class="page-item" th:classappend="${currentPage == 1 ? 'disabled' : ''}">
                                        <a class="page-link" th:href="@{/seller/sales/salesHistory(currentPage=${currentPage - 1}, searchKey=${searchKey}, searchValue=${searchValue}, startDate=${startDate}, endDate=${endDate})}">이전</a>
                                    </li>
                                    <li class="page-item" th:each="pageNumber : ${#numbers.sequence(startPage, endPage)}"
                                        th:classappend="${pageNumber == currentPage ? 'active' : ''}">
                                        <a class="page-link" th:href="@{/seller/sales/salesHistory(currentPage=${pageNumber}, searchKey=${searchKey}, searchValue=${searchValue}, startDate=${startDate}, endDate=${endDate})}" th:text="${pageNumber}"></a>
                                    </li>
                                    <li class="page-item" th:classappend="${currentPage == lastPage ? 'disabled' : ''}">
                                        <a class="page-link" th:href="@{/seller/sales/salesHistory(currentPage=${currentPage + 1}, searchKey=${searchKey}, searchValue=${searchValue}, startDate=${startDate}, endDate=${endDate})}">다음</a>
                                    </li>
                                    <li class="page-item" th:classappend="${currentPage == lastPage ? 'disabled' : ''}">
                                        <a class="page-link" th:href="@{/seller/sales/salesHistory(currentPage=${lastPage}, searchKey=${searchKey}, searchValue=${searchValue}, startDate=${startDate}, endDate=${endDate})}">마지막</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="orderDetailPanel" class="detail-panel">
            <h5 class="card-title mb-3">주문 상세 정보 <button class="btn btn-sm btn-outline-secondary float-end" id="closeDetailPanel">닫기</button></h5>
            <div id="orderDetailContent">
                </div>
        </div>
    </section>

    <script th:inline="javascript">
        /*<![CDATA[*/
        document.addEventListener('DOMContentLoaded', function() {
            const detailViewButtons = document.querySelectorAll('.detail-view-btn');
            const orderDetailPanel = document.getElementById('orderDetailPanel');
            const orderDetailContent = document.getElementById('orderDetailContent');
            const closeDetailPanel = document.getElementById('closeDetailPanel');

            detailViewButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const orderId = this.dataset.orderId;
                    console.log("상세 보기 버튼 클릭. 주문 ID:", orderId);

                    // 해당 주문의 상세 정보를 찾아 표시 (현재 페이지의 data 사용)
                    const salesHistory = /*[[${salesHistory}]]*/ [];
                    const selectedOrder = salesHistory.find(order => order.orderId === orderId);

                    if (selectedOrder) {
                        let htmlContent = `
                            <p><strong>주문 ID:</strong> ${selectedOrder.orderId}</p>
                            <p><strong>주문일자:</strong> ${selectedOrder.orderDate}</p>
                            <p><strong>총 결제 금액:</strong> ${formatCurrency(selectedOrder.totalPrice)}원</p>
                            <p><strong>주문 상태:</strong> ${selectedOrder.orderStatus}</p>
                            <p><strong>주문자:</strong> ${selectedOrder.userName}</p>
                            <p><strong>수령인:</strong> ${selectedOrder.receiverName}</p>
                            <p><strong>수령인 연락처:</strong> ${selectedOrder.receiverPhone}</p>
                            <p><strong>수령인 주소:</strong> ${selectedOrder.receiverAddr}</p>
                            <h6 class="mt-4">주문 상품 목록:</h6>
                            <table class="table table-bordered table-sm">
                                <thead>
                                    <tr>
                                        <th>상품명</th>
                                        <th>수량</th>
                                        <th class="text-end">단가</th>
                                        <th class="text-end">총 금액</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        selectedOrder.orderItems.forEach(item => {
                            htmlContent += `
                                <tr>
                                    <td>${item.goodsName}</td>
                                    <td>${item.quantity}</td>
                                    <td class="text-end">${formatCurrency(item.pricePerItem)}원</td>
                                    <td class="text-end">${formatCurrency(item.itemTotalPrice)}원</td>
                                </tr>
                            `;
                        });
                        htmlContent += `
                                </tbody>
                            </table>
                        `;
                        orderDetailContent.innerHTML = htmlContent;
                        orderDetailPanel.style.display = 'block';
                        orderDetailPanel.scrollIntoView({ behavior: 'smooth' }); // 상세 정보 패널로 스크롤 이동
                    } else {
                        Swal.fire('오류', '주문 정보를 찾을 수 없습니다.', 'error');
                    }
                });
            });

            closeDetailPanel.addEventListener('click', () => {
                orderDetailPanel.style.display = 'none';
            });

            // 금액 포맷팅 함수 (settlementHistory.html에서 가져옴)
            function formatCurrency(amount) {
                if (amount === null || typeof amount === 'undefined') {
                    return '0';
                }
                const number = parseFloat(amount);
                return number.toLocaleString('ko-KR'); // 한국 통화 형식
            }
        });
        /*]]>*/
    </script>
</th:block>
</body>
</html>