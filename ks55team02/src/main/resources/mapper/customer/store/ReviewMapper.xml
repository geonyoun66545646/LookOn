<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ks55team02.customer.store.mapper.ReviewMapper">

    <resultMap id="productReviewResultMap" 		type="ks55team02.common.domain.store.ProductReview">
        <id property="reviewId" 				column="review_id"/>
        <result property="ordrDtlArtclNo" 		column="ordr_dtl_artcl_no"/>
        <result property="prchsrUserNo" 		column="prchsr_user_no"/>
        <result property="gdsNo" 				column="gds_no"/>
        <result property="ordrNo" 				column="ordr_no"/>
        <result property="evlScr" 				column="evl_scr"/>
        <result property="reviewCn" 			column="review_cn"/>
        <result property="wrtYmd" 				column="wrt_ymd"/>
        <result property="reviewStts" 			column="review_stts"/>
        <result property="lastMdfcnDt" 			column="last_mdfcn_dt"/>
        <result property="delDt" 				column="del_dt"/>
        <result property="delPrcrNo" 			column="del_prcr_no"/>
        <result property="helpdCnt" 			column="helpd_cnt"/>
        <result property="starRating" 			column="star_rating"/>
        
        <association property="user" 			javaType="ks55team02.common.domain.inquiry.InquiryUser">
		<id property="userNo" 					column="user_no"/>
        <result property="userNm" 				column="user_nm"/>
        <result property="userNcnm" 			column="user_ncnm"/>        
        </association>
        <association property="userProfile" 	javaType="ks55team02.customer.register.domain.UserProfile">
        <id property="userNo" 					column="user_no"/>
        <result property="prflImg" 				column="prfl_img"/>
        </association>
        
        <collection property="reviewImages" ofType="ks55team02.common.domain.store.ReviewImage">
        <id property="reviewImgId" column="review_img_id"/>
        <result property="imgId" column="img_id"/>
        <result property="ord" column="ord"/>
        <association property="storeImage" javaType="ks55team02.common.domain.store.StoreImage">
        <id property="imgId" column="img_id"/>
        <result property="imgAddr" column="img_addr"/>
        <result property="imgFileNm" column="img_file_nm"/>
        </association>
    	</collection>
        
    </resultMap>

    <resultMap id="reviewImageResultMap" 		type="ks55team02.common.domain.store.ReviewImage">
        <id property="reviewImgId" 				column="review_img_id"/>
        <result property="reviewId" 			column="review_id"/>
        <result property="imgId" 				column="img_id"/>
        <result property="ord" 					column="ord"/>
        
        <association property="storeImage" 		javaType="ks55team02.seller.products.domain.ProductImage">
            <id property="imgId" 				column="img_id"/>
            <result property="gdsNo" 			column="gds_no"/> 
            <result property="imgPath" 			column="img_path"/> 
            <result property="imgOrgNm" 		column="img_org_nm"/>
            <result property="imgUuidNm" 		column="img_uuid_nm"/>
        </association>
    </resultMap>


    <select id="selectReviewsByProductCode" parameterType="String" resultMap="productReviewResultMap">
    SELECT
        pr.review_id,
        pr.ordr_dtl_artcl_no,
        pr.prchsr_user_no,
        pr.gds_no,
        pr.ordr_no,
        pr.evl_scr,
        pr.review_cn,
        pr.wrt_ymd,
        pr.review_stts,
        pr.helpd_cnt,
        pr.star_rating,
        u.user_nm,
        u.user_ncnm,
        up.prfl_img,
        ri.review_img_id,
        ri.img_id,
        ri.ord,
        si.img_addr,     
        si.img_file_nm
    FROM
        ks55team02db.product_reviews AS pr
    JOIN
        ks55team02db.users AS u ON pr.prchsr_user_no = u.user_no
    LEFT JOIN
        ks55team02db.user_profiles AS up ON u.user_no = up.user_no
    -- LEFT JOIN을 사용해야 이미지가 없는 리뷰도 조회됨
    LEFT JOIN
        ks55team02db.review_images AS ri ON pr.review_id = ri.review_id
    LEFT JOIN
        ks55team02db.store_images AS si ON ri.img_id = si.img_id
    WHERE
        pr.gds_no = #{gdsNo}
        AND pr.review_stts = 1
    ORDER BY
        pr.wrt_ymd DESC, ri.ord ASC;
	</select>
	
	<!--    리뷰 인서트     -->
	<select id="findReviewableOrderItem" resultType="String">
    SELECT
        oi.ordr_dtl_artcl_no
    FROM
        orders o
    JOIN
        order_items oi ON o.ordr_no = oi.ordr_no
    WHERE
        o.user_no = #{userNo}
      AND
        o.ordr_no = #{ordrNo}
      AND
        oi.gds_no = #{gdsNo}
      AND
        oi.ordr_dtl_artcl_dcsn_cd = 'ORDERED' -- 상태 체크 조건 추가!
    LIMIT 1
	</select>
<!-- [2] 중복 리뷰 검사를 위한 쿼리 -->
<select id="countReviewByOrderItem" resultType="int">
    SELECT
        COUNT(*)
    FROM
        product_reviews
    WHERE
        ordr_dtl_artcl_no = #{ordrDtlArtclNo}
</select>

<!-- [3] 리뷰 데이터를 INSERT 하는 쿼리 -->
<insert id="insertReview" parameterType="ks55team02.common.domain.store.ProductReview">
    INSERT INTO product_reviews (
        review_id,
        ordr_dtl_artcl_no,
        prchsr_user_no,
        gds_no,
        ordr_no,
        evl_scr,
        review_cn,
        review_stts,
        wrt_ymd,
        helpd_cnt
    ) VALUES (
        #{reviewId},
        #{ordrDtlArtclNo},
        #{prchsrUserNo},
        #{gdsNo},
        #{ordrNo},
        #{evlScr},
        #{reviewCn},
        '1',  -- 리뷰 상태: '1'이 '게시됨' 또는 '전시중'을 의미한다고 가정
        NOW(),
        0
    )
</insert>

<select id="findMaxReviewIdNumber" resultType="Integer">
    SELECT
        MAX(CAST(SUBSTRING_INDEX(review_id, '_', -1) AS UNSIGNED))
    FROM
        product_reviews
</select>

<!-- [추가] 특정 사용자가 특정 상품에 대해 리뷰를 작성할 수 있는 '주문'을 조회하는 쿼리 -->
<!-- 가장 최근 주문 건 하나만 가져오도록 LIMIT 1을 사용합니다. -->
<select id="findReviewableOrder" resultType="ks55team02.orderproduct.domain.OrderDTO">
    SELECT
	    O.ordr_no AS ordrNo,
	    O.ordr_dt AS ordrDt
	FROM
	    orders O
	INNER JOIN
	    order_items OI ON O.ordr_no = OI.ordr_no
	WHERE
	    O.user_no = #{userNo}
	  AND OI.gds_no = #{gdsNo}
	  AND OI.ordr_dtl_artcl_dcsn_cd = 'ORDERED'
	  AND NOT EXISTS ( 
	        SELECT 1
	        FROM product_reviews PR
	        WHERE PR.ordr_dtl_artcl_no = OI.ordr_dtl_artcl_no
	  )
	ORDER BY
	    O.ordr_dt DESC
	LIMIT 1;
</select>

<!-- StoreImage 배치 삽입 -->
<insert id="addStoreImages" parameterType="java.util.List">
    INSERT INTO store_images (
        img_id,
        img_file_nm,
        img_addr,
        img_file_sz,
        img_type_cd,
        reg_ymd,
        del_yn
    ) VALUES
    <foreach collection="list" item="storeImage" separator=",">
    (
        #{storeImage.imgId},
        #{storeImage.imgFileNm},
        #{storeImage.imgAddr},
        #{storeImage.imgFileSz},
        #{storeImage.imgTypeCd},
        #{storeImage.regYmd},
        #{storeImage.delYn}
    )
    </foreach>
</insert>

<!-- ReviewImage 배치 삽입 -->
<insert id="addReviewImages" parameterType="java.util.List">
    INSERT INTO review_images (
        review_img_id,
        review_id,
        img_id,
        ord
    ) VALUES
    <foreach collection="list" item="reviewImage" separator=",">
    (
        #{reviewImage.reviewImgId},
        #{reviewImage.reviewId},
        #{reviewImage.imgId},
        #{reviewImage.ord}
    )
    </foreach>
</insert>

</mapper>