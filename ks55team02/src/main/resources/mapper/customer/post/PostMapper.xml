<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ks55team02.customer.post.mapper.PostMapper">
	<resultMap type="Post" id="postResultMap">
		<id 	column="pst_sn" 		property="pstSn"></id>
		<result column="bbs_clsf_cd" 	property="bbsClsfCd"></result>
		<result column="wrtr_user_no" 	property="wrtrUserNo"></result>
		<result column="pst_ttl" 		property="pstTtl"></result>
		<result column="pst_cn" 		property="pstCn"></result>
		<result column="inq_cnt" 		property="inqCnt"></result>
		<result column="ntc_pst_yn" 	property="ntcPstYn"></result>
		<result column="crt_dt" 		property="crtDt"></result>
		<result column="mdfcn_dt" 		property="mdfcnDt"></result>
		<result column="del_dt" 		property="delDt"></result>
		
		<association property="userInfo" javaType="UserList">
		    <id     column="user_no"            property="userNo"/>
		    <result column="mbr_grd_cd"         property="mbrGrdCd"/>
		    <result column="user_lgn_id"        property="userLgnId"/>
		    <result column="user_nm"            property="userNm"/>
		    <result column="gender_se_cd"       property="genderSeCd"/>
		    <result column="eml_addr"           property="emlAddr"/>
		    <result column="telno"              property="telno"/>
		    <result column="user_brdt"          property="userBrdt"/>
		    <result column="zip_cd"             property="zipCd"/>
		    <result column="addr"               property="addr"/>
		    <result column="daddr"              property="daddr"/>
		    <result column="user_ncnm"          property="userNcnm"/>
		    <result column="user_status"        property="userStatus"/>
		    <result column="join_dt"            property="joinDt"/>
		    <result column="whdwl_dt"           property="whdwlDt"/>
		    <result column="last_info_mdfcn_dt" property="lastInfoMdfcnDt"/>
		    <result column="last_login_dt"      property="lastLoginDt"/>
		</association>
	</resultMap>
	
	<select id="selectPostListByBoardCd" parameterType="Post" resultMap="postResultMap">
		/* 게시판 글 목록 조회 */
        SELECT
            p.pst_sn,
            p.bbs_clsf_cd,
            p.pst_ttl,
            p.pst_cn,
            p.inq_cnt,
            p.ntc_pst_yn,
            p.crt_dt,
            p.mdfcn_dt,
            p.del_dt,
            b.bbs_nm,
            u.user_ncnm,
            (SELECT COUNT(pc.pst_cmnt_sn) FROM post_comments pc WHERE pc.pst_sn = p.pst_sn AND pc.del_dt IS NULL) AS commentCount,
            (SELECT COUNT(pi.pst_intract_sn) FROM post_interactions pi WHERE pi.pst_sn = p.pst_sn AND pi.intract_type_cd = 'LIKE' AND pi.rtrcn_dt IS NULL) AS likesCount
        FROM 
        	posts p
        	JOIN boards b ON p.bbs_clsf_cd = b.bbs_clsf_cd
        	LEFT JOIN users u ON p.wrtr_user_no = u.user_no
        WHERE 
        	p.del_dt IS NULL
        	<if test="bbsClsfCd != null and bbsClsfCd != ''">
        		AND p.bbs_clsf_cd = #{bbsClsfCd}
        	</if>
        ORDER BY p.crt_dt DESC
        LIMIT #{limit} OFFSET #{offset}
	</select>

	<select id="selectPostListNumByBoardCd" resultType="int">
		/* 특정 게시판 게시글 갯수 조회 */
		SELECT
			COUNT(p.pst_sn)
		FROM
			posts p
		WHERE
			p.del_dt is null
			<if test="bbsClsfCd != null and bbsClsfCd != ''">
				AND p.bbs_clsf_cd = #{bbsClsfCd}
			</if>
	</select>
	
	<select id="selectPostDetailByPostSn" parameterType="String" resultMap="postResultMap">
		/* 특정 게시글 상세 조회 */
		SELECT
			p.pst_sn,
			p.bbs_clsf_cd,
			p.wrtr_user_no,
			p.pst_ttl,
			p.pst_cn,
			p.inq_cnt,
			p.ntc_pst_yn,
			p.crt_dt,
			p.mdfcn_dt,
			p.del_dt
		FROM
			posts p
		WHERE
			p.pst_sn = #{pstSn}
	</select>
	
	<select id="selectMaxPostNumber" resultType="Integer">
		/* 게시글 일련번호 생성 */
	    SELECT 
	    	MAX(CAST(SUBSTRING_INDEX(pst_sn, '_', -1) AS UNSIGNED))
	    FROM 
	    	posts p
	    WHERE 
	    	p.pst_sn REGEXP '^post_[0-9]+$'
	</select>
	
	<insert id="insertPost" parameterType="Post">
		/* 게시글 등록 */
		INSERT INTO posts
		(pst_sn,
		bbs_clsf_cd,
		wrtr_user_no,
		pst_ttl,
		pst_cn,
		inq_cnt,
		ntc_pst_yn,
		crt_dt,
		mdfcn_dt,
		del_dt)
		VALUES
		(
		#{pstSn},
		#{bbsClsfCd},
		'user_no_1',
		#{pstTtl},
		#{pstCn},
		0,
		0,
		Now(),
		null,
		null
		)
	</insert>
	
	<update id="updatePost" parameterType="Post">
		/* 게시글 수정 */
		UPDATE
			posts p
		SET
			p.bbs_clsf_cd = #{bbsClsfCd},
			p.pst_ttl = #{pstTtl},
			p.pst_cn = #{pstCn},
			p.mdfcn_dt = NOW()
		WHERE
			p.pst_sn = #{pstSn}
	</update>
	
	<update id="deletePost" parameterType="String">
		/* 특정 게시글 삭제 */
		UPDATE
			posts p
		SET
			p.del_dt = Now()
		WHERE
			p.pst_sn = TRIM(#{pstSn})
	</update>
</mapper>