<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="ks55team02.admin.adminpage.storeadmin.settlementdetailbystore.mapper.StoreSettlementMapper">
  
  	<!-- StoreSettlement DTO와 store_settlements 테이블 컬럼 매핑 -->
    <resultMap id="StoreSettlementResultMap" type="ks55team02.admin.adminpage.storeadmin.settlementdetailbystore.domain.StoreSettlementDTO">
        <id 	property="storeClclnId" column="store_clcln_id"/>
        <result property="storeId" 		column="store_id"/>
        <result property="plcyId" 		column="plcy_id"/>
        <result property="totSelAmt" 	column="tot_sel_amt"/>
        <result property="selFeeRt" 	column="sel_fee_rt"/>
        <result property="clclnAmt" 	column="clcln_amt"/>
        <result property="actnoId" 		column="actno_id"/>
        <result property="clclnPrcsYmd" column="clcln_prcs_ymd"/>
        <result property="clclnSttsCd" 	column="clcln_stts_cd"/>
    </resultMap>

    <!-- StoreSettlementListViewDTO와 조인된 컬럼 매핑 -->
    <resultMap id="StoreSettlementListViewResultMap" type="ks55team02.admin.adminpage.storeadmin.settlementdetailbystore.domain.StoreSettlementListViewDTO" extends="StoreSettlementResultMap">
        <result property="storeNm" column="store_conm"/>
    </resultMap>

    <select id="getAllStoreSettlementsForList" resultMap="StoreSettlementListViewResultMap">
    	/* 모든 상점의 정산 정보 목록 조회 (상점명 포함) */
        SELECT
            ss.store_clcln_id,
            ss.store_id,
            s.store_conm,          -- 상점명 조인
            ss.plcy_id,
            ss.tot_sel_amt,
            ss.sel_fee_rt,
            ss.clcln_amt,
            ss.actno_id,
            ss.clcln_prcs_ymd,
            ss.clcln_stts_cd
        FROM
            store_settlements ss INNER JOIN stores s 
            ON ss.store_id = s.store_id
        ORDER BY
            ss.clcln_prcs_ymd DESC, ss.store_clcln_id DESC
    </select>

    <select id="getSettlementHistoryByStoreId" parameterType="string" resultMap="StoreSettlementResultMap">
    	/* 특정 상점의 정산 내역 조회 */
        SELECT
            store_clcln_id,
            store_id,
            plcy_id,
            tot_sel_amt,
            sel_fee_rt,
            clcln_amt,
            actno_id,
            clcln_prcs_ymd,
            clcln_stts_cd
        FROM
            store_settlements
        WHERE
            store_id = #{storeId}
        ORDER BY
            clcln_prcs_ymd DESC, store_clcln_id DESC
    </select>


    <insert id="insertStoreSettlement" parameterType="ks55team02.admin.adminpage.storeadmin.settlementdetailbystore.domain.StoreSettlementDTO">
    	/* 새로운 정산 정보 삽입 */
        INSERT INTO store_settlements
        (store_clcln_id, store_id, plcy_id, tot_sel_amt, sel_fee_rt, clcln_amt, actno_id, clcln_prcs_ymd, clcln_stts_cd)
        VALUES
        (#{storeClclnId}, #{storeId}, #{plcyId}, #{totSelAmt}, #{selFeeRt}, #{clclnAmt}, #{actnoId}, #{clclnPrcsYmd}, #{clclnSttsCd})
    </insert>


    <select id="getNextStoreClclnId" resultType="string">
    	/* 다음 정산 ID 조회 (예: 'clcln_00001' 형식) */
        SELECT
            CASE
                WHEN COUNT(store_clcln_id) = 0 THEN 'clcln_00001'
                ELSE CONCAT('clcln_', LPAD(CAST(SUBSTRING(MAX(store_clcln_id), 7) AS UNSIGNED) + 1, 5, '0'))
            END
        FROM
            store_settlements
        WHERE
            store_clcln_id LIKE 'clcln_%'
    </select>


    <update id="updateSettlementStatus">
    	/* 특정 정산 ID의 상태 업데이트 */
        UPDATE store_settlements
        SET
            clcln_stts_cd = #{clclnSttsCd}
        WHERE
            store_clcln_id = #{storeClclnId}
    </update>
  
  </mapper>