<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper
	namespace="ks55team02.admin.adminpage.useradmin.search.mapper.AdminSearchMapper">

	<!-- ======================================================= -->
	<!-- 1. 로그 보기(Log View) 관련 쿼리 -->
	<!-- ======================================================= -->

	<!-- ✅ [리팩토링 1] 로그 조회용 공통 WHERE 조건을 분리하여 코드 중복을 제거합니다. -->
	<sql id="logWhereCondition">
		<where>
			<!-- ✅ [단순화 1] 복잡한 choose문 삭제! 오직 searchValue로 키워드만 검색합니다. -->
			<if test="searchValue != null and searchValue != ''">
				AND srch_keyword_nm LIKE CONCAT('%', #{searchValue}, '%')
			</if>
			<if test="searchStartDate != null and searchStartDate != ''">
				<!-- ✅ [오류 수정] CDATA를 적용하여 XML 파싱 오류를 방지합니다. -->
				<![CDATA[
					AND srch_dt >= STR_TO_DATE(#{searchStartDate}, '%Y-%m-%d')
				]]>
			</if>
			<if test="searchEndDate != null and searchEndDate != ''">
				<![CDATA[
					AND srch_dt <= STR_TO_DATE(CONCAT(#{searchEndDate}, ' 23:59:59'), '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
		</where>
	</sql>

	<!-- '로그 보기' 목록 조회 쿼리 -->
	<select id="getSearchLogList" parameterType="map"
		resultType="ks55team02.admin.adminpage.useradmin.search.domain.AdminSearchLog">
		SELECT
		<!-- ✅ [핵심 수정] 모든 컬럼에 DTO 필드명과 동일한 별칭(Alias)을 부여합니다. -->
		srch_log_id AS srchLogId,
		user_no AS userNo,
		srch_keyword_nm AS srchKeywordNm,
		srch_dt AS srchDt,
		srch_user_ip_addr AS srchUserIpAddr
		FROM
		search_logs
		<include refid="logWhereCondition" />
		ORDER BY
		srchLogId ASC
		LIMIT #{start}, #{size}
	</select>

	<!-- '로그 보기' 목록 개수 조회 쿼리 -->
	<select id="getSearchLogListCount" parameterType="map"
		resultType="int">
		SELECT COUNT(*)
		FROM search_logs
		<include refid="logWhereCondition" />
	</select>


	<!-- ======================================================= -->
	<!-- 2. 통계 보기(Stats View) 관련 쿼리 -->
	<!-- ======================================================= -->

	<!-- ✅ [리팩토링 2] 통계 조회용 공통 WHERE/HAVING 조건을 분리합니다. -->
	<sql id="statsFilterCondition">
		<where>
			<if test="searchStartDate != null and searchStartDate != ''">
				<![CDATA[
					AND srch_dt >= STR_TO_DATE(#{searchStartDate}, '%Y-%m-%d')
				]]>
			</if>
			<if test="searchEndDate != null and searchEndDate != ''">
				<![CDATA[
					AND srch_dt <= STR_TO_DATE(CONCAT(#{searchEndDate}, ' 23:59:59'), '%Y-%m-%d %H:%i:%s')
				]]>
			</if>
		</where>
		GROUP BY
		srch_keyword_nm
		<!-- ✅ [기능 추가] 통계 결과에 대해 키워드(searchValue)로 검색하는 기능을 추가합니다. -->
		<if test="searchValue != null and searchValue != ''">
			HAVING srch_keyword_nm LIKE CONCAT('%', #{searchValue},
			'%')
		</if>
	</sql>

	<!-- AdminSearchMapper.xml 파일에서 이 부분만 수정해주세요 -->

	<!-- '통계 보기' 목록 조회 쿼리 -->
	<select id="getSearchStats" parameterType="map"
		resultType="ks55team02.admin.adminpage.useradmin.search.domain.AdminSearchStats">
		SELECT
		<!-- ✅ [핵심 수정] DB 컬럼명에 DTO 필드명과 동일한 별칭(Alias)을 부여합니다. -->
		srch_keyword_nm AS srchKeywordNm,
		COUNT(*) AS searchCount
		FROM
		search_logs
		<include refid="statsFilterCondition" />
		ORDER BY
		searchCount DESC, srch_keyword_nm ASC
		LIMIT #{start}, #{size}
	</select>

	<!-- '통계 보기' 목록 개수 조회 쿼리 -->
	<select id="getSearchStatsCount" parameterType="map"
		resultType="int">
		SELECT COUNT(*)
		FROM (
		SELECT srch_keyword_nm
		FROM search_logs
		<include refid="statsFilterCondition" />
		) AS stats_count_subquery
	</select>

</mapper>