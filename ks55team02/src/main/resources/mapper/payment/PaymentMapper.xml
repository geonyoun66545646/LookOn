<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="ks55team02.tossapi.mapper.PaymentMapper">

    <resultMap id="UserCouponWithDetailsResultMap" type="ks55team02.customer.coupons.domain.UserCoupons">
        <id     column="uc_user_cpn_id"    property="userCpnId"/>
        <result column="uc_user_no"        property="userNo"/>
        <result column="uc_use_yn"         property="useYn"/>
        <result column="uc_indiv_expry_dt" property="indivExpryDt"/>
        
        <association property="coupon" javaType="ks55team02.customer.coupons.domain.Coupons">
            <id     column="c_pblcn_cpn_id"   property="pblcnCpnId"/>
            <result column="c_cpn_nm"         property="cpnNm"/>
            <result column="c_dscnt_vl"       property="dscntVl"       javaType="double" jdbcType="DECIMAL" typeHandler="org.apache.ibatis.type.DoubleTypeHandler"/>
            <result column="c_min_ordr_amt"   property="minOrdrAmt"    javaType="double" jdbcType="DECIMAL" typeHandler="org.apache.ibatis.type.DoubleTypeHandler"/>
            <result column="c_max_dscnt_amt"  property="maxDscntAmt"   javaType="double" jdbcType="DECIMAL" typeHandler="org.apache.ibatis.type.DoubleTypeHandler"/>
            <result column="c_vld_end_dt"     property="vldEndDt"/>
            <result column="c_actvtn_yn"      property="actvtnYn"/>
        </association>
    </resultMap>

    <resultMap type="ks55team02.tossapi.domain.PaymentDTO" id="paymentResultMap">
        <id     column="stlm_id"        property="stlmId"/>
        <result column="ordr_no"        property="ordrNo"/>
        <result column="user_no"        property="userNo"/>
        <result column="stlm_mthd_cd"   property="stlmMthdCd"/>
        <result column="stlm_amt"       property="stlmAmt"/>
        <result column="stlm_stts_cd"   property="stlmSttsCd"/>
        <result column="pg_dlng_id"     property="pgDlngId"/>
        <result column="pg_co_info"     property="pgCoInfo"/>
        <result column="stlm_cmptn_dt"  property="stlmCmptnDt"/>
        <result column="stlm_dmnd_dt"   property="stlmDmndDt"/>
    </resultMap>
    
    <resultMap type="ks55team02.tossapi.domain.PayOrderDTO" id="payorderResultMap">
        <id     column="ordr_no"        	property="ordrNo"/>
        <result column="user_no"        	property="userNo"/>
        <result column="ordr_dt"        	property="ordrDt"/>
        <result column="gds_tot_amt"    	property="gdsTotAmt"/>
        <result column="dlvy_fee_amt"       property="dlvyFeeAmt"/>
        <result column="pblcn_cpn_id"       property="pblcnCpnId"/>
        <result column="user_cpn_id"       	property="userCpnId"/>
        <result column="apld_cpn_dscnt_amt" property="apldCpnDscntAmt"/>
        <result column="last_stlm_amt"      property="lastStlmAmt"/>
       	<result column="ordr_stts_cd"   	property="ordrSttsCd"/>
        <result column="rcvr_nm"     		property="rcvrNm"/>
        <result column="rcvr_telno"     	property="rcvrTelno"/>
        <result column="dlvy_addr"    		property="dlvyAddr"/>
        <result column="dlvy_daddr"  		property="dlvyDaddr"/>
        <result column="zip"   				property="zip"/>
        <result column="dlvy_memo_cn"   	property="dlvyMemoCn"/>
        <result column="user_name"   		property="userName"/>
    </resultMap>
    
    <resultMap type="ks55team02.tossapi.domain.PayOrderItemsDTO" id="payorderItemsResultMap">
        <id     column="ordr_dtl_artcl_no"  property="ordrDtlArtclNo"/>
        <result column="ordr_no"            property="ordrNo"/>
        <result column="opt_no"             property="optNo"/>
        <result column="gds_no"             property="gdsNo"/>
        <result column="store_id"           property="storeId"/>
        <result column="ordr_qntty"         property="ordrQntty"/>
        <result column="ordr_tm_untprc"     property="ordrTmUntprc"/>
        <result column="ordr_dtl_artcl_dcsn_cd" property="ordrDtlArtclDcsnCd"/>
    </resultMap>

    <select id="selectNextOrderId" resultType="String">
	    SELECT CONCAT('ORD', DATE_FORMAT(CURDATE(), '%Y%m%d'), LPAD(IFNULL(MAX(CAST(SUBSTRING(ordr_no, 12) AS UNSIGNED)), 0) + 1, 3, '0'))
	    FROM toss_order WHERE ordr_no LIKE CONCAT('ORD', DATE_FORMAT(CURDATE(), '%Y%m%d'), '%')
	</select>
    <select id="selectNextOrderItemId" resultType="String">
        SELECT CONCAT('ITEM', DATE_FORMAT(CURDATE(), '%Y%m%d'), LPAD(IFNULL(MAX(CAST(SUBSTRING(ordr_dtl_artcl_no, 13) AS UNSIGNED)), 0) + 1, 3, '0'))
        FROM toss_order_item WHERE ordr_dtl_artcl_no LIKE CONCAT('ITEM', DATE_FORMAT(CURDATE(), '%Y%m%d'), '%')
    </select>
    <select id="selectNextPaymentId" resultType="String">
        SELECT CONCAT('pay_', LPAD(IFNULL(MAX(CAST(SUBSTRING(stlm_id, 5) AS UNSIGNED)), 0) + 1, 5, '0'))
        FROM toss_payment
    </select>
    <select id="selectNextPaymentHistoryId" resultType="String">
        SELECT CONCAT('pay_his_', LPAD(IFNULL(MAX(CAST(SUBSTRING(stlm_hstry_id, 9) AS UNSIGNED)), 0) + 1, 5, '0'))
        FROM toss_payment_history
    </select>

    <insert id="insertOrder" parameterType="ks55team02.tossapi.domain.PayOrderDTO">
        INSERT INTO toss_order (
            ordr_no,
            user_no,
            ordr_name,
            final_amount,
            coupon_id,
            discount_amount,
            recipient_name,
            phone,
            postcode,
            address,
            detail_address,
            delivery_request,
            ordr_status,
            ordr_date
        ) VALUES (
            #{ordrNo},
            #{userNo},
            #{ordrName},
            #{finalAmount},
            #{couponId},
            #{discountAmount},
            #{recipientName},
            #{phone},
            #{postcode},
            #{address},
            #{detailAddress},
            #{deliveryRequest},
            #{ordrStatus},
            NOW()
        )
    </insert>

    <insert id="insertOrderItem" parameterType="map">
        INSERT INTO toss_order_item (
            ordr_no,
            gds_no,
            quantity,
            price,
            store_id,
            reg_date
        ) VALUES (
            #{ordrNo},
            #{gdsNo},
            #{quantity},
            #{price},
            #{storeId},
            NOW()
        )
    </insert>

    <insert id="insertPayment" parameterType="map">
        INSERT INTO toss_payment (
            ordr_no,
            payment_key,
            amount,
            method,
            card_company,
            approved_at,
            pay_date
        ) VALUES (
            #{ordrNo},
            #{paymentKey},
            #{amount},
            #{method},
            #{cardCompany},
            #{approvedAt},
            NOW()
        )
    </insert>

    <update id="updateOrderStatus" parameterType="map">
        UPDATE toss_order
        SET
            ordr_status = #{ordrStatus},
            mod_date = NOW()
        WHERE
            ordr_no = #{ordrNo}
    </update>

    <select id="getOrderByOrdrNo" parameterType="String" resultType="ks55team02.tossapi.domain.PayOrderDTO">
        SELECT
            ordr_no AS ordrNo,
            user_no AS userNo,
            ordr_name AS ordrName,
            final_amount AS finalAmount,
            coupon_id AS couponId,
            discount_amount AS discountAmount,
            recipient_name AS recipientName,
            phone,
            postcode,
            address,
            detail_address AS detailAddress,
            delivery_request AS deliveryRequest,
            ordr_status AS ordrStatus,
            ordr_date AS ordrDate,
            mod_date AS modDate
        FROM
            toss_order
        WHERE
            ordr_no = #{ordrNo}
    </select>
    
    <select id="getOrderedProductsByOrderId" parameterType="String" resultType="map">
        SELECT
            toi.gds_no AS gdsNo,
            tg.gds_nm AS name,
            toi.quantity,
            toi.price
        FROM
            toss_order_item toi
        JOIN
            t_goods tg ON toi.gds_no = tg.gds_no
        WHERE
            toi.ordr_no = #{orderId}
    </select>

    <select id="findLatestOrderIdByUserNo" parameterType="String" resultType="String">
        SELECT ordr_no
        FROM toss_order
        WHERE user_no = #{userNo}
        ORDER BY ordr_date DESC
        LIMIT 1
    </select>

    <select id="getOrderDetailsByOrderId" parameterType="String" resultType="map">
        SELECT
            ordr_no AS orderId,
            ordr_name AS orderName,
            final_amount AS amount,
            recipient_name AS recipientName,
            phone,
            postcode,
            address,
            detail_address AS detailAddress,
            delivery_request AS deliveryRequest,
            ordr_status AS orderStatus,
            ordr_date AS orderDate
        FROM
            toss_order
        WHERE
            ordr_no = #{orderId}
    </select>

    <select id="findUserCouponsByUserId" parameterType="String" resultMap="UserCouponWithDetailsResultMap">
        SELECT
            uc.user_coupon_id AS uc_user_cpn_id,
            uc.user_no AS uc_user_no,
            uc.use_yn AS uc_use_yn,
            uc.indiv_expry_dt AS uc_indiv_expry_dt,
            c.coupon_id AS c_pblcn_cpn_id,
            c.coupon_name AS c_cpn_nm,
            c.discount_type AS c_dscnt_type,
            c.discount_value AS c_dscnt_vl,
            c.min_order_amount AS c_min_ordr_amt,
            c.max_discount_amount AS c_max_dscnt_amt,
            c.valid_end_date AS c_vld_end_dt,
            c.activation_status AS c_actvtn_yn
        FROM
            user_coupons uc
        JOIN
            coupons c ON uc.coupon_id = c.coupon_id
        WHERE
            uc.user_no = #{userNo} AND uc.use_yn = 'N' AND uc.indiv_expry_dt >= NOW()
    </select>

    <select id="selectUserInfoForShipping" parameterType="String" resultType="map">
        SELECT
            user_nm AS recipientName,   telno AS phone,             zip_cd AS postcode,         addr AS address,            daddr AS detailAddress      FROM
            users
        WHERE
            user_no = #{userNo}
    </select>

    <update id="updateUserInfoShippingAddress" parameterType="map">
        UPDATE users
        SET
            user_nm = #{recipientName},     telno = #{phone},
            zip_cd = #{postcode},
            addr = #{address},
            daddr = #{detailAddress},
            last_info_mdfcn_dt = NOW() WHERE
            user_no = #{userNo}
    </update>

</mapper>