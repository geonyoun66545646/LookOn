<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ks55team02.seller.products.mapper.ProductOptionMapper">

    <!-- OptionValue resultMap (optVlNo, vlNm, clrCd 등 필요한 모든 컬럼 추가) -->
    <resultMap id="productOptionValueResultMap" type="ks55team02.seller.products.domain.ProductOptionValue">
        <id property="optVlNo" column="opt_vl_no"/>
        <result property="vlNm" column="vl_nm"/>
        <result property="clrCd" column="clr_cd"/>
        <result property="actvtnYn" column="actvtn_yn"/>
    </resultMap>
    
    <!-- Option과 그에 속한 OptionValue를 담는 resultMap -->
    <resultMap id="optionsWithValuesResultMap" type="ks55team02.seller.products.domain.ProductOption">
        <id property="optNo" column="opt_no"/>
        <result property="optNm" column="opt_nm"/>
        <result property="actvtnYn" column="actvtn_yn"/>
        <collection property="optionValues" ofType="ks55team02.seller.products.domain.ProductOptionValue"
                    resultMap="productOptionValueResultMap"/>
    </resultMap>
    
    <!-- ⭐ 서브쿼리 1: 상품 ID로 전체 옵션/옵션값 목록 조회 (JOIN 추가) ⭐ -->
    <select id="getOptionsByGdsNo" parameterType="string" resultMap="optionsWithValuesResultMap">
        SELECT
            po.opt_no,
            po.opt_nm,
            po.actvtn_yn,
            pov.opt_vl_no,
            pov.vl_nm,
            pov.clr_cd,
            pov.actvtn_yn
        FROM
            product_options po
        LEFT JOIN
            product_option_values pov ON po.opt_no = pov.opt_no
        WHERE
            po.gds_no = #{gdsNo} AND po.actvtn_yn = TRUE;
    </select>

    <!-- 서브쿼리 2: 재고 상태 ID로 매핑된 옵션 값 목록 조회 -->
    <select id="getMappedOptionValuesByStatusNo" parameterType="string" resultMap="productOptionValueResultMap">
        SELECT
            pov.opt_vl_no,
            pov.vl_nm
        FROM
            status_option_mappings som
        INNER JOIN
            product_option_values pov ON som.opt_vl_no = pov.opt_vl_no
        WHERE
            som.gds_stts_no = #{gdsSttsNo}
            AND pov.actvtn_yn = TRUE;
    </select>
    
    <!-- 특정 옵션 유형에 해당하는 모든 옵션 값 조회 -->
    <select id="getAllProductOptionValuesByType" parameterType="String" resultMap="productOptionValueResultMap">
        SELECT
            pov.opt_vl_no           AS opt_vl_no,
            pov.opt_no              AS opt_vl_opt_no,
            pov.creatr_no           AS opt_vl_creatr_no,
            pov.mdfr_no             AS opt_vl_mdfr_no,
            pov.del_user_no         AS opt_vl_del_user_no,
            pov.vl_nm               AS vl_nm,
            pov.opt_vl_img_url_addr AS opt_vl_img_url_addr,
            pov.clr_cd              AS clr_cd,
            pov.reg_dt              AS opt_vl_reg_dt,
            pov.mdfcn_dt            AS opt_vl_mdfcn_dt,
            pov.inactvtn_dt         AS opt_vl_inactvtn_dt,
            pov.actvtn_yn           AS opt_vl_actvtn_yn
        FROM
            ks55team02db.product_option_values pov
        JOIN
            ks55team02db.product_options po ON pov.opt_no = po.opt_no
        WHERE
            po.opt_nm = #{optionTypeName} 
            AND pov.actvtn_yn = TRUE 
            AND po.actvtn_yn = TRUE
        ORDER BY
            pov.vl_nm;
    </select>

    <!-- 특정 옵션 유형에 해당하는 옵션 값 이름(vl_nm) 중복 없이 조회 -->
    <select id="getDistinctProductOptionValueNamesByType" parameterType="String" resultType="String">
        SELECT DISTINCT
            pov.vl_nm
        FROM
            ks55team02db.product_option_values pov
        JOIN
            ks55team02db.product_options po ON pov.opt_no = po.opt_no
        WHERE
            po.opt_nm = #{optionTypeName} 
            AND pov.actvtn_yn = TRUE 
            AND po.actvtn_yn = TRUE
        ORDER BY
            pov.vl_nm;
    </select>
    
</mapper>