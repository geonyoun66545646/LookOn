<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ks55team02.seller.products.mapper.ProductsMapper">

	<!-- ================== ResultMaps ================== -->
	
	<!-- 상품 옵션 ResultMap: 상품 상세 조회 시 사용 -->
	<resultMap id="productOptionResultMap" type="ks55team02.seller.products.domain.ProductOption">
		<id property="optNo" column="opt_no" />
		<result property="gdsNo" column="opt_gds_no" />
		<result property="creatrNo" column="opt_creatr_no" />
		<result property="mdfrNo" column="opt_mdfr_no" />
		<result property="delUserNo" column="opt_del_user_no" />
		<result property="optNm" column="opt_nm" />
		<result property="snglMtplChcSeCd" column="sngl_mltpl_chc_se_cd" />
		<result property="optIndctSn" column="opt_indct_sn" />
		<result property="regDt" column="opt_reg_dt" />
		<result property="mdfcnDt" column="opt_mdfcn_dt" />
		<result property="inactvtnDt" column="opt_inactvtn_dt" />
		<result property="actvtnYn" column="opt_actvtn_yn" />
		<collection property="optionValues"
			ofType="ks55team02.seller.products.domain.ProductOptionValue"
			javaType="java.util.ArrayList"
			column="opt_no"
			resultMap="ks55team02.seller.products.mapper.ProductOptionMapper.productOptionValueResultMap">
		</collection>
	</resultMap>
	
	<!-- 상품 상세 정보 ResultMap (이미지, 옵션 포함) -->
	<resultMap id="productDetailWithImagesResultMap" type="ks55team02.seller.products.domain.Products">
		<id column="p_gds_no" property="gdsNo" />
		<result column="p_store_id" property="storeId" />
		<result column="p_ctgry_no" property="ctgryNo" />
		<result column="p_sel_user_no" property="selUserNo" />
		<result column="p_mdfr_no" property="mdfrNo" />
		<result column="p_del_user_no" property="delUserNo" />
		<result column="p_gds_nm" property="gdsNm" />
		<result column="p_gds_expln" property="gdsExpln" />
		<result column="p_bas_prc" property="basPrc" jdbcType="DECIMAL"/>
		<result column="p_dscnt_rt" property="dscntRt" />
		<result column="p_last_sel_prc" property="lastSelPrc" jdbcType="DECIMAL"/>
		<result column="p_reg_dt" property="regDt" />
		<result column="p_mdfcn_dt" property="mdfcnDt" />
		<result column="p_inactvtn_dt" property="inactvtnDt" />
		<result column="p_expsr_yn" property="expsrYn" />
		<result column="p_actvtn_yn" property="actvtnYn" />
		<result column="p_min_purchase_qty" property="minPurchaseQty" />
		<result column="p_max_purchase_qty" property="maxPurchaseQty" />
        <association property="productCategory" javaType="ks55team02.seller.products.domain.ProductCategory">
			<id property="categoryId" column="pc_ctgry_no" />
			<result property="parentCategoryId" column="pc_up_ctgry_no" />
			<result property="categoryName" column="pc_ctgry_nm" />
			<result property="categoryLevel" column="pc_ctgry_dpth" />
		</association>
		<collection property="productImages"
			ofType="ks55team02.seller.products.domain.ProductImage"
			resultMap="ks55team02.seller.products.mapper.ProductImageMapper.productImageResultMap" />
		<collection property="productOptions"
			ofType="ks55team02.seller.products.domain.ProductOption"
			javaType="java.util.ArrayList"
			column="p_gds_no"
			resultMap="productOptionResultMap">
		</collection>
	</resultMap>
	
	<!-- 판매자별 상품 목록 ResultMap -->
	<resultMap id="productsResultMap" type="ks55team02.seller.products.domain.Products">
		<id column="gds_no" property="gdsNo" />
		<result column="store_id" property="storeId" />
		<result column="ctgry_no" property="ctgryNo" />
		<result column="gds_nm" property="gdsNm" />
		<result column="bas_prc" property="basPrc" jdbcType="DECIMAL" />
		<result column="dscnt_rt" property="dscntRt" />
		<result column="last_sel_prc" property="lastSelPrc" jdbcType="DECIMAL" />
		<result column="reg_dt" property="regDt" />
		<result column="expsr_yn" property="expsrYn" />
		<result column="actvtn_yn" property="actvtnYn" />
		<result column="thumbnail_image_path" property="thumbnailImagePath" />
		<association property="productCategory" javaType="ks55team02.seller.products.domain.ProductCategory">
			<id property="categoryId" column="ctgry_no" />
			<result property="categoryName" column="ctgry_nm" />
		</association>
	</resultMap>
	

	<!-- ===================== 상품 등록(Create) 관련 쿼리 ===================== -->
	
	<!-- 새 상품 코드(gds_no) 생성 -->
	<select id="getMaxProductCode" resultType="string">
		SELECT
			CASE
				WHEN COUNT(p.gds_no) = 0 THEN 'gds_no_1'
				ELSE CONCAT('gds_no_', COALESCE(MAX(CAST(SUBSTRING_INDEX(p.gds_no, '_', -1) AS UNSIGNED)), 0) + 1)
			END
		FROM
			ks55team02db.products p
	</select>
	
	<!-- 상품 기본 정보 삽입 -->
	<insert id="addProduct" parameterType="ks55team02.seller.products.domain.Products">
		INSERT INTO ks55team02db.products
			(gds_no, store_id, ctgry_no, sel_user_no, mdfr_no, 
			 del_user_no, gds_nm, gds_expln, bas_prc, dscnt_rt, 
			 last_sel_prc, reg_dt, expsr_yn, actvtn_yn, min_purchase_qty, max_purchase_qty)
		VALUES
			(#{gdsNo}, #{storeId}, #{ctgryNo}, #{selUserNo}, #{mdfrNo},
			 #{delUserNo}, #{gdsNm}, #{gdsExpln}, #{basPrc}, #{dscntRt},
			 #{lastSelPrc}, CURRENT_TIMESTAMP, #{expsrYn}, #{actvtnYn}, #{minPurchaseQty}, #{maxPurchaseQty})
	</insert>
	
	<!-- 새 이미지 코드(img_no) 생성 (상품 등록용) -->
	<select id="getMaxImageNo" resultType="string">
		SELECT
			CASE
				WHEN COUNT(pi.img_no) = 0 THEN 'img_no_1'
				ELSE CONCAT('img_no_', COALESCE(MAX(CAST(SUBSTRING_INDEX(pi.img_no, '_', -1) AS UNSIGNED)), 0) + 1)
			END
		FROM
			ks55team02db.product_images pi
	</select>

	<!-- 상품 이미지 정보 삽입 (상품 등록용) -->
	<insert id="insertProductImage" parameterType="ks55team02.seller.products.domain.ProductImage">
		INSERT INTO ks55team02db.product_images
			(img_no, gds_no, creatr_no, mdfr_no, img_file_path_nm, 
			 video_url, img_indct_sn, reg_dt, img_type, actvtn_yn)
		VALUES
			(#{imgNo}, #{gdsNo}, #{creatrNo}, #{mdfrNo}, #{imgFilePathNm},
			 #{videoUrl}, #{imgIndctSn}, CURRENT_TIMESTAMP, 
			 #{imgType, typeHandler=ks55team02.seller.products.handler.ProductImageTypeHandler}, #{actvtnYn})
	</insert>
	
	<!-- 새 옵션 코드(opt_no) 생성 (상품 등록용) -->
	<select id="getMaxOptionNo" resultType="string">
		SELECT
			CASE
				WHEN COUNT(po.opt_no) = 0 THEN 'opt_no_1'
				ELSE CONCAT('opt_no_', COALESCE(MAX(CAST(SUBSTRING_INDEX(po.opt_no, '_', -1) AS UNSIGNED)), 0) + 1)
			END
		FROM
			ks55team02db.product_options po
	</select>

	<!-- 상품 옵션 정보 삽입 (상품 등록용) -->
	<insert id="insertProductOption" parameterType="ks55team02.seller.products.domain.ProductOption">
		INSERT INTO ks55team02db.product_options
			(opt_no, gds_no, creatr_no, opt_nm, sngl_mltpl_chc_se_cd, opt_indct_sn, actvtn_yn)
		VALUES
			(#{optNo}, #{gdsNo}, #{creatrNo}, #{optNm}, #{snglMtplChcSeCd}, #{optIndctSn}, #{actvtnYn})
	</insert>

	<!-- 새 옵션 값 코드(opt_vl_no) 생성 (상품 등록용) -->
	<select id="getMaxOptionValueNo" resultType="string">
		SELECT
			CASE
				WHEN COUNT(pov.opt_vl_no) = 0 THEN 'opt_vl_no_1'
				ELSE CONCAT('opt_vl_no_', COALESCE(MAX(CAST(SUBSTRING_INDEX(pov.opt_vl_no, '_', -1) AS UNSIGNED)), 0) + 1)
			END
		FROM
			ks55team02db.product_option_values pov
	</select>

	<!-- 상품 옵션 값 정보 삽입 (상품 등록용) -->
	<insert id="insertProductOptionValue" parameterType="ks55team02.seller.products.domain.ProductOptionValue">
		INSERT INTO ks55team02db.product_option_values
			(opt_vl_no, opt_no, creatr_no, vl_nm, actvtn_yn)
		VALUES
			(#{optVlNo}, #{optNo}, #{creatrNo}, #{vlNm}, #{actvtnYn})
	</insert>
	
	<!-- 새 상품 상태 코드(gds_stts_no) 생성 (상품 등록용) -->
	<select id="getMaxStatusNo" resultType="string">
		SELECT
			CASE
				WHEN COUNT(ps.gds_stts_no) = 0 THEN 'gds_stts_no_1'
				ELSE CONCAT('gds_stts_no_', COALESCE(MAX(CAST(SUBSTRING_INDEX(ps.gds_stts_no, '_', -1) AS UNSIGNED)), 0) + 1)
			END
		FROM
			ks55team02db.product_status ps
	</select>

	<!-- 상품 상태 정보 삽입 (상품 등록용) -->
	<insert id="insertProductStatus" parameterType="ks55team02.seller.products.domain.ProductStatus">
		INSERT INTO ks55team02db.product_status
			(gds_stts_no, gds_no, creatr_no, sel_psblty_qntty, sldout_yn, actvtn_yn)
		VALUES
			(#{gdsSttsNo}, #{gdsNo}, #{creatrNo}, #{selPsbltyQntty}, #{sldoutYn}, #{actvtnYn})
	</insert>

	<!-- 상태-옵션 매핑 정보 삽입 (상품 등록용) -->
	<insert id="insertStatusOptionMapping" parameterType="ks55team02.seller.products.domain.StatusOptionMapping">
		INSERT INTO ks55team02db.status_option_mappings
			(gds_stts_no, opt_vl_no, creatr_no, actvtn_yn)
		VALUES
			(#{gdsSttsNo}, #{optVlNo}, #{creatrNo}, #{actvtnYn})
	</insert>
	
	
	<!-- ===================== 상품 조회(Read) 관련 쿼리 ===================== -->

	<!-- 판매자/스토어별 상품 목록 조회 -->
	<select id="getProductsBySellerAndStore" parameterType="map" resultMap="productsResultMap">
		SELECT
			p.gds_no, p.store_id, p.ctgry_no, p.gds_nm, p.bas_prc, p.dscnt_rt,
			(p.bas_prc * (100 - IFNULL(p.dscnt_rt, 0.00)) / 100) AS last_sel_prc,
			p.reg_dt, p.expsr_yn, p.actvtn_yn, pc.ctgry_nm,
			(
				SELECT pi.img_file_path_nm
				FROM ks55team02db.product_images pi
				WHERE pi.gds_no = p.gds_no AND pi.img_type = 1
				ORDER BY pi.img_indct_sn ASC
				LIMIT 1
			) AS thumbnail_image_path
		FROM
			ks55team02db.products p
		LEFT JOIN
			ks55team02db.product_categories pc ON p.ctgry_no = pc.ctgry_no
		WHERE
			p.sel_user_no = #{selUserNo}
			AND p.store_id = #{storeId}
		ORDER BY
			p.reg_dt DESC
	</select>

	<!-- (관리자용) 모든 상품 목록 조회 -->
	<select id="getProductList" resultMap="productsResultMap">
		SELECT
			p.gds_no, p.store_id, p.ctgry_no, p.gds_nm, p.bas_prc, p.dscnt_rt,
			(p.bas_prc * (100 - IFNULL(p.dscnt_rt, 0.00)) / 100) AS last_sel_prc,
			p.reg_dt, p.expsr_yn, p.actvtn_yn, pc.ctgry_nm,
			(
				SELECT pi.img_file_path_nm
				FROM ks55team02db.product_images pi
				WHERE pi.gds_no = p.gds_no AND pi.img_type = 1
				ORDER BY pi.img_indct_sn ASC
				LIMIT 1
			) AS thumbnail_image_path
		FROM
			ks55team02db.products p
		LEFT JOIN
			ks55team02db.product_categories pc ON p.ctgry_no = pc.ctgry_no
		ORDER BY
			p.reg_dt DESC
	</select>
	
	<!-- 상품 상세 정보 조회 (이미지, 옵션, 카테고리 포함) -->
	<select id="getProductDetailWithImages" parameterType="String" resultMap="productDetailWithImagesResultMap">
		SELECT
			p.gds_no AS p_gds_no, p.store_id AS p_store_id, p.ctgry_no AS p_ctgry_no,
			p.sel_user_no AS p_sel_user_no, p.mdfr_no AS p_mdfr_no, p.del_user_no AS p_del_user_no,
			p.gds_nm AS p_gds_nm, p.gds_expln AS p_gds_expln, p.bas_prc AS p_bas_prc,
			IFNULL(p.dscnt_rt, 0.00) AS p_dscnt_rt,
			(p.bas_prc * (100 - IFNULL(p.dscnt_rt, 0.00)) / 100) AS p_last_sel_prc,
			p.reg_dt AS p_reg_dt, p.mdfcn_dt AS p_mdfcn_dt, p.inactvtn_dt AS p_inactvtn_dt,
			p.expsr_yn AS p_expsr_yn, p.actvtn_yn AS p_actvtn_yn,
			p.min_purchase_qty AS p_min_purchase_qty, p.max_purchase_qty AS p_max_purchase_qty,
			
			pc.ctgry_no AS pc_ctgry_no, pc.up_ctgry_no AS pc_up_ctgry_no, pc.ctgry_nm AS pc_ctgry_nm, pc.ctgry_dpth AS pc_ctgry_dpth,

			pi.img_no, pi.gds_no, pi.creatr_no, pi.mdfr_no, pi.img_file_path_nm,
			pi.video_url, pi.img_indct_sn, pi.reg_dt AS img_reg_dt, pi.img_type, pi.actvtn_yn AS img_actvtn_yn,
			
			po.opt_no, po.gds_no AS opt_gds_no, po.creatr_no AS opt_creatr_no, po.opt_nm,
			po.sngl_mltpl_chc_se_cd, po.opt_indct_sn, po.reg_dt AS opt_reg_dt, po.actvtn_yn AS opt_actvtn_yn,

			pov.opt_vl_no, pov.opt_no AS opt_vl_opt_no, pov.creatr_no AS opt_vl_creatr_no, pov.vl_nm,
			pov.opt_vl_img_url_addr, pov.clr_cd, pov.reg_dt AS opt_vl_reg_dt, pov.actvtn_yn AS opt_vl_actvtn_yn
		FROM
			ks55team02db.products p
		LEFT JOIN
			ks55team02db.product_categories pc ON p.ctgry_no = pc.ctgry_no
		LEFT JOIN
			ks55team02db.product_images pi ON p.gds_no = pi.gds_no AND pi.actvtn_yn = TRUE
		LEFT JOIN
			ks55team02db.product_options po ON p.gds_no = po.gds_no AND po.actvtn_yn = TRUE
		LEFT JOIN
			ks55team02db.product_option_values pov ON po.opt_no = pov.opt_no AND pov.actvtn_yn = TRUE
		WHERE
			p.gds_no = #{gdsNo}
		ORDER BY
			po.opt_indct_sn ASC, pov.reg_dt ASC, pi.img_indct_sn ASC
	</select>
	
	
	<!-- ===================== 유틸리티 쿼리 ===================== -->
	
	<!-- 상품 코드 중복 확인 -->
	<select id="countProductCode" parameterType="string" resultType="int">
		SELECT
			COUNT(*)
		FROM
			ks55team02db.products
		WHERE
			gds_no = #{gdsNo}
	</select>

</mapper>